<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××¦×‘ ×¤×©×•×˜ - ××‘×—× ×™ × ×”×™×’×”</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #1a1a2e;
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            direction: rtl;
        }

        /* Header with steps */
        .steps-header {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .step-indicator {
            padding: 10px 20px;
            background: #333;
            color: #888;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .step-indicator.active {
            background: #4CAF50;
            color: white;
        }
        .step-indicator.completed {
            background: #2e7d32;
            color: white;
        }

        /* Main container */
        .main-container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Section styling */
        .section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .section.active {
            display: block;
        }
        .section-title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: #1a1a2e;
        }

        /* Form inputs */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: #4CAF50;
            outline: none;
        }

        /* Planning table */
        .planning-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }
        .planning-table th, .planning-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .planning-table th {
            background: #4CAF50;
            color: white;
        }
        .planning-table input {
            width: 100%;
            border: none;
            text-align: center;
            font-size: 14px;
            padding: 5px;
        }
        .table-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .btn-table-action {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        .btn-add-row { background: #4CAF50; color: white; }
        .btn-remove-row { background: #f44336; color: white; }

        /* Big navigation button */
        .btn-big {
            display: block;
            width: 100%;
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-big:active {
            transform: scale(0.98);
        }
        .btn-next {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        .btn-back {
            background: #666;
            color: white;
            margin-top: 10px;
        }

        /* Examinee card */
        .examinee-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            margin-bottom: 20px;
        }
        .examinee-number {
            text-align: center;
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .examinee-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .examinee-form .form-group {
            margin-bottom: 0;
        }
        .examinee-form label {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }
        .examinee-form input, .examinee-form select {
            background: rgba(255,255,255,0.95);
            border: none;
        }
        .examinee-form .full-width {
            grid-column: span 2;
        }

        /* Result buttons */
        .result-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        .btn-result {
            flex: 1;
            padding: 25px;
            font-size: 24px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .btn-result:active {
            transform: scale(0.95);
        }
        .btn-pass {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        .btn-fail {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
        }
        .btn-result-icon {
            font-size: 40px;
        }

        /* Navigation arrows */
        .nav-arrows {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        .btn-arrow {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: #333;
            color: white;
        }
        .btn-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Progress dots */
        .progress-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }
        .dot.current {
            background: #667eea;
            transform: scale(1.3);
        }
        .dot.passed {
            background: #4CAF50;
        }
        .dot.failed {
            background: #f44336;
        }
        .dot.failed-no-form {
            background: #f44336;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(244, 67, 54, 0); }
        }

        /* Failure form */
        .failure-form-container {
            display: none;
            margin-top: 20px;
            background: #fff5f5;
            border: 3px solid #f44336;
            border-radius: 15px;
            padding: 20px;
        }
        .failure-form-container.active {
            display: block;
        }
        .failure-form-title {
            text-align: center;
            color: #d32f2f;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        /* Failure categories */
        .failure-category {
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        .category-header {
            background: #333;
            color: white;
            padding: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-header:hover {
            background: #444;
        }
        .category-content {
            display: none;
            padding: 10px;
            background: #fafafa;
        }
        .category-content.open {
            display: block;
        }

        /* Failure items */
        .failure-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            gap: 10px;
            flex-wrap: wrap;
        }
        .failure-item:last-child {
            border-bottom: none;
        }
        .failure-item-text {
            flex: 1;
            font-size: 14px;
            min-width: 100px;
        }
        .failure-item-buttons {
            display: flex;
            gap: 5px;
        }
        .failure-item .reasons-dropdown {
            flex-basis: 100%;
            width: 100%;
        }
        .btn-mark {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            touch-action: manipulation;
        }
        .btn-mark:hover, .btn-mark:active {
            transform: scale(1.1);
        }
        .btn-mark.selected-v {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        .btn-mark.selected-x {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }
        .btn-mark.selected-ox {
            background: #ff9800;
            color: white;
            border-color: #ff9800;
        }

        /* Reasons dropdown */
        .reasons-dropdown {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border: 2px solid #ffcccc;
            border-radius: 8px;
        }
        .reasons-dropdown.open {
            display: block;
        }
        .reason-chip {
            display: inline-block;
            padding: 10px 14px;
            margin: 4px;
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            touch-action: manipulation;
        }
        .reason-chip:hover, .reason-chip:active {
            background: #ffcdd2;
        }
        .reason-chip.selected {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }

        /* ×©×™×¤×•×¨×™× ×œ××•×‘×™×™×œ - ×˜×•×¤×¡ ×›×™×©×œ×•×Ÿ */
        @media (max-width: 600px) {
            .reason-chip {
                padding: 12px 16px;
                font-size: 14px;
                margin: 5px;
            }
            .btn-mark {
                min-width: 44px;
                min-height: 44px;
                font-size: 18px;
            }
            .failure-item {
                padding: 10px;
            }
            .failure-item-text {
                font-size: 14px;
            }
            .reasons-dropdown {
                padding: 12px;
            }
        }

        /* Notes area */
        .notes-section {
            margin-top: 20px;
        }
        .notes-area {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
        }

        /* Signature */
        .signature-section {
            margin-top: 20px;
            text-align: center;
        }
        .signature-section canvas {
            border: 2px dashed #999;
            border-radius: 8px;
            background: white;
            cursor: crosshair;
        }
        .btn-clear-sig {
            margin-top: 10px;
            padding: 8px 20px;
            background: #666;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-save-failure {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            margin-top: 20px;
        }

        /* Summary section */
        .summary-list {
            list-style: none;
            padding: 0;
        }
        .summary-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: #f5f5f5;
            gap: 15px;
        }
        .summary-item.passed {
            background: #e8f5e9;
            border-right: 5px solid #4CAF50;
        }
        .summary-item.failed {
            background: #ffebee;
            border-right: 5px solid #f44336;
        }
        .summary-item.failed-no-form {
            background: #fff3e0;
            border-right: 5px solid #ff9800;
            animation: pulse-bg 2s infinite;
        }
        @keyframes pulse-bg {
            0%, 100% { background: #fff3e0; }
            50% { background: #ffe0b2; }
        }
        .summary-status {
            font-size: 30px;
        }
        .summary-details {
            flex: 1;
        }
        .summary-name {
            font-weight: bold;
            font-size: 18px;
        }
        .summary-info {
            color: #666;
            font-size: 14px;
        }
        .summary-warning {
            color: #ff9800;
            font-weight: bold;
            font-size: 12px;
        }
        .btn-edit-failure {
            padding: 10px 15px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Stats box */
        .stats-box {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: #f5f5f5;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        .stat-item.total { background: #e3f2fd; }
        .stat-item.total .stat-number { color: #1976d2; }
        .stat-item.passed { background: #e8f5e9; }
        .stat-item.passed .stat-number { color: #4CAF50; }
        .stat-item.failed { background: #ffebee; }
        .stat-item.failed .stat-number { color: #f44336; }

        /* Action buttons in summary */
        .summary-actions {
            display: grid;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-action {
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-whatsapp { background: #25D366; color: white; }
        .btn-print { background: #2196F3; color: white; }
        .btn-reset { background: #f44336; color: white; }

        /* Modal ×—×œ×•×§×ª ×¢×‘×•×“×” */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; border-radius: 10px; padding: 20px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; direction: rtl; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #9c27b0; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h2 { margin: 0; color: #9c27b0; font-size: 18px; }
        .modal-close { background: #dc3545; color: white; border: none; font-size: 20px; cursor: pointer; border-radius: 50%; width: 30px; height: 30px; }
        .distribute-section { margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px; }
        .distribute-section h3 { margin: 0 0 10px 0; font-size: 14px; color: #333; }
        .distribute-checkbox { display: flex; align-items: center; gap: 8px; margin: 5px 0; }
        .distribute-checkbox input[type="checkbox"] { width: 18px; height: 18px; }
        .distribute-result { background: #e8f5e9; border: 2px solid #4caf50; border-radius: 5px; padding: 15px; margin-top: 15px; }
        .distribute-result h3 { color: #2e7d32; margin: 0 0 10px 0; }
        .tester-assignment { background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin-bottom: 10px; }
        .tester-assignment h4 { margin: 0 0 8px 0; color: #9c27b0; display: flex; justify-content: space-between; }
        .tester-assignment .total { background: #9c27b0; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .tester-assignment ul { margin: 0; padding-right: 20px; }
        .tester-assignment li { margin: 3px 0; }
        .btn-send-assignment { background: #25D366; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-top: 5px; }

        /* WhatsApp buttons container */
        #whatsappButtonsContainer {
            margin-top: 20px;
        }
        #whatsappButtonsContainer .btn-action {
            width: 100%;
            text-align: right;
            padding-right: 20px;
        }

        /* Mobile adjustments */
        @media (max-width: 500px) {
            .examinee-form {
                grid-template-columns: 1fr;
            }
            .examinee-form .full-width {
                grid-column: span 1;
            }
            .result-buttons {
                flex-direction: column;
            }
            .btn-result {
                padding: 20px;
            }
            .stats-box {
                grid-template-columns: 1fr;
            }
        }

        /* Printable Report Styles */
        .printable-report {
            display: none;
            background: white;
            padding: 15mm;
            font-family: 'Segoe UI', Arial, sans-serif;
            direction: rtl;
        }
        .report-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        .report-title {
            font-size: 24px;
            margin: 0;
            white-space: pre-wrap;
            word-spacing: normal;
        }
        .report-subtitle {
            font-size: 16px;
            margin-top: 5px;
            font-weight: bold;
            white-space: pre-wrap;
            word-spacing: normal;
        }
        .report-section {
            margin-bottom: 20px;
        }
        .report-section-title {
            font-size: 14px;
            font-weight: bold;
            border-bottom: 1px solid #000;
            padding-bottom: 3px;
            margin-bottom: 10px;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .report-table th, .report-table td {
            border: 1px solid #000;
            padding: 5px;
            text-align: center;
        }
        .report-table th {
            background: #e7e6e6;
            font-weight: bold;
        }
        .report-table .result-pass {
            background: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        .report-table .result-fail {
            background: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }
        .report-table .editable-cell {
            background: #fffde7;
            cursor: text;
            min-width: 25px;
        }
        .report-table .editable-cell:hover {
            background: #fff9c4;
        }
        .report-table .editable-cell:focus {
            background: #fff59d;
            outline: 2px solid #fbc02d;
        }
        .report-table .pass-cell {
            background: #e8f5e9;
        }
        .report-table .pass-cell:hover {
            background: #c8e6c9;
        }
        .report-table .pass-cell:focus {
            background: #a5d6a7;
            outline: 2px solid #4caf50;
        }
        .report-table .fail-cell {
            background: #ffebee;
        }
        .report-table .fail-cell:hover {
            background: #ffcdd2;
        }
        .report-table .fail-cell:focus {
            background: #ef9a9a;
            outline: 2px solid #f44336;
        }
        .report-summary-table {
            margin-top: 10px;
        }
        .report-summary-table td {
            font-weight: bold;
            font-size: 14px;
        }
        .report-notes-box {
            border: 1px solid #000;
            padding: 10px;
            min-height: 50px;
        }
        .report-notes-textarea {
            width: 100%;
            min-height: 60px;
            border: 1px dashed #999;
            padding: 8px;
            font-family: inherit;
            font-size: 13px;
            resize: vertical;
            margin-top: 5px;
        }
        .report-notes-display {
            display: none;
            white-space: pre-wrap;
            margin-top: 5px;
        }
        .report-signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        .report-sig-box {
            width: 45%;
            text-align: center;
        }
        .report-tester-details {
            font-weight: bold;
            font-size: 12px;
            min-height: 40px;
            white-space: pre-line;
        }
        .sig-line {
            border-top: 1px solid #000;
            width: 80%;
            margin: 5px auto;
        }
        #reportSigCanvas {
            border: 1px dashed #999;
        }

        /* Outer printable report container */
        .printable-report-outer {
            display: none;
        }
        .printable-report-outer.active {
            display: block;
            background: white;
            padding: 10mm;
            font-family: 'Segoe UI', Arial, sans-serif;
            direction: rtl;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
            z-index: 9999;
            box-sizing: border-box;
        }
        .printable-report-outer.active > * {
            max-width: 210mm;
            margin-left: auto;
            margin-right: auto;
        }
        .printable-report-outer .report-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        .printable-report-outer .report-title {
            font-size: 24px;
            margin: 0;
        }
        .printable-report-outer .report-subtitle {
            font-size: 16px;
            margin-top: 5px;
            font-weight: bold;
        }
        .printable-report-outer .report-section {
            margin-bottom: 20px;
        }
        .printable-report-outer .report-section-title {
            font-size: 14px;
            font-weight: bold;
            border-bottom: 1px solid #000;
            padding-bottom: 3px;
            margin-bottom: 10px;
        }
        .printable-report-outer .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .printable-report-outer .report-table th,
        .printable-report-outer .report-table td {
            border: 1px solid #000;
            padding: 5px;
            text-align: center;
        }
        .printable-report-outer .report-table th {
            background: #e7e6e6;
            font-weight: bold;
        }
        .printable-report-outer .result-pass {
            background: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        .printable-report-outer .result-fail {
            background: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }
        .printable-report-outer .report-notes-box {
            border: 1px solid #000;
            padding: 10px;
            min-height: 50px;
        }
        .printable-report-outer .report-notes-textarea {
            display: none;
        }
        .printable-report-outer .report-notes-display {
            white-space: pre-wrap;
        }
        .printable-report-outer .report-signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        .printable-report-outer .report-sig-box {
            width: 45%;
            text-align: center;
        }
        .printable-report-outer .report-tester-details {
            font-weight: bold;
            font-size: 12px;
            min-height: 40px;
            white-space: pre-line;
        }
        .printable-report-outer .sig-line {
            border-top: 1px solid #000;
            width: 80%;
            margin: 5px auto;
        }
        .printable-report-outer .btn-clear-report-sig {
            display: none;
        }

        /* Print styles */
        @media print {
            @page {
                size: A4;
                margin: 10mm;
            }
            body {
                background: white;
                padding: 0;
                margin: 0;
                width: 100%;
            }
            .steps-header, .btn-big, .nav-arrows, .btn-arrow, .progress-dots,
            .result-buttons, .table-actions, .btn-table-action, .summary-actions,
            .btn-edit-failure, .btn-clear-sig, .btn-mark, .main-container,
            #whatsappButtonsContainer { display: none !important; }
            .section { display: none !important; }
            .failure-form-container { display: none !important; }
            .printable-report { display: none !important; }
            .printable-report.preview { display: none !important; }

            .printable-report-outer:not(.active) {
                display: none !important;
            }
            .printable-report-outer.active {
                display: block !important;
                padding: 0;
                width: 100% !important;
                max-width: none !important;
                min-height: auto;
                font-size: 11px;
                position: static !important;
                overflow: visible !important;
                margin: 0 auto;
            }
            .printable-report-outer .report-table {
                font-size: 10px;
                width: 100% !important;
            }
            .printable-report-outer .report-table th,
            .printable-report-outer .report-table td {
                padding: 4px 3px;
            }
            .printable-report-outer .report-section {
                margin-bottom: 10px;
            }
            .printable-report-outer .report-section-title {
                font-size: 13px;
                margin-bottom: 5px;
            }
            .printable-report-outer .report-title {
                font-size: 22px;
            }
            .printable-report-outer .report-subtitle {
                font-size: 13px;
            }
            .printable-report-outer .report-notes-textarea {
                display: none !important;
            }
            .printable-report-outer .report-notes-display {
                display: block !important;
            }
            .printable-report-outer .editable-cell,
            .printable-report-outer .pass-cell,
            .printable-report-outer .fail-cell {
                background: white !important;
            }
        }

        /* Screen preview for report */
        .printable-report.preview {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            overflow: auto;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .report-close-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10001;
            background: #f44336;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .report-print-btn {
            position: fixed;
            top: 10px;
            right: 100px;
            z-index: 10001;
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .report-whatsapp-btn {
            position: fixed;
            top: 10px;
            right: 230px;
            z-index: 10001;
            background: #25D366;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .report-excel-btn {
            position: fixed;
            top: 10px;
            right: 390px;
            z-index: 10001;
            background: #217346;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        /* ×›×¤×ª×•×¨×™ ×“×•"×— ×‘××•×‘×™×™×œ */
        @media (max-width: 600px) {
            .report-close-btn, .report-print-btn, .report-whatsapp-btn, .report-excel-btn {
                position: fixed;
                top: auto;
                padding: 10px 12px;
                font-size: 11px;
            }
            .report-close-btn {
                bottom: 10px;
                right: 10px;
            }
            .report-print-btn {
                bottom: 10px;
                right: auto;
                left: 10px;
            }
            .report-whatsapp-btn {
                bottom: 60px;
                right: 10px;
                left: auto;
                transform: none;
            }
            .report-excel-btn {
                bottom: 60px;
                left: 10px;
                right: auto;
            }
            /* ×“×•"×— ×¨×¡×¤×•× ×¡×™×‘×™ ×œ××•×‘×™×™×œ */
            .printable-report-outer.active {
                padding: 10px;
                padding-bottom: 80px; /* ××§×•× ×œ×›×¤×ª×•×¨×™× ×‘×ª×—×ª×™×ª */
            }
            .printable-report-outer .report-table {
                font-size: 10px;
            }
            .printable-report-outer .report-table th,
            .printable-report-outer .report-table td {
                padding: 3px 2px;
                word-break: break-word;
            }
            .printable-report-outer .report-title {
                font-size: 18px;
            }
            .printable-report-outer .report-section {
                overflow-x: auto;
            }
        }
        @media print {
            .report-close-btn, .report-print-btn, .report-whatsapp-btn, .report-excel-btn, .btn-clear-report-sig { display: none !important; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

<div class="steps-header">
    <div class="step-indicator active" id="step1-ind">1. ×ª×›× ×•×Ÿ</div>
    <div class="step-indicator" id="step2-ind">2. ×‘×—×™× ×•×ª</div>
    <div class="step-indicator" id="step3-ind">3. ×¡×™×›×•×</div>
</div>

<div class="main-container">

    <!-- STEP 1: Planning -->
    <div class="section active" id="section-planning">
        <div class="section-title">ğŸ“‹ ×¡×™×“×•×¨ ×¢×‘×•×“×”</div>

        <div class="form-group">
            <label>×ª××¨×™×š:</label>
            <input type="date" id="planDateInput" onchange="updateDateDisplay()">
            <input type="hidden" id="planDate">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>×™×•×:</label>
                <select id="planDay">
                    <option>×</option><option>×‘</option><option>×’</option><option>×“</option><option>×”</option><option>×•</option>
                </select>
            </div>
            <div class="form-group">
                <label>××–×•×¨:</label>
                <select id="planArea"></select>
            </div>
        </div>

        <div class="form-group">
            <label>×‘×•×—× ×™×:</label>
            <div id="testersCheckboxes" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;"></div>
            <div style="display: flex; gap: 10px; margin-top: 8px;">
                <input type="text" id="customTesterInput" placeholder="×”×•×¡×£ ×‘×•×—×Ÿ ×™×“× ×™×ª..." style="flex: 1;">
                <button type="button" onclick="addCustomTester()" style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">×”×•×¡×£</button>
            </div>
            <input type="hidden" id="planTester">
            <input type="hidden" id="additionalTestersNames">
            <small style="color: #666; font-size: 11px;">×‘×—×¨ ×‘×•×—×Ÿ ××—×“ ××• ×™×•×ª×¨ ××”×¨×©×™××”, ××• ×”×•×¡×£ ×™×“× ×™×ª</small>
        </div>

        <!-- ×§×•×“ ××–×•×¨ ××©×•×ª×£ -->
        <div class="form-group" style="background: #e3f2fd; padding: 15px; border-radius: 8px; border: 2px solid #2196F3;">
            <label style="color: #1565C0; font-size: 16px;">ğŸ”— ×§×•×“ ××–×•×¨ ××©×•×ª×£:</label>
            <textarea id="areaCode" placeholder="×”×“×‘×§ ×§×•×“ ×©×§×™×‘×œ×ª ××• ×œ×—×¥ '×¦×•×¨ ×§×•×“'" style="width: 100%; height: 60px; font-size: 12px; font-family: monospace; margin-top: 8px; padding: 8px; border: 1px solid #90caf9; border-radius: 5px; resize: none;"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 8px;">
                <button onclick="loadAreaCode()" style="flex: 1; padding: 10px 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ğŸ“¥ ×˜×¢×Ÿ ×§×•×“</button>
                <button onclick="generateAreaCode()" style="flex: 1; padding: 10px 15px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ğŸ”„ ×¦×•×¨ ×§×•×“</button>
            </div>
            <small style="color: #1565C0; font-size: 11px; display: block; margin-top: 5px;">
                <b>×‘×•×—×Ÿ ×¨×’×™×œ:</b> ×”×“×‘×§ ×§×•×“ ×©×§×™×‘×œ×ª ×•×œ×—×¥ "×˜×¢×Ÿ ×§×•×“"<br>
                <b>×‘×•×—×Ÿ ××—×¨××™:</b> ××œ× ×ª×›× ×•×Ÿ ×•×œ×—×¥ "×¦×•×¨ ×§×•×“" ×œ×©×œ×™×—×” ×œ××—×¨×™×
            </small>
        </div>

        <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="isMainTester" onchange="toggleMainTesterSection()" style="width: 20px; height: 20px;">
            <label for="isMainTester" style="margin: 0; cursor: pointer;">×× ×™ ×‘×•×—×Ÿ ××—×¨××™ (×××¡×•×£ × ×ª×•× ×™× ××‘×•×—× ×™× ××—×¨×™×)</label>
        </div>

        <div id="additionalTestersSection" style="display: none; background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 10px;">
            <small style="color: #666;">×‘×¡×•×£ ×”×™×•× ×ª×•×›×œ ×œ×™×™×‘× × ×ª×•× ×™× ××‘×•×—× ×™× ××—×¨×™× ×‘×—×œ×§ ×”×¡×™×›×•×</small>
            <input type="hidden" id="planAdditionalTesters" value="">
        </div>

        <div class="form-group">
            <label>×›××•×ª × ×‘×—× ×™× ××ª×•×›× × ×ª:</label>
            <input type="number" id="planCount" min="1" max="50" value="5">
        </div>

        <h3 style="margin-top: 20px; border-bottom: 2px solid #4CAF50; padding-bottom: 5px;">×ª×›× ×•×Ÿ ×œ×¤×™ ×‘×ª×™ ×¡×¤×¨</h3>

        <div class="table-actions">
            <button class="btn-table-action btn-add-row" onclick="addPlanRow()">+ ×”×•×¡×£ ×©×•×¨×”</button>
            <button class="btn-table-action btn-remove-row" onclick="removePlanRow()">- ××—×§ ×©×•×¨×”</button>
        </div>

        <div style="overflow-x: auto;">
            <table class="planning-table">
                <thead>
                    <tr>
                        <th>×‘×™"×¡</th>
                        <th>×¡×•×’ ×¨×›×‘</th>
                        <th>××¡' ×¨×›×‘</th>
                        <th style="font-size: 11px;">×›××•×ª ××‘×•×§×©×ª</th>
                        <th style="font-size: 11px;">×›××•×ª ×××•×©×¨×ª</th>
                        <th style="font-size: 11px;">×›××•×ª ×‘×¤×•×¢×œ</th>
                        <th>×©×¢×”</th>
                        <th>×”×¢×¨×•×ª</th>
                    </tr>
                </thead>
                <tbody id="planTableBody"></tbody>
            </table>
        </div>

        <h3 style="margin-top: 20px; border-bottom: 2px solid #2196F3; padding-bottom: 5px;">×‘×•×—× ×™× ×‘××–×•×¨</h3>
        <div class="table-actions">
            <button class="btn-table-action btn-add-row" onclick="addTesterRow()" style="background: #2196F3;">+ ×”×•×¡×£ ×‘×•×—×Ÿ</button>
            <button class="btn-table-action btn-remove-row" onclick="removeTesterRow()">- ××—×§ ×‘×•×—×Ÿ</button>
        </div>
        <div style="overflow-x: auto;">
            <table class="planning-table" id="testersTable">
                <thead>
                    <tr>
                        <th>×©× ×‘×•×—×Ÿ</th>
                        <th>×¢×™×¨×•× ×™</th>
                        <th>××•×¤× ×•×¢/×˜×¨×§×˜×•×¨</th>
                    </tr>
                </thead>
                <tbody id="testersTableBody"></tbody>
            </table>
        </div>

        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
            <button class="btn-big btn-next" onclick="goToExams()" style="flex: 2;">
                ×¡×™×™××ª×™ ×ª×›× ×•×Ÿ â† ×¢×‘×•×¨ ×œ×‘×—×™× ×•×ª
            </button>
            <button class="btn-big" onclick="openDistributeModal()" style="flex: 1; background: #9c27b0;">
                ğŸ“Š ×—×œ×§ ×¢×‘×•×“×”
            </button>
        </div>
    </div>

    <!-- STEP 2: Exams -->
    <div class="section" id="section-exams">
        <div class="section-title">ğŸš— ×‘×—×™× ×•×ª</div>

        <div class="progress-dots" id="progressDots"></div>

        <div class="examinee-card">
            <div class="examinee-number" id="examineeNumber">× ×‘×—×Ÿ 1 ××ª×•×š 5</div>
            <div class="examinee-form">
                <div class="form-group">
                    <label>×©× ×¤×¨×˜×™:</label>
                    <input type="text" id="examFirstName">
                </div>
                <div class="form-group">
                    <label>×©× ××©×¤×—×”:</label>
                    <input type="text" id="examLastName">
                </div>
                <div class="form-group">
                    <label>×ª.×– / ×.×:</label>
                    <input type="text" id="examID">
                </div>
                <div class="form-group">
                    <label>×‘×™×ª ×¡×¤×¨:</label>
                    <select id="examSchool" onchange="onSchoolSelected()"></select>
                </div>
                <div class="form-group">
                    <label>××¡' ×¨×›×‘:</label>
                    <select id="examCarSelect" onchange="onCarNumberSelected()" style="display: inline-block; width: calc(100% - 45px);">
                        <option value="">-</option>
                    </select>
                    <input type="text" id="examCarManual" placeholder="×™×“× ×™" oninput="onCarManualInput()" style="display: inline-block; width: 40px; padding: 12px 5px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; text-align: center;">
                    <input type="hidden" id="examCar">
                </div>
                <div class="form-group">
                    <label>×¡×•×’ ×¨×›×‘:</label>
                    <select id="examVehicleType">
                        <option value="">-</option>
                        <option value="B">B - ×¤×¨×˜×™</option>
                        <option value="C1">C1 - ××©× ×§×œ</option>
                        <option value="C">C - ××©× ×›×‘×“</option>
                        <option value="D">D - ××•×˜×•×‘×•×¡</option>
                        <option value="A">A - ××•×¤× ×•×¢</option>
                        <option value="A1">A1 - ××•×¤× ×•×¢ ×§×œ</option>
                        <option value="A2">A2 - ××•×¤× ×•×¢ ×‘×™× ×•× ×™</option>
                        <option value="1">1 - ×˜×¨×§×˜×•×¨</option>
                        <option value="E">E - ×’×¨×•×¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>××•×›×œ×•×¡×™×”:</label>
                    <select id="examPopulation">
                        <option value="">-</option>
                        <option value="kadatz">×§×“"×¦</option>
                        <option value="voucher">×•××•×¦'×¨</option>
                        <option value="army">×¦×‘×</option>
                        <option value="other">×¤×¨×˜×™/××—×¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>××‘×—×Ÿ ××¡':</label>
                    <select id="examNumber">
                        <option value="">-</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label>×‘×•×—×Ÿ:</label>
                    <select id="examTester"></select>
                </div>
            </div>
        </div>

        <div class="result-buttons">
            <button class="btn-result btn-pass" onclick="markResult('pass')">
                <span class="btn-result-icon">âœ“</span>
                ×¢×‘×¨
            </button>
            <button class="btn-result btn-fail" onclick="markResult('fail')">
                <span class="btn-result-icon">âœ—</span>
                × ×›×©×œ
            </button>
        </div>

        <!-- Failure Form (shown when clicking fail) -->
        <div class="failure-form-container" id="failureForm">
            <div class="failure-form-title">ğŸ“ ×˜×•×¤×¡ ×›×™×©×œ×•×Ÿ</div>

            <div id="failureCategories"></div>

            <div class="notes-section">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">×”×¢×¨×•×ª ×”×‘×•×—×Ÿ:</label>
                <textarea class="notes-area" id="failureNotes" placeholder="×”×¢×¨×•×ª ×™×•×¤×™×¢×• ×›××Ÿ ××•×˜×•××˜×™×ª..."></textarea>
            </div>

            <div class="signature-section">
                <label style="font-weight: bold; display: block; margin-bottom: 10px;">×—×ª×™××ª ×”×‘×•×—×Ÿ:</label>
                <canvas id="sigCanvas" width="280" height="80"></canvas>
                <br>
                <button class="btn-clear-sig" onclick="clearSignature()">× ×§×” ×—×ª×™××”</button>
            </div>

            <button class="btn-big btn-save-failure" onclick="saveFailureForm()">
                âœ“ ×©××•×¨ ×•×¡×’×•×¨ ×˜×•×¤×¡ ×›×™×©×œ×•×Ÿ
            </button>
        </div>

        <div class="nav-arrows">
            <button class="btn-arrow" id="btnPrev" onclick="prevExaminee()">â†’ ×”×§×•×“×</button>
            <button class="btn-arrow" id="btnNext" onclick="nextExaminee()">×”×‘× â†</button>
        </div>

        <button class="btn-big btn-back" onclick="goToPlanning()">
            â† ×—×–×•×¨ ×œ×ª×›× ×•×Ÿ
        </button>
        <button class="btn-big btn-next" onclick="goToSummary()" style="margin-top: 10px;">
            ×¡×™×™××ª×™ ×‘×—×™× ×•×ª â† ×¢×‘×•×¨ ×œ×¡×™×›×•×
        </button>
    </div>

    <!-- STEP 3: Summary -->
    <div class="section" id="section-summary">
        <div class="section-title">ğŸ“Š ×¡×™×›×•×</div>

        <div class="stats-box">
            <div class="stat-item total">
                <div class="stat-number" id="statTotal">0</div>
                <div class="stat-label">×¡×”"×›</div>
            </div>
            <div class="stat-item passed">
                <div class="stat-number" id="statPassed">0</div>
                <div class="stat-label">×¢×‘×¨×•</div>
            </div>
            <div class="stat-item failed">
                <div class="stat-number" id="statFailed">0</div>
                <div class="stat-label">× ×›×©×œ×•</div>
            </div>
        </div>

        <h3>×¨×©×™××ª × ×‘×—× ×™×:</h3>
        <ul class="summary-list" id="summaryList"></ul>

        <div id="whatsappButtonsContainer"></div>

        <!-- ×›×¤×ª×•×¨ ×™×™×¦×•× × ×ª×•× ×™× - ×œ×›×œ ×‘×•×—×Ÿ -->
        <div style="margin-top: 20px; background: #e3f2fd; padding: 15px; border-radius: 10px; border: 2px solid #2196F3;">
            <h3 style="margin: 0 0 10px 0; color: #1565C0;">ğŸ“¤ ×©×™×ª×•×£ × ×ª×•× ×™×</h3>
            <p style="font-size: 13px; color: #555; margin-bottom: 10px;">×©×œ×— ××ª ×”× ×ª×•× ×™× ×©×œ×š ×œ×‘×•×—×Ÿ ×”××—×¨××™:</p>
            <button onclick="exportMyData()" style="width: 100%; padding: 15px; background: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">
                ğŸ“‹ ×”×¢×ª×§ × ×ª×•× ×™× ×œ×©×œ×™×—×”
            </button>
            <div id="exportStatus" style="margin-top: 10px; text-align: center; display: none;"></div>
        </div>

        <!-- ×§×˜×¢ ×™×™×‘×•× × ×ª×•× ×™× - ×¨×§ ×œ×‘×•×—×Ÿ ××—×¨××™ -->
        <div id="otherTestersSection" style="display: none; margin-top: 20px; background: #e8f5e9; padding: 15px; border-radius: 10px; border: 2px solid #4CAF50;">
            <h3 style="margin: 0 0 10px 0; color: #2e7d32;">ğŸ“¥ ×™×™×‘×•× × ×ª×•× ×™× ××‘×•×—× ×™×</h3>
            <p style="font-size: 13px; color: #555; margin-bottom: 10px;">×”×“×‘×§ ×›××Ÿ ××ª ×”× ×ª×•× ×™× ×©×§×™×‘×œ×ª ××‘×•×—× ×™× ××—×¨×™×:</p>
            <textarea id="importDataText" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”× ×ª×•× ×™× ×©×”×ª×§×‘×œ×• ××‘×•×—×Ÿ ××—×¨..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: inherit; font-size: 14px;"></textarea>
            <button onclick="importTesterData()" style="width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; margin-top: 10px;">
                â• ×”×•×¡×£ × ×ª×•× ×™ ×‘×•×—×Ÿ
            </button>
            <div id="importStatus" style="margin-top: 10px; text-align: center;"></div>

            <!-- ×¨×©×™××ª ×‘×•×—× ×™× ×©×™×•×‘××• -->
            <div id="importedTestersList" style="margin-top: 15px;"></div>
        </div>

        <div class="summary-actions" style="margin-top: 20px;">
            <button class="btn-action btn-print" onclick="openPrintableReport()">
                ğŸ–¨ï¸ ×¦×¤×” ×‘×“×•"×— / ×©××•×¨ PDF
            </button>
            <button class="btn-action btn-back" onclick="goToExams()" style="background: #666;">
                â† ×—×–×•×¨ ×œ×‘×—×™× ×•×ª
            </button>
            <button class="btn-action btn-reset" onclick="resetAll()">
                ğŸ”„ ×”×ª×—×œ ×™×•× ×—×“×©
            </button>
        </div>
    </div>

    <!-- Printable Report (Hidden, shown only when printing) -->
    <div id="printableReport" class="printable-report">
        <div class="report-header" style="position: relative;">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAfE0lEQVR42r2beZRV1Z3vP/ucc8+d7626NdyamJRJRhVwAgWEDiIiL5IYE8WYVtNJaBK6088kxn62nSzTeUlW0k9NaDWdZ5vBNhKNOAsaUcSBmbIQqqCqqIKixlt1xzPv90edKkuCxpjut9fa60777L2/+zd8f3vv3xX8ZUXxq/MBv8eBMFAEpgF54Cyg3X81gHHAYeD1PzGW8MeSgPdxJ6z+hUA9v45MZCrwSaAC+D7QAPwI6Ad+DtQAXwFiwD8DZwNXARuACPAHv/8U8C/AYqAaOA6Y/hjSB6/6r5L/pqICmj/ISFkC3DLm81/5E7gdcH1Qg8A2oBV4BGgEHvSlPt8H/3MgB4z3+6n2taEAnAAOAWlgLXDxGST/Z0mKj6BKwgfg+IAeBNYBk4AHgLl+27f9iVYDfYANdAGX+mBTQBD4LfBtoOS3z/o16PfT4/92D/AZYDpwjb8wtwJPAY/6GiV9YSgfBbzyJySqjFGjTwL/6NveYeA/gPVAL1DpDzYIrAF+509+HNACBIDrgCVCiGei0ejeO++881/Ly8s7fa0Z75tGAUgC9/p9vgXU+9I/29eGV/xFrvft/hxfGJ4/T+Xj2uhIGQ884zuaDHAKKAemAK/6Etp4unopinKnEOIuTdMu9m10va/y6TOMdzZwXSKRSIVCoXFCiB2+RjQAv/DVeoe/eBP9Z+b4AK8Cvgk85i/Sh6q5+IDvpG+br/mS+k/g//qvu32gD/tALwBeBL6wePHige3btztSyrELp9bU1JQ5jtMQCASqFUVJCCF013UlUFIUZUhKecJ13Ux3d/fAGI+fWLx4cXHHjh0XOI5zHrDa9/iur9rrfYCbfMfYB1jATf58VL/thwIe8bzfBP6X7x3PA272O6317fEJX90agZcDgcA7tm03AnY6nY66rnu+oihLAoHAeaFQaGYkEqmPx+PRWCxGOBwmoGlIJI7jUiqVKBQK5PP5XKlUai+VSu/atr1TCPFKV1fX3hEKqqioiPf3908BvuybTda34/XALuCLvlbowCW+eSinU5g4g91K4LPA3cBPfakOAkeBPb5argC6fRXLA9TU1FzmOM7nwuHwipqamolTpkxhxowZTJkyhQkTJlBZWUk8Hvdi8biMhMMA5AsFCvm8yOVySm9vL+3t7TQ3N3Po0CFaWlro6+trNAzjeeA3XV1duwGEEEgpJ/jS/CZwvU91R337/iXwNd/e+z+IusQZKCflO50Rz3mFz431Iw0WL16spVKpz1dUVLw5bdo0eeONN8qHHnpIHj582JNS2lJKR0rpSik96Zdifkg+8cBdcssv/kXatinHFM9v61iWZTc2NsoHHnhAXn/99fKcc87x0un08+l0etXI2FJK4c9trc8Epm/n64HnfAmv/ihsdL/vhTf6kdLYB/SRYCWVSq2Nx+P7Zs6cKW+77Tb55ptvjoB0RxC4risdxxmuti0d15Obf/Yt+X9unS//ee1k+fiD35VSSmnblnT8tq7rjl0E13Vde/v27fLv/u7v5KxZs2RFRcUf0un00tPm/Fe+tO/xpbnPl/YRPwgSp2tzvW/sf+2rym/9sG+f/5vwwVJTUzMhGo3+vqGhQW7YsEEeOnTIGQtyZNIj1XEcaZqGlFLKg2+/JDd/71r54n1/I39392flj7+0UDY37ZZSSmmaxhmfHVOcXbt2uV/84hfl+PHjZVlZ2b/V1dVVnAb8HeBZ37kt9MFfebr5Cj/i6fcbPOnTzkX+51tHGpeVlV0fDod7ly5dKl955RV3BOjIBD3Pk47jSNu2pWVZ0rIsaZqmdBxbZjIDcut/fEMeeeYu+dgPbpD/9s1Vcsv3r5MPf+9WaRimtCxTmpY5+pxt29JxHOl53mj/I8C3bNniLly4UCaTyaMVFRVLfBwa8D1gwDe9Np9KF49V6ZFY+qRPO61+tPSOT/YXAS8KIQ6Hw+G7pZQ/3rBhQ2TTpk3ulClTVM/zxAgFeZ6H53mMoaQRa0ML6BzY/lvOqnYJRBJ0Hm9j94EmZs+ejVfoI2sKJk6di+PYCPGeuUkp8TwPIQSKoiClREqpTJs2TaxZs8bp6+ur2Lt377pIJDJgGMYbwE6f09f6DPK/gb0jjnUsYOEb+S7ffh3/8+PJZLLD87xN8Xj8b3/0ox+5t912G7quq67roijKKNAzFel56MEg7S1N5FtfoKG+gd6+Puxinl0H36WqqoK5s2dy9NAuKibNI5Eox/VchHg/eZwO3PM8otGosmrVKi8QCCg7duy4UtO0oGVZzwG/9z31733BDXzQbmlk+zVC1qoQouQ4zi+SyeQNjzzyiL127VrNdV3hUwOu636I75MIwHHhwLYHqE8FcKWgv68Pz7HY23iEZFmCCy+aj+qZtLUeY9KsRXiu8z4pnw5cSomiKKOeeuHChYwbN8599tlnFwshIo7jbPX9T873Rx+6PRzdegkhXFVV74/H459/9NFH7WXLlgVs20YgcV0H13NHJzC2MlIBXQ+yb8dTBIYOEk2U4dgWg5lBhPTY19hMJBpl0SXziSbKKGU6yRg6deMn47kOkpG+vNE+pZRIz8Nzh8cWAjzPE3PnzhWTJk1ynn766csURbEcx9nux+/yo+yHNcAJhUJfd133Ww8//LC9atWqgGVZaJqGqg5XTTtzVf3qodL49jb6Gp9ADwQoFksYpkl3f55EWGNfUwue6zHv3BmomkZ1upKu1gPkrBDl1eMI6IH39aeePo6qjkradV0xZ84cJZFIuFu2bPmrWCzWaFlW45hA6n3gTl8AJx6PX5zL5X7wne98x7nmmms00zTRNA3X9di34ykGu9tRVG20LyHEcEWAIpCuQ77vOF62nQnj63nm5bcoiwY5a+4i6qdMweh4A6SLHq+h/VSRs2ol2ZLK1LNqOXlyK3s730LRy5EIXMfFdV0818V1Pf+9h2Ua1J09i3MXXoGiKDiOI9avX680NjZ6mzZtejCdTu/u7u5uPz281E7fNMybNy+ye/fuB5cuXSruuOMOYdu2AImqquzb8SS7f3sX8Xh82FH5ayeEQFHVYSkEhiUQCkfRY1EMw8K0TE4aBivPrqXjRAZFDWDbFlXpWmpnXcmBV35Gb3+Wy5csJF1dSVo6GKVuSsUiuVyOfC5PIVegmC+Qzw6/L+Tz7NycI3jnL5g5b/Gwqnue8oMf/MDdsWNH2cGDBzcJIa6QUiofJGFFCOHu379/YyKRmLFp0yZHSql5njcsOUAoCqFwlGiiAtdxRpdJjEpaQVVVVE3Fk2CWimjCo6YswlMvv0nTgb0oAqIBFSEERiHLpGnn89qTATqONsPii7AMBy2gE0skSaYqqKr1KBWK5LN5hgazo+CNokFnx3EQow4MpCQWi6n33Xefs3z58hVSyuts235k7M5JGbtLamhoqHMc5xsbNmzwpk6dqpZKJRRFQSgKtm0z68IrCNbMxCgM+lTh4jgueVOSLbkMFW0GcgZ9Q0X6h0pkcgadvXlmLf4sa2/cyCOPPkYhn0dVVKT0UPUQhWyGUu8xBkserR29tHecorX9JC1HO2huOU57xyl6MlmKtkeiPEl5RTmpqgrCYYVJC5ZzznmXYlvWsLcVAtd1ufTSS5XrrrtO2rb93cWLF4d8lRZjJSyEEF5nZ+f66urqxMaNGx3btrURpzCWUy+4ej0v37+BVBCkUMllh5hx1T8wZeYFWJaBEOr7aCQQDJFKVXIJEC9P033oecbVVCI9iaLpHHnzSbo7DhNKzWTGJ75OqZj3ackPaFwXPRTm8N4/EFOPka6roZjLMZgvMn/FFxBIJBKBGOVqKaVy++23u4899tjZr7766ueAfx9xxiPnQO6CBQsSUsqbP//5z8vKykrFNE1U9b3JC0XBNA0mTZ5Fw7w15HMZhKISDWq0736KeHkV6drxVKXrqaoZrtXpelKpStqaD/L6sw9zzbqvsWDxGkr5LFoggFHMM9C+j4LlEQyFKSuvIF07jnTdOGrqxpOuHU/duEmEwnFErplEIkYwFATFpXLaUuoaJmJb1ihvD1PVMPBp06axZs0a6XneV6SU71NpFWDXrl0rg8Fget26dZ7ruspY6Y6CFgqu63DRypvwwmk8q0ggFKdw4gBvPP8rAEyzhG1Z2JaFZZkAGEaJ3/38n9j3wr0M9XZg2i5CKNhmEauYI5PNM2HyLKT0cBzbf9bCskpIYP/2RyjXi5iWh1nMcnJAMn3BlbjOHwcpI+GtlFK9+eabAc6PRCILRg77FED64dqn58+fL2fPni0Nw3ifdN8DLHAch0SijDkrbmUonwckyWQ5za/+ip5Tneh6cDjKEgKhKjiOy4SzZ2Br5Wz61+9xorWJTLaIoggc1yVfKKCG4ixZ+TmEUCjkhkZjoGAwTHtLE9ap3QTDMVzbov34CaqnfYJ4LDoc6Yk/jsZGaPKyyy5zJ0+eLEql0id9AQoFcNeuXRsDFi5fvlwAiuv+cTz73uGcimVZzL7wEyTPugijMIRQg4RkiZ1bNiGU905LBQLXtQlHYnzpGz/BVaI8+dxLHDjcytwp46ipTtOfLXDeJVdSVVNPpr+bx+6/Eyk9FEXFtGwO7/gN5bEghmEz1N+DGZzI5FkXYFmmP9aZQ1DHcQgEAsqSJUsAlrmuKwBXAXj88cenAzUXXHCBlFIqiqJ8IGC/R1QBC678IoYMIF2bcCzJwOHtNO3ejq7rSH9DoSgalmlyznmL+OFDr3Lu/EU0vnuEprZuqgJF1Fg1tRUJnr7nSzz/0Hc5efQArifRNI3GN59FZI8h0XDMIqcGSky76JpRGvyw4u/axKJFiwDOqa+vbwCk4qvp7FgsxtSpU13LslCUDz/aHaGp2glTiaWnYFslPCmIhgIc3vk7XJ8EPM9F0zTe/MPjbH30J4SiZaxZ+1k+teIS8obDngMHiKguarSSw+/sorNpO4FEmlAwSLFkcOLgVsLBICXDoJDNoCXGUVVTj21bH7jBGKvWgJg9e7YUQkROnjw5ZSTYADgrnU6TSqVwHOdPAh62MIkiQA0EhwN8fyFcq4Qn5XvBioBYsoptm++l440H6Tq2j1SqCtUzSU9fRKq6nj07nqamtoFMvsTUuYv8UNHGMYs4to1tmpiGAUL78+5VgPHjx7vJZBLgbCHEKOD6yspKIpHIKJf9KXXRtACD/X1ku4+i6SEURVAsFmmYtZSAKvB8O7Qsi3MvvJz09CXc8+Pvo3p5FFVFD4YxeprxzAKKlQfXJmtrLFl53fC1YzxOatJ8MgN9OLYNUpA91Uw+X0BV1I98h5ZMJikrKwOoE0KMRlrRaDSKqqrij08szgTYQ1EUdm99GNUcQFGD2KU8evV0zlt8DY5jv09LXNflK7ffw6S5n2DTv/8njUeOcdn8mcQ0Dw+FCy9dwfGO46y56VtUVtfxyjO/Jj+UYf7yGzDUcszCELYroNDFwR2PD+/GPO8j2XEgECAajY5c3Y4C1j6KGo/wXDAYorW5kY7dW4jFywCPnGGx4KqvEArquK73nqf2AwFF1dh414N86rM3c7j5GDv3vUuyogpDBhjK5Vn86b9n+ep1vL1tMy/+9l7UgE4sFmPWsr+mr68f2zQIh8K0v/U7Tp1oRw/oSPnRrol9ilXHArZN03zfCcYweXtnoCWB7bi8+eS9RDRACVDIZqidcwWTZ8zDNI0/8gFCCDzXxfYkM2bMYN0nl1MwHfa/cwjzxG66WnYz8+JVHHhtC7+/7+8pS08gEoliGiVmXbCc+MQLyWV6sGxJiBJvP/cA8gNPRbzRA4gR0zRNk5HTD8VX4czg4CCWZclhKboEAjq6HnyfPXvu8Pd7XnmcwWO7UQJR7FIeO1DGRatuwXUd31nJ0Sqlhxz1CxLTNPA8STQUZLBgkisa1KfT7Nn2G177zV10DRVZ9slbhp+TEiFdLlr9ZYqujmMUULUwmeYdNO1+GV0P4nnu+9hD14MoqjZKi6VSiVwuh381Mwq4s6enh2w2SyCgo+kRenu66Gh9F8ssIT0P17FRNZWB/l52PXU/oWAUy7IZGMwxa8XfUJ6qwpUCJRAERfdrAE0PogeHLy9URcFxhxfCdhzyJYO+oQLFUpGD2x+jy4rw13f8gvMuXIbtghqMYLlQ2zCJsy+7gVw+h+t5RENB9j13P/l8HkVRcF0b6XmUClmOH2uikM8S0PXhi+aeHtHf3w/QKaUc3S219PX1ceLECZEqL+ONp+8nqXRz/GgzC679Luna8aOr+IfH7sHKdBMqr8AzTBQtyJHXH6f17adGrkkRyntaIdQAZ89byTnzL6ev/QAUT2I6UFORZEJNiopkjHyxROdAifkLziV39DU2739mTBQlESg4toEeiiI9ByUQQg518uZzD7HsU+sJBIbBHW/ez0s/30gkWcP4eVdz2eqbaGluVkzTJBQKtRqGgSalpLy8vDGTyThNh97VzprQIA+9/oS4fNklCCHY+fxvSFXVgYDsYD8tO58hEopiGhaqKlA1lWJnE4qqoGkqiqqgqgqKMmzv0nXZ076H/W88T+bkQYRrkSvYBAIqqqJwvHsA07S5aMZEdOMEg8eOoaraMIGPZQWhoAeCeFKC6xCNJ+ncs4Wtqk4oHEZ6cKrjCLoexBw8xWtPPshlq2+Su/fsEcDAuHHjjjY3Nw9L+Ktf/erRu+66q+XlbVunf+Gmz8sJcxaK3t4eQpEIRtcbtB4ewjENTvZkUL0QjuKC4qG6AuE4aJqO6nm4pu2feCgEQ2GEpiMCUBZyGexvZtaSW3jioe8j7CyG7VEolqhMxpkxqZZISMe0XUKxMNK1cR1rxPcQCIbxvGFHqvoLoWkaKiZHX/8V5fEog5kMSAhGEthekfOXrgXwXnzxBRXYd+TIkVNCDHsSVQjhSinvq6ur/Upj0xHnxJE3NLq2EdB0coNZCrkshWwW07Q4dLQT03QJ6yqBgEYwHAbpIIJllFfX+8eqHoX+EwhziHhZOaqqYRYGGLdwHYNDGTJHXiKTNRgcyhKPhJjcUI3teKiqIJ8bgnAFkbIaX60V+k62EAlIbFcOn25ISbFkEorGuHDBXIrZLPlsFtMwUIBMNsfKDQ+gRlLu+HH1aqFQ/LYQ4m4ppaqNUFAwGHzi5MmuL7/w3NPqFVesYM+7z5NOKpiWjWGaeK5LrlCkrKyM+oYGuk51UpdKkEwlKAXruODqr1OWqsTzJJ4nyQ328vYLv6Rt52Mkk0kCoThtb2ym29QYVxFjoKOXvkyOyQ1pPClRFcFQrsDES9Yx97JriMbLfQ5VON5ykKatPyXs5cgNFTje1YMuVJxiida2DqpTCUzLwvUktm2gpyZSVX+WvO++e9VCoViqrKx8tq+vD0COHmFed911rwL7fvbT+4gny1wlPoHCUC94JiFdYyBXoLsvT2V5BemqFOfNm0/vYI6crGDBqo2Ul1fgmAbStRHSoTxVxRWf+zrjL1zLYH8fUioc7+5HuEX2vNPCqb5BIiGdWCQIQiGXHWTSpetYsuZWEokyhHQQ0sG1TSZNmc3sKzaS96L0Dw6hoBCLBNGFoPmdFo61nySoB3DNAoMDPZw97xMA3r333Avw8vr16w/6kZA3sstX9u/fb2uaRmtr2+pFCy+V5y64VDne0YkWqaKxqYlTx7uorU6TqkwxVCgSjoSZNGUiVJzL9LkXYVsmCOHvYoYP05CShmnnc/DNrTjFDK3dg+QLRebPmQauS9EwGZ+uxLEKiPLJfOKGb+O5Np70RvsRQmCZJSqr68h7Id5942kqk0lKhoXnSQKKQm/3AEOWR930i4jVz2HR6pvZ/Pjv+dnPfibC4fBtW7dubRrJSFLGXrHMnTv3EeDQnXf+oxpP1XgLrvoaF6/9ByaetwrVswlHI0SiEULhEG/vPcDkyVModw/x+vO/BFUfDQRG7n9czyUaiXLxNRvIDOWY2VDDWQ01pKsqsGyHkWB+qGCzYPVX0APa8E7Lj6KGgwpJOBKjae9r7H/yJ9RWpDja1UtvNjd8/SIUnGKWmimXsPLmu1l10z8ihep++/ZvKUKIl2bMmPHC2LSHsec4SldXlxEKhfrb2to+VVaW9JYsvlQZygwwe/5llDzJUGcj0USSQ0dbicWiBAIa9bU1yFwbB/e9Rbh8PGXllQih4Lk2AoHjOtRNmEpHWwsnW/aTtSSu59HV04dpe+jSYMKCNVy47NOYpoEQClIOR2a6HsRxPXY88xAHnvoJYcVlsGCRLRTpGcoR0kOY2Qw1cxfzuY0/wLFtNE2Td3z7dp588kk7Go1+ub29/fAHAZaAsnDhwkMdHR0zduzYMWvVqlVufX2DUigUmHH+pQwWDQrdh5k3/zyq09VseeZF+voHqK5OUxWxOLz7Rbp7+4mW1RJPlKFq2sgZLzUTz+GJzb+gu6+P4109lAybQiGHoydZ9/c/RlE1BAJd19E0DceDI/tfY/sj32Pw3W2oWpDmk/3kCiVS8SixUBhh5EhNXcAN37gPRVHRg0Fee+0175ZbblF1Xf/p6tWrNzU1NTF2L/lHJ3Xt7e1edXX1rkwm8z927txZfv3113uBQECYpsGU2ReTKbgE7C40TSWbLZDJDJJMRGnv7GHyuDTF7kMc2fsSJzvasD2BHo6jBSMkEmUkK9IMNO1gfDpNTXmCZFjn01/9ERMmz0KoKq4r6TnZxjtvv8BbT95L6xuPors5hgzIFQzqU0k6+wYJ60E0q0DFjEv43P+8Fz2go6oqPT097sqVK9VcLrcnmUyu37VrV/b03I4PTEyLRCIri8Xi5quvvjq0efNmaRiGApJoLM7Bt7ah9L+BioVpeSRjEX716BamT5lAUAuQSoQw8lmGciW8QIJgspZY1QRiqVq2/fpfCVoFFAGU17Dk2g3k+k+SHzhJvreNYn8nws4TCoWIROMc7ezl3faTVCXjVJYlUD0Xo5Bl3AVXs+bWfxq+1FYEtu14l19+ubJz586e8vLyT2YymdfPlLIkPiT10AuHw18qlUr3feYzn+GXv/wllmUpjm2TSCZpbWmiY/djpGMm/ZkCLa0d9Pb2IwSEggHCuk48rJPJZFA9m2g4gO1KHKHT1TWAEIL62hSqtIbvnD0PoWjowTDdgwX6BnPMmFCDaTu0dfUzrjqFkRvCkgHOXf0lLrtyHaZpous6pml6V111lbJt27Z8KpX6wsDAwOYxZvqR8qUloDiOsysUCuX379+/oqmpSaxZs8YLhcMin8uSrhtPavz5tJ/owRzqZFJtOZbtYhgWmaE8IV3jRHcfmqbR2Z8jEAxTlSpnKFcgEg1RloziuB6mKyi5AqkEaOseJF8yURWBEFA0HeqrygkKh2KhSGLi+ay49W7mXLCMUrFIKBxmcHDQvfrqq9WXX365kEqlvjYwMPDImP3pn5UgLgHhOM6b0Wi0d//+/Uu3bdumL1++3K2tq1Ny2SF0XWfi9PloZZM5caqboMwT0yXV5XFqq1JUJGIENY2uvkHGVZdj2g6ZbJGeTI5gQKPt1ACJaIi2U/0EAxrxaBjLcYmEdGpSUcKqx1CuSLBqCudf9bcsu3YjZeVVmGaJcDjC/v373RUrVqi7d+/uq6io2DAwMPDrMVm1Hzm59IxtYrHY2nw+/6N0Oj3+hz/8oXfDDTfguq5SKOSJROMIRaHreAudh3bQ17qbfG8bmAXyxQKqolFZnqR3KI9hDfOv7QzfPEZCOrZjE9FVNFVBVRRQddRoJakJc5k0dykTz1mArqmYhkEwFALw7rnnHnHHHXeIfD7fmE6n/6Grq+ulMfnc/CWAR206mUzOGxoa+g6w8tprr+Wuu+5yp0+frti2LQyjRCgUJRBQKZZM+rvb6T1+iMHuYxQzXRSG+pC2AZ6F6zhIQNMCCEUjEIoQiKQIJ6tJVE+gon4K1Q2TiceGEwEt0xw5RJB79uzxbr/9dvX5558nHo//OhwO/0tPT0/Tn5Lsxykjkq7Udf024HgkEpEbN26ULS0to9l4hUJeFvJ5adnvZdE5UsqSaclsLiczA/2yr/eU7OvtlpmBfjmUzcpCyZCONybf0JPDCW22NfpVY2Oje/PNN8twOCwVRXmnrq7uS7FYrPLjJoT/OaAFoCaTyfP8zPXueDwub7zxRrlt2zavWCyOJpTaliWL/gIUCwVZKpWkYRjSNC1pmKY0DEOWSiVZLBZlqVgcTVEcSTQtFArOli1b5Nq1a2UikZBCiLbq6uq7GxoaZvlZOuJjSe1jApcNDQ3hQqFwbiaTWQusAqbPnDmTZcuWcfnllzNnzhyvoaFBBgKBsWOJMzhHAOk4Dm1tbWLPnj3Ktm3beOWVVzh69KgnpdxfWVm5JRKJPNXa2vqOn4flfWw1/UvL5MmTg8VicWJ/f/8i0zSXAguACclkMjhx4kQmTZrExIkTSafTJJNJgv6hXqlUYmhoiO7ublpbW2lra6Ozs5PBwcEicDQWi72VSqVeUlX17WPHjnWM+SvPX2aXf+HzYycgpk2bFstms/WlUmlqPp+f4TjOVP9/ClVAAgj56QeK/6+XIjAohOgJBoNt8Xj8SDwePySlbG5tbT3lp0C6HzLm/38Jf8gktKqqqlAsFou6rhtVVTVm23ZIURQNEKqq2kKIkqqqBdd188eOHSv66uqeob//1j9l/Vc4tv8yZvivLP8PWiIYou8SIgAAAAAASUVORK5CYII=" alt="×¡××›×•×ª ×¨×™×©×•×™ ×¦×”×´×œ" style="width: 60px; height: 60px; position: absolute; right: 0; top: 0;">
            <h1 class="report-title">×“×•"×— ×‘×•×—×Ÿ</h1>
            <div class="report-subtitle" id="reportSubtitle"></div>
        </div>

        <div class="report-section">
            <h2 class="report-section-title">×ª×›× ×•×Ÿ ×•×‘×™×¦×•×¢</h2>
            <table class="report-table report-summary-table" id="reportPlanExecuteTable">
                <thead>
                    <tr>
                        <th colspan="6" style="background: #e3f2fd;">×ª×›× ×•×Ÿ</th>
                        <th colspan="8" style="background: #e8f5e9;">×‘×™×¦×•×¢</th>
                    </tr>
                    <tr>
                        <th rowspan="2">×‘×™×”"×¡</th>
                        <th rowspan="2">×¡×•×’</th>
                        <th rowspan="2">××¡' ×¨×›×‘</th>
                        <th rowspan="2">××‘×•×§×©</th>
                        <th rowspan="2">×××•×©×¨</th>
                        <th rowspan="2">×‘×¤×•×¢×œ</th>
                        <th colspan="4" style="background: #c8e6c9;">×¢×‘×¨</th>
                        <th colspan="4" style="background: #ffcdd2;">× ×›×©×œ</th>
                    </tr>
                    <tr style="font-size: 9px;">
                        <th>×§×“"×¦</th><th>×•××•×¦'×¨</th><th>×¦×‘×</th><th>×©×•× ×•×ª</th>
                        <th>×§×“"×¦</th><th>×•××•×¦'×¨</th><th>×¦×‘×</th><th>×©×•× ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="reportPlanExecuteBody">
                    <!-- ×™×ª××œ× ×“×™× ××™×ª -->
                </tbody>
                <tfoot id="reportPlanExecuteFoot" style="font-weight: bold; background: #e0e0e0;">
                    <!-- ×©×•×¨×ª ×¡×™×›×•× -->
                </tfoot>
            </table>
        </div>

        <div class="report-section">
            <h2 class="report-section-title">×¡×™×›×•× ×œ×¤×™ ×‘×•×—×Ÿ</h2>
            <table class="report-table report-summary-table">
                <thead>
                    <tr>
                        <th rowspan="2">×‘×•×—×Ÿ</th>
                        <th colspan="4">×¢×‘×¨×•</th>
                        <th colspan="4">× ×›×©×œ×•</th>
                        <th rowspan="2">×¡×”"×›</th>
                    </tr>
                    <tr>
                        <th>×§×“"×¦</th><th>×•××•×¦'×¨</th><th>×¦×‘×</th><th>×©×•× ×•×ª</th>
                        <th>×§×“"×¦</th><th>×•××•×¦'×¨</th><th>×¦×‘×</th><th>×©×•× ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="reportSummaryBody">
                    <!-- ×™×ª××œ× ×“×™× ××™×ª -->
                </tbody>
                <tfoot id="reportSummaryFoot" style="font-weight: bold; background: #e8f5e9;">
                    <!-- ×©×•×¨×ª ×¡×™×›×•× ×›×•×œ×œ -->
                </tfoot>
            </table>
        </div>

        <div class="report-section">
            <h2 class="report-section-title">×‘×•×—× ×™×</h2>
            <table class="report-table" id="reportTestersTable">
                <thead>
                    <tr>
                        <th>×©× ×‘×•×—×Ÿ</th>
                        <th>×¢×™×¨×•× ×™</th>
                        <th>××•×¤× ×•×¢/×˜×¨×§×˜×•×¨</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="report-section">
            <h2 class="report-section-title">×¤×™×¨×•×˜ × ×‘×—× ×™×</h2>
            <table class="report-table" id="reportExamineesTable">
                <thead>
                    <tr>
                        <th>××¡'</th>
                        <th>×©× ×”× ×‘×—×Ÿ</th>
                        <th>×ª.×–</th>
                        <th>×‘×™"×¡</th>
                        <th>×¨×›×‘</th>
                        <th>×“×¨×’×”</th>
                        <th>××¡' ××‘×—×Ÿ</th>
                        <th>××•×›×œ×•×¡×™×”</th>
                        <th>×‘×•×—×Ÿ</th>
                        <th>×ª×•×¦××”</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="report-section">
            <div class="report-notes-box">
                <strong>×”×¢×¨×•×ª ×›×œ×œ×™×•×ª:</strong>
                <textarea id="reportNotesInput" class="report-notes-textarea" placeholder="×”×•×¡×£ ×”×¢×¨×•×ª ×›×œ×œ×™×•×ª ×›××Ÿ..." oninput="updateReportNotes()"></textarea>
                <div id="reportNotes" class="report-notes-display"></div>
            </div>
        </div>

        <div class="report-signature-section">
            <div class="report-sig-box">
                <div id="reportTesterDetails" class="report-tester-details"></div>
                <div class="sig-line"></div>
                <strong>×¤×¨×˜×™ ×‘×•×—×Ÿ ××—×¨××™</strong>
            </div>
            <div class="report-sig-box">
                <canvas id="reportSigCanvas" width="200" height="80" style="border: 2px dashed #999; cursor: crosshair; background: #fff; touch-action: none;"></canvas>
                <br>
                <button class="btn-clear-report-sig" onclick="clearReportSignature()" style="margin-top: 5px; padding: 5px 15px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">× ×§×” ×—×ª×™××”</button>
                <div class="sig-line" style="margin-top: 10px;"></div>
                <strong>×—×ª×™××ª ×”×‘×•×—×Ÿ</strong>
            </div>
        </div>
    </div>

</div>

<!-- Printable Report - Outside main container for printing -->
<div id="printableReportOuter" class="printable-report-outer"></div>

<!-- Modal ×—×œ×•×§×ª ×¢×‘×•×“×” -->
<div class="modal-overlay" id="distributeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ“Š ×—×œ×•×§×ª ×¢×‘×•×“×” ×‘×™×Ÿ ×‘×•×—× ×™×</h2>
            <button class="modal-close" onclick="closeDistributeModal()">Ã—</button>
        </div>

        <div class="distribute-section">
            <h3>ğŸ‘¥ ×‘×•×—× ×™× ××©×ª×ª×¤×™×:</h3>
            <div id="testersList"></div>
        </div>

        <div class="distribute-section">
            <h3>âš™ï¸ ×”×’×“×¨×•×ª:</h3>
            <div class="distribute-checkbox">
                <input type="checkbox" id="leadTesterLess" checked>
                <label for="leadTesterLess">×‘×•×—×Ÿ ××—×¨××™ (×¨××©×•×Ÿ ×‘×¨×©×™××”) ××§×‘×œ × ×‘×—×Ÿ ××—×“ ×¤×—×•×ª</label>
            </div>
            <div class="distribute-checkbox">
                <input type="checkbox" id="keepSchoolTogether" checked>
                <label for="keepSchoolTogether">×©××•×¨ ×‘×™×ª ×¡×¤×¨ ××¦×œ ××•×ª×• ×‘×•×—×Ÿ (×× ××¤×©×¨)</label>
            </div>
        </div>

        <div class="distribute-section">
            <h3>ğŸ« ×‘×ª×™ ×¡×¤×¨ ×•×›××•×™×•×ª (××˜×‘×œ×ª ×”×ª×›× ×•×Ÿ):</h3>
            <div id="schoolsList"></div>
            <p style="font-size:12px; color:#666; margin-top:10px;">×¡×”"×› × ×‘×—× ×™×: <strong id="totalExaminees">0</strong></p>
        </div>

        <div style="text-align: center;">
            <button onclick="calculateDistribution()" style="background:#9c27b0; color:white; padding:12px 30px; font-size:16px; border:none; border-radius:5px; cursor:pointer;">
                ğŸ”„ ×—×©×‘ ×—×œ×•×§×”
            </button>
        </div>

        <div class="distribute-result" id="distributeResult" style="display:none;">
            <h3>âœ… ×ª×•×¦××ª ×”×—×œ×•×§×”:</h3>
            <div id="distributionOutput"></div>
        </div>
    </div>
</div>

<script>
    // ============ DATA ============
    const schoolMap = {
        "×‘××¨ ×©×‘×¢": ["×©×¨×™×™×‘×¨", "×™×•×‘×œ×™", "×¢×œ ×’×œ×’×œ×™×", "×™×—×“", "××™×¦×™×§", "×‘.×” 6930", "×œ×™×™×Ÿ ×‘×”×“ 6", "××™×—×•×“", "×—×”\"×"],
        "××•×¤×§×™×": ["×‘.×” 6930", "××•×¤×§×™×", "×©×™ ××•×¤×§×™×"],
        "× ×ª×™×‘×•×ª": ["×©×™ ××•×¤×§×™×", "× ×ª×™×‘×•×ª"],
        "×“×™××•× ×”": ["×¢×œ ×’×œ×’×œ×™×", "×“×™××•× ×”", "×¢×™×•×Ÿ"],
        "××©×§×œ×•×Ÿ": ["××™×—×•×“", "××©×§×œ×•×Ÿ", "×‘.×” 6930"],
        "×§×¨×™×ª ×’×ª": ["×“× ×™", "×§×¨×™×ª ×’×ª"],
        "××©×“×•×“": ["×–×”×‘", "××©×“×•×“"],
        "×œ×•×“": ["×‘.×” 6920", "××™×™×œ×•×Ÿ", "×™×•×‘×œ×™", "×¢×œ ×’×œ×’×œ×™×"],
        "×‘×™×ª × ×‘××œ×œ×”": ["×‘.×” 6920", "×¢×™×•×Ÿ", "×‘×™×ª × ×‘××œ×œ×”"],
        "×©×•×”×": ["×‘.×” 6920"],
        "×¦×¨×™×¤×™×Ÿ": ["×‘×”×“ 6", "×¨×™×©×•×™"],
        "×¨×—×•×‘×•×ª": ["×™×•×‘×œ×™", "×¨×—×•×‘×•×ª"],
        "×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ": ["×©×¢×¨ ×¨××©×•×Ÿ", "×©×¨×™×™×‘×¨", "×©×¨×™×™×‘×¨ ××•×¤× ×•×¢×™×"],
        "×™×¤×•": ["×.×¡×œ×¢", "×™×—×“×™×•", "×¨×™×©×•×™", "×©×¨×™×™×‘×¨", "××™×—×•×“", "×™×¤×• ×¢×™×•× ×™"],
        "×ª×œ ××‘×™×‘": ["××™×—×•×“", "×©×¨×™×™×‘×¨"],
        "×¤×ª×— ×ª×§×•×•×”": ["×§×¨×Ÿ", "××“×™", "×©×¨×™×™×‘×¨", "×˜×œ", "××“×¨"],
        "×”×“×¨ ×™×•×¡×£": ["×’×•×œ×Ÿ", "×’×•×¨ ××¨×™×”", "×©×¨×™×™×‘×¨"],
        "× ×ª× ×™×”": ["××•×¨×Ÿ ×ª××™×¨", "×©×’×™×", "×©×¨×™×™×‘×¨"],
        "×—×“×¨×”": ["××•×˜×•", "× ×ª×™×‘", "×©×¨×™×™×‘×¨"],
        "×›×¤×¨ ×¡×‘×": ["×©×¨×™×™×‘×¨", "×˜×•×‘", "×”×“×¨×›×™×"],
        "×—×™×¤×”": ["× ×ª×™×‘", "××•××Ÿ", "×—×™×¤×”", "×‘.×” 6910"],
        "×§×¨×™×ª ×—×™×™×": ["×”×§×¨×™×”", "×’×œ ×™×¨×•×§"],
        "×¢×›×•": ["××¨×’××Ÿ", "×¡××™×¨", "× ×ª×™×‘×™ ×”×’×œ×™×œ"],
        "×¢×¤×•×œ×”": ["×”×—××™×©×”", "×œ×™×Ÿ", "×‘.×” 6910", "×™×”×‘", "×©×¨×™×™×‘×¨"],
        "×‘×™×ª ×©××Ÿ": ["×’×œ×‘×•×¢"],
        "×˜×‘×¨×™×”": ["×”××•×Ÿ"],
        "×§×¨×™×ª ×©××•× ×”": ["×¨×•×××” ×’×œ×™×œ", "× ××¨×•×“ ×¡×¢×¨"],
        "×™×¨×•×©×œ×™×": ["×©×¨×™×™×‘×¨", "×“×¨×›×™×", "×œ×’ ×™×¨×•×©×œ×™×", "×¢×œ ×’×œ×’×œ×™×", "×¢×•×–"],
        "×‘×”×œ×¥": ["×˜×¨×§×˜×•×¨ ×¢×™×•× ×™", "×˜×¨×§×˜×•×¨ ××¢×©×™", "×‘×”×“ 14"],
        "×œ×’ ×ª×œ×©": ["×ª×œ×© ×¢×™×•× ×™"],
        "×‘×™×¡×˜ 21": ["×‘×™×¡×˜"]
    };

    const reasonsDB = {
        "1. ×”×ª×—×œ×ª × ×¡×™×¢×”": ["×“×™××•× ×× ×•×¢ ×—×•×–×¨ ×•× ×©× ×” ×‘×ª×—×™×œ×ª × ×¡×™×¢×”","×”×©×ª×”×•×ª ×™×ª×¨ ×‘×™×¦×™××” ××”××§×•×","×”×ª×—×œ×ª × ×¡×™×¢×” ×§×•×¤×¦× ×™×ª / ×—×•×¡×¨ ×ª××•× ×‘×Ÿ ×××™×¥ ×œ××¦××“"],
        "2. ×©×œ×™×˜×” ×‘×”×’×”": ["××—×™×–×ª ×”×’×” ×©×’×•×™×” / ×¨×¤×•×™×”","×—×•×¡×¨ ×™×¦×™×‘×•×ª ×‘× ×ª×™×‘ (×–×™×’×–×’)","×¡×˜×™×™×” ×× ×ª×™×‘ ×œ×œ× ××™×ª×•×ª ××• ×¦×•×¨×š","×”×¤× ×™×•×ª ×”×’×” ××¢×‘×¨ ×œ× ×“×¨×© (×”×™×’×•×™ ×™×ª×¨/×—×“)","×ª×™×§×•× ×™ ×”×’×” ××•×’×–××™× ×‘×¤× ×™×•×ª"],
        "3. ×©×™××•×© ×‘××¦××“/×’×œ×™×©×”": ["×©×™××•×© ×™×ª×¨/××™×•×ª×¨ ×‘××¦××“","×’×œ×™×©×” ××¡×•×›× ×ª ×œ×ª×•×š ×¦×•××ª","×”×¢×œ××ª ×”×™×œ×•×š ×œ×œ× ×”×¤×¨×“×” (×—×¨×™×§×”)","×¨×’×œ × ×—×” ×¢×œ ×”××¦××“ ×‘×–××Ÿ × ×¡×™×¢×”"],
        "4. ×”×—×œ×¤×ª ×”×™×œ×•×›×™× ×‘××•×¢×“": ["× ×¡×™×¢×” ×‘×”×™×œ×•×š ×œ× ××ª××™× ×œ××”×™×¨×•×ª","××™×—×•×¨ ×‘×”×•×¨×“×ª ×”×™×œ×•×š ×‘×¢×œ×™×”/×¢×¦×™×¨×”","×”×•×¨×“×ª ×¢×™× ×™×™× ×œ×™×“×™×ª ×”×”×™×œ×•×›×™×"],
        "5. ×–×™× ×•×§ ×‘×¢×œ×™×”": ["×–×™× ×•×§ ×‘×¢×œ×™×” - ×”×“×¨×“×¨×•×ª ×œ××—×•×¨ (×”×ª×¢×¨×‘×•×ª)","×—×•×¡×¨ ×©×œ×™×˜×” ×‘× ×§×•×“×ª ×”×—×™×›×•×š (×›×™×‘×•×™ ×× ×•×¢)","×–×™× ×•×§ ×œ× ×–×”×™×¨ / ×§×•×¤×¦× ×™"],
        "6. ×©×™××•×© ×‘×‘×œ× ×¨×’×œ/×™×“": ["×‘×œ×™××” ×¤×ª××•××™×ª ×œ×œ× ×¦×•×¨×š","×‘×œ×™××” ×××•×—×¨×ª ××™×“×™","××™ ×©×—×¨×•×¨ ×‘×œ× ×™×“ ××œ×"],
        "7. ×©×œ×™×˜×” ×›×œ×œ×™×ª ×‘×¨×›×‘": ["×—×•×¡×¨ ×‘×™×˜×—×•×Ÿ ×‘×ª×¤×¢×•×œ ××¢×¨×›×•×ª ×”×¨×›×‘","× ×”×™×’×” ××”×•×¡×¡×ª ×•××™×˜×™×ª ×œ×œ× ×¦×•×¨×š","×—×•×¡×¨ ×©×œ×™×˜×” ×‘××¢×¨×›×•×ª ××©× ×™×•×ª (××™×ª×•×ª/××•×¨×•×ª/××’×‘×™×)"],
        "8. ××™×ª×•×ª": ["××™ ××ª×Ÿ ××™×ª×•×ª ×‘×¤× ×™×•×ª / ××¢×‘×¨ × ×ª×™×‘","××™×ª×•×ª ×œ×¦×“ ×”×¤×•×š","××™×ª×•×ª ×××•×—×¨ ××™×“×™ / ××™ ×‘×™×˜×•×œ ××™×ª×•×ª"],
        "9. × ×¡×™×¢×” ×œ××—×•×¨ (×—× ×™×”)": ["××•×‘×“×Ÿ ×©×œ×™×˜×” ×‘× ×¡×™×¢×” ×œ××—×•×¨ / ×¡×™×›×•×Ÿ ×œ×¨×›×•×©","×—× ×™×” ×‘××§×‘×™×œ ×œ×œ× ×”×¡×ª×›×œ×•×ª ×‘××¨××” ×”×©×××œ×™×ª","×—× ×™×” ×‘× ×™×¦×‘ ×œ×œ× ×”×¡×ª×›×œ×•×ª ×‘××¨××” ×”×©×××œ×™×ª","×¢×œ×™×” ×¢×œ ××“×¨×›×” ×‘××”×œ×š ×—× ×™×” ×œ××—×•×¨","×‘×™×¦×•×¢ ×—× ×™×” ×œ×œ× ×”×¦×œ×—×” / ×–××Ÿ ×¡×‘×™×¨ (××™×§×•× ×œ×§×•×™)","×—×•×¡×¨ ×”×ª××¦××•×ª ×‘××¨×—×‘ / ×™×•×ª×¨ ××™×“×™ ×ª×™×§×•× ×™×"],
        "10. ×¢×¦×™×¨×ª ××˜×¨×”": ["×¢×¦×™×¨×” ×œ× ××“×•×™×§×ª ×‘×§×• ×¢×¦×™×¨×”","×’×œ×™×©×” ××¢×‘×¨ ×œ×§×• ×”×¢×¦×™×¨×”"],
        "11. ×©×™××•×© ×‘×‘×œ××™ ×”××˜×”": ["××™ ×©×™××•×© ×‘×‘×œ× ×¢×–×¨ ×‘×™×¨×™×“×”"],
        "12. ××—×•×•× ×™× ×•××–×”×¨×”": ["×”×ª×¢×œ××•×ª ×× ×•×¨×•×ª ××–×”×¨×” ×‘×œ×•×— ×”×©×¢×•× ×™×"],
        "13. ××‘×™×–×¨×™ ×‘×˜×™×—×•×ª": ["××™ ×—×’×™×¨×ª ×—×’×•×¨×” / ××™ ×›×™×•×•×Ÿ ××¨××•×ª ×•××•×©×‘"],
        "14. × ×¡×™×¢×” ×œ××—×•×¨ ×‘×–×•×•×™×ª": ["×¡×˜×™×™×” ××”× ×ª×™×‘ ×‘× ×¡×™×¢×” ×œ××—×•×¨"],
        "15. ×”×ª×¨×ª ×•×¨×ª×™××ª ×’×¨×•×¨": ["×¡×“×¨ ×¤×¢×•×œ×•×ª ×©×’×•×™/×œ× ×‘×˜×™×—×•×ª×™ ×‘×—×™×‘×•×¨ ×’×¨×•×¨"],
        "16. ×–×”×™×¨×•×ª": ["×¤× ×™×” ×‘×¦×•××ª ×§××¥ ×œ×œ× ×”××˜×” ×•×‘×“×™×§×” ××¡×¤×§×ª (×§×œ×•×ª ×¨××©)","× ×”×™×’×” ×‘×—×•×¡×¨ ×–×”×™×¨×•×ª ×›×œ×œ×™","×—×•×¡×¨ ×ª×©×•××ª ×œ×‘ ×œ× ×¢×©×” ×‘×“×¨×š (×”×ª×¢×¨×‘×•×ª ×œ×× ×™×¢×ª ×ª××•× ×”)"],
        "17. ×”×¡×ª×›×œ×•×ª": ["×”× ×‘×—×Ÿ ××ª×§×¨×‘ ×œ××¢×’×œ ×•×™×•×¦× ×œ×œ× ×‘×“×™×§×” ×œ×™××™×Ÿ/××¨××•×ª","×—×¦×™×™×ª ×¦××ª×™× ×œ×œ× ×‘×“×™×§×” ××•×§×“××ª ×‘×–×¨×•×¢×•×ª ×”×¦×•××ª","××‘×˜ ××§×•×‘×¢ ×œ×¤× ×™× / ××™ ×¡×¨×™×§×ª ×¦××ª×™×","×©×™××•×© ××™× ×™××œ×™ ×‘××¨××•×ª ×‘××¢×‘×¨ × ×ª×™×‘ ×•×œ×§×¨××ª ×¤× ×™×”"],
        "18. ×©×™××•×© ×‘××¨××•×ª": ["×¤× ×™×” ×™××™× ×” ×œ×œ× ×‘×“×™×§×ª ××¨××” ×™×× ×™×ª (×œ×¤× ×™/×‘××”×œ×š/××—×¨×™)","××¢×‘×¨ ×œ× ×ª×™×‘ ×©×××œ ×œ×œ× ×‘×“×™×§×ª ××¨××” ×©×××œ×™×ª","××™ ×©×™××•×© ×‘××¨××•×ª ×œ×¤× ×™ ×‘×œ×™××”/×¤× ×™×”"],
        "19. ×”×©×ª×œ×‘×•×ª ×‘×ª× ×•×¢×”": ["×”× ×‘×—×Ÿ × ×™×¡×” ×œ×”×©×ª×œ×‘ ×•×’×¨× ×œ×¨×›×‘ ××—×¨ ×œ×”××˜/×œ×¡×˜×•×ª","× ×™×¡×™×•×Ÿ ×œ×”×©×ª×œ×‘ ×‘×ª× ×•×¢×” ×‘×›×‘×™×© ×‘×™×Ÿ-×¢×™×¨×•× ×™ ×‘×¦×•×¨×” ××¡×•×›× ×ª","×”×©×ª×œ×‘×•×ª ×‘××¢×’×œ ×ª× ×•×¢×” ×œ×œ× ×”×ª×™×™×—×¡×•×ª ×œ×ª× ×•×¢×” ×‘××¢×’×œ","×’×¨×™××ª ×”×¤×¨×¢×” ×œ×ª× ×•×¢×” ×‘×¢×ª ×”×©×ª×œ×‘×•×ª (×›× ×™×¡×” ×œ×¦×•××ª ×œ× ×¤× ×•×™)","× ×ª×™×‘ ××¡×ª×™×™× - ××™ ×‘×“×™×§×ª ××¨××•×ª ×•×”×©×ª×œ×‘×•×ª ×××•×—×¨×ª"],
        "20. ××ª×Ÿ ×–×›×•×ª ×§×“×™××”": ["××™ ××ª×Ÿ ×–×›×•×ª ×§×“×™××” ×œ×¨×›×‘ ××™××™×Ÿ / ×‘×“×¨×š / ×‘×¦×•××ª","×”× ×‘×—×Ÿ ×œ× ××‘×—×™×Ÿ ×‘×ª× ×•×¢×” ××©×ª×œ×‘×ª ××™××™×Ÿ ×œ××—×¨ ×¤× ×™×” ×©×××œ×”","××™ ××ª×Ÿ ×–×›×•×ª ×§×“×™××” ×œ×ª× ×•×¢×” ×××•×œ ×‘×¤× ×™×” ×©×××œ×”","××™ ××ª×Ÿ ×–×›×•×ª ×§×“×™××” ×‘×¢×ª ×™×¦×™××” ××—× ×™×” / ×¨×•×•×¨×¡"],
        "21. ××”×™×¨×•×ª": ["× ×¡×™×¢×” ×‘××”×™×¨×•×ª ××•×¤×¨×–×ª ×œ×ª× ××™ ×”×“×¨×š","× ×¡×™×¢×” ×‘××”×™×¨×•×ª ×©××™× ×” ×ª×•×××ª ×œ×ª× ××™ ×”×“×¨×š (×’×‘×•×”×” ××“×™)","× ×¡×™×¢×” ××™×˜×™×ª ××™×“×™ ×”××¢×›×‘×ª ×ª× ×•×¢×”"],
        "22. ×§×¦×‘ × ×¡×™×¢×”": ["×§×¦×‘ × ×¡×™×¢×” ××™×˜×™ ×•×”×¡×¡× ×™","×¢×™×›×•×‘ ×”×ª× ×•×¢×” ×©×œ× ×œ×¦×•×¨×š ×‘×›×‘×™×© ×‘×™×Ÿ ×¢×™×¨×•× ×™"],
        "23. ×©××™×¨×ª ×¨×•×•×—": ["××™ ×©××™×¨×ª ×¨×•×•×— ××¨×›×‘ ×•×”×ª× ×•×¢×” ×××•×œ","×”×¦××“×•×ª ××¡×•×›× ×ª ×œ×¨×›×‘ ××œ×¤× ×™× (××™ ×©××™×¨×ª ××¨×—×§)","××™ ×©××™×¨×ª ×¨×•×•×— ×¦×“ ×‘×¢×§×™×¤×”/××¤×’×©"],
        "24. ××•××“×Ÿ ×¨×•×—×‘": ["×”×ª×§×¨×‘×•×ª ××¡×•×›× ×ª ×œ×¨×›×‘ ×—×•× ×” ××™××™×Ÿ (×”×ª×¢×¨×‘×•×ª)","× ×¡×™×¢×” ×§×¨×•×‘×” ××™×“×™ ×œ××“×¨×›×” / ××™ ×ª× ×•×¢×”","××•××“× ×™ ×¨×•×—×‘ ×œ×§×•×™×™× ×‘×“×¨×š ×¦×¨×”"],
        "25. ×¢×§×™×¤×•×ª/× ××§×£": ["×—×•×¡×¨ ×–×”×™×¨×•×ª ×‘×¢×§×™×¤×” / ×”×¤×¨×¢×” ×œ×ª× ×•×¢×” ×××•×œ","×¢×§×™×¤×ª ×¨×›×‘ ×¢×•××“ ×œ×œ× ×‘×“×™×§×ª ××¨××” ×™×× ×™×ª ×‘×—×–×¨×”","×œ× ×©× ×œ×‘ ×©× ×¢×§×£ ×•×œ× ××™×¤×©×¨ ×—×–×¨×” (×”××¦×”)","×¢×§×™×¤×” ×‘×“×¨×š ×œ× ×¤× ×•×™×”/××¡×•×›× ×ª"],
        "26. × ×”×™×’×ª ×œ×™×œ×”/××•×¨×•×ª": ["××™ ×”×“×œ×§×ª ××•×¨×•×ª / ×¡×™× ×•×•×¨ ×¨×›×‘ ×××•×œ"],
        "27. ×™×¨×™×“×” ×œ×©×•×œ": ["×™×¨×™×“×” ××¡×•×›× ×ª ×œ×©×•×œ / ×—×–×¨×” ×œ× ×–×”×™×¨×” ×œ×›×‘×™×©"],
        "28. ×¤× ×™×•×ª ×™××™× ×”": ["×¤× ×™×” ×™××™× ×” ×‘×§×©×ª ×¨×—×‘×” ×•×’×œ×™×©×” ×œ× ×ª×™×‘ × ×’×“×™ (×”×ª×¢×¨×‘×•×ª)","×¢×œ×™×” ×¢×œ ××“×¨×›×” ×‘×¤× ×™×” ×™××™× ×”","×›× ×™×¡×” ×œ× ×ª×™×‘ ×œ× × ×›×•×Ÿ ×‘×¤× ×™×”","×¤× ×™×” ×™××™× ×” ×©×œ× ×¢×¤\"×™ ×”×¡×™××•×Ÿ ×‘×“×¨×š"],
        "29. ×¤× ×™×•×ª ×©×××œ×”": ["× ×™×¡×™×•×Ÿ ×¤× ×™×” ×©×××œ×” ×œ× ×ª×™×‘ ×”× ×’×“×™ (×”×ª×¢×¨×‘×•×ª)","×¤× ×™×” ×©×××œ×” ×‘×§×©×ª ×§×¦×¨×” ××™×“×™ (×¡×™×›×•×Ÿ ××™ ×ª× ×•×¢×”/×ª××¨×•×¨)","×¢×œ×™×” ×¢×œ ××™ ×ª× ×•×¢×” ×‘×¤× ×™×” ×©×××œ×”","×¤× ×™×” ×©×××œ×” ×œ×—×“ ×¡×˜×¨×™ - ×œ× ×œ× ×ª×™×‘ ×”×©×××œ×™","×¤× ×™×” ×©×××œ×” ××—×“ ×¡×˜×¨×™ - ×œ× ××”×¦×“ ×”×©×××œ×™","× ×™×¡×™×•×Ÿ ×œ×¤× ×•×ª ×©×××œ×” ×× ×ª×™×‘ ×œ× × ×›×•×Ÿ"],
        "30. ××™×§×•× ×‘××¤×’×©×™×": ["×—×¦×™×™×ª ×¦×•××ª ×‘×—×•×¡×¨ ×–×”×™×¨×•×ª ×œ×œ× ×‘×§×¨×” ××¡×¤×§×ª","×—×•×¡×¨ ×™×“×¢ ×‘×¡×“×¨×™ ×ª× ×•×¢×” ×‘×¦×•××ª (×–×›×•×ª ×§×“×™××”)","×›× ×™×¡×” ×œ×¦×•××ª ×œ× ×¤× ×•×™ (×—×¡×™××ª ×”×ª× ×•×¢×”)","×¢×¦×™×¨×” ×‘×ª×•×š ×”×¦×•××ª"],
        "31. ××©××¢×ª ×‘× ×ª×™×‘×™×": ["××¢×‘×¨ × ×ª×™×‘ ×œ×œ× ×‘×§×¨×” (×’×¨×™××ª ×”×¤×¨×¢×”)","×¢×–×™×‘×ª × ×ª×™×‘ ×”×™××™×Ÿ ×œ×œ× ×¦×•×¨×š (× ×¡×™×¢×” ×‘×©×××œ)","×”× ×‘×—×Ÿ ×œ× ×—×•×–×¨ ×œ× ×ª×™×‘ ×”×™×× ×™ ×œ××—×¨ ×¤× ×™×”/×¢×§×™×¤×”","××©××¢×ª × ×ª×™×‘×™× ×œ×§×•×™×” ×‘××¢×’×œ ×ª× ×•×¢×”","×¡×˜×™×™×” ×× ×ª×™×‘ ×”× ×¡×™×¢×” / × ×¡×™×¢×” ×¢×œ ×§×• ×”×”×¤×¨×“×”"],
        "32. ×¦×™×•×ª ×œ×ª××¨×•×¨×™×": ["××™ ×¢×¦×™×¨×” ×‘×ª××¨×•×¨ ×¢×¦×•×¨ (×”×ª×¢×¨×‘×•×ª)","××™ ×¦×™×•×ª ×œ×ª××¨×•×¨ ××™×Ÿ ×›× ×™×¡×” / ×—×¥ × ×ª×™×‘"],
        "33. ×¦×™×•×ª ×œ×¨××–×•×¨×™×": ["× ×™×¡×™×•×Ÿ ×œ×¢×‘×•×¨ ×¦×•××ª ×‘××•×¨ ××“×•× (×”×ª×¢×¨×‘×•×ª)","×—×¦×™×™×ª ×§×• ×¢×¦×™×¨×” ×‘××•×¨ ××“×•×/×¦×”×•×‘"],
        "34. × ×¡×™×¢×” ×‘×™××™×Ÿ ×”×“×¨×š": ["××™ ×”×™×¦××“×•×ª ×œ×™××™×Ÿ ×‘×›×‘×™×© ×“×•-×¡×˜×¨×™","× ×¡×™×¢×” ×‘× ×ª×™×‘ ×©×××œ×™ ×©×œ× ×œ×¦×•×¨×š ×¢×§×™×¤×”"],
        "35. ×“×¨×š ×©××™× ×” ×¢×™×¨×•× ×™×ª": ["× ×”×™×’×” ×œ× ××•×ª×××ª ×œ×“×¨×š ×‘×™×Ÿ-×¢×™×¨×•× ×™×ª (××”×™×¨×•×ª/××™×§×•×)"],
        "36. ×”×ª×™×™×—×¡×•×ª ×œ×”×•×œ×›×™ ×¨×’×œ": ["×—×•×¡×¨ ×–×”×™×¨×•×ª ×‘×”×ª×§×¨×‘×•×ª ×œ××¢×‘×¨ ×—×¦×™×”","××™ ××ª×Ÿ ×–×›×•×ª ×§×“×™××” ×œ×”×•×œ×š ×¨×’×œ ×‘××¢×‘×¨ ×—×¦×™×” (×”×ª×¢×¨×‘×•×ª)","×¢×¦×™×¨×” ×‘×ª×—×•× ××¢×‘×¨ ×”×—×¦×™×”"],
        "37. × ×ª×™×‘ ×”××¦×”/×”××˜×”": ["×›× ×™×¡×” ×œ× ×–×”×™×¨×” ×× ×ª×™×‘ ×”××¦×”","×‘×œ×™××” ×‘× ×ª×™×‘ × ×¡×™×¢×” ×œ×¤× ×™ ×›× ×™×¡×” ×œ× ×ª×™×‘ ×”××˜×”"],
        "38. × ×”×™×’×” ×‘×“×¨×š ×¦×¨×”": ["× ×™×¡×™×•×Ÿ ×¤× ×™×” ×©×××œ×” ×œ× ×ª×™×‘ × ×’×“×™ ×‘×“×¨×š ×¦×¨×” (×”×ª×¢×¨×‘×•×ª)","×—×•×¡×¨ ×–×”×™×¨×•×ª ×‘××¤×’×© ×¢× ×¨×›×‘ ×××•×œ ×‘×“×¨×š ×¦×¨×”"],
        "39. ×›×‘×™×© ×¨×˜×•×‘": ["× ×¡×™×¢×” ××”×™×¨×” ××™×“×™ ×œ×ª× ××™ ×”××—×™×–×”"]
    };

    const categoryGroups = {
        "×. ×©×œ×™×˜×” ×‘×¨×›×‘": ["1. ×”×ª×—×œ×ª × ×¡×™×¢×”", "2. ×©×œ×™×˜×” ×‘×”×’×”", "3. ×©×™××•×© ×‘××¦××“/×’×œ×™×©×”", "4. ×”×—×œ×¤×ª ×”×™×œ×•×›×™× ×‘××•×¢×“", "5. ×–×™× ×•×§ ×‘×¢×œ×™×”", "6. ×©×™××•×© ×‘×‘×œ× ×¨×’×œ/×™×“", "7. ×©×œ×™×˜×” ×›×œ×œ×™×ª ×‘×¨×›×‘", "8. ××™×ª×•×ª", "9. × ×¡×™×¢×” ×œ××—×•×¨ (×—× ×™×”)", "10. ×¢×¦×™×¨×ª ××˜×¨×”", "11. ×©×™××•×© ×‘×‘×œ××™ ×”××˜×”", "12. ××—×•×•× ×™× ×•××–×”×¨×”", "13. ××‘×™×–×¨×™ ×‘×˜×™×—×•×ª", "14. × ×¡×™×¢×” ×œ××—×•×¨ ×‘×–×•×•×™×ª", "15. ×”×ª×¨×ª ×•×¨×ª×™××ª ×’×¨×•×¨"],
        "×‘. ×”×ª× ×•×¢×”": ["16. ×–×”×™×¨×•×ª", "17. ×”×¡×ª×›×œ×•×ª", "18. ×©×™××•×© ×‘××¨××•×ª", "19. ×”×©×ª×œ×‘×•×ª ×‘×ª× ×•×¢×”", "20. ××ª×Ÿ ×–×›×•×ª ×§×“×™××”", "21. ××”×™×¨×•×ª", "22. ×§×¦×‘ × ×¡×™×¢×”", "23. ×©××™×¨×ª ×¨×•×•×—", "24. ××•××“×Ÿ ×¨×•×—×‘", "25. ×¢×§×™×¤×•×ª/× ××§×£", "26. × ×”×™×’×ª ×œ×™×œ×”/××•×¨×•×ª", "27. ×™×¨×™×“×” ×œ×©×•×œ"],
        "×’. ×”×“×¨×š": ["28. ×¤× ×™×•×ª ×™××™× ×”", "29. ×¤× ×™×•×ª ×©×××œ×”", "30. ××™×§×•× ×‘××¤×’×©×™×", "31. ××©××¢×ª ×‘× ×ª×™×‘×™×", "32. ×¦×™×•×ª ×œ×ª××¨×•×¨×™×", "33. ×¦×™×•×ª ×œ×¨××–×•×¨×™×", "34. × ×¡×™×¢×” ×‘×™××™×Ÿ ×”×“×¨×š", "35. ×“×¨×š ×©××™× ×” ×¢×™×¨×•× ×™×ª", "36. ×”×ª×™×™×—×¡×•×ª ×œ×”×•×œ×›×™ ×¨×’×œ", "37. × ×ª×™×‘ ×”××¦×”/×”××˜×”", "38. × ×”×™×’×” ×‘×“×¨×š ×¦×¨×”", "39. ×›×‘×™×© ×¨×˜×•×‘"]
    };

    // ============ STATE ============
    let examinees = [];
    let currentExamineeIndex = 0;
    let currentStep = 1;
    let planRows = [];
    let testerRows = [];
    let otherTestersSummaries = [];
    let importedTesters = [];

    // ×××’×¨ ×¤×¨×˜×™ ×‘×•×—× ×™× - ×¤×•× ×§×¦×™×” ×œ××¦×™××ª ×‘×•×—×Ÿ ×’× ×× ×™×© ×”×‘×“×œ×™× ×§×˜× ×™× ×‘×¨×•×•×—×™×
    const testersDB = { "×•×™×˜×œ×™ ×’×™×˜×œ××Ÿ": "×•×™×˜×œ×™ ×’×™×˜×œ××Ÿ<br>×‘×•×—×Ÿ ×¨×™×©×•×™ ×¦×”\"×œ<br>××¡' 3604" };
    function getTesterDetails(name) {
        if (!name) return '';
        const normalized = name.trim().replace(/\s+/g, ' ');
        if (testersDB[normalized]) return testersDB[normalized];
        // ×—×™×¤×•×© ×’××™×©
        for (const key in testersDB) {
            if (key.replace(/\s+/g, ' ').trim() === normalized) {
                return testersDB[key];
            }
        }
        return name;
    }

    // ============ INITIALIZATION ============
    window.onload = function() {
        initAreaSelect();
        initSchoolSelect();
        initTestersCheckboxes();
        loadSavedData();
        // ××ª×—×•×œ ×ª××¨×™×š ×¨×§ ×× ××™×Ÿ × ×ª×•× ×™× ×©××•×¨×™×
        initDateFieldIfEmpty();
        renderPlanTable();
        renderTestersTable();
        buildFailureCategories();
        initSignature();
        // ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×‘×•×—×Ÿ ××—×¨××™ ××”× ×ª×•× ×™× ×”×©××•×¨×™×
        onTesterNamesChanged();
    };

    // ×¨×©×™××ª ×”×‘×•×—× ×™× ×”×§×‘×•×¢×”
    const TESTERS_LIST = [
        '×•×™×˜×œ×™ ×’×™×˜×œ××Ÿ',
        '××œ×œ×•×£ ×™×¦×—×§',
        '××œ×‘×œ×” ××‘×¨×”×',
        '×‘× ×™××™× ×œ×•×™',
        '××œ×›×¡ ×§×•×¨× ×‘×œ×™×˜',
        '×©×¨×•×Ÿ ×¦×¨×™××™',
        '×©××¢×•×Ÿ × ×’××•×§×¨',
        '×™× ×™×¨ × ××•×’××•×§×¨',
        '×“×•×“ ×¤×œ×¡',
        '×¨×•×Ÿ ×™×”×•×“',
        '×“×¨×• ××œ×œ'
    ];

    // ×‘×•×—× ×™× ××•×ª×××™× ××™×©×™×ª ×©× ×•×¡×¤×•
    let customTesters = [];

    // ××ª×—×•×œ checkboxes ×œ×‘×•×—× ×™×
    function initTestersCheckboxes() {
        renderTestersCheckboxes();
    }

    // ×™×¦×™×¨×ª ×”-checkboxes
    function renderTestersCheckboxes() {
        const container = document.getElementById('testersCheckboxes');
        if (!container) return;

        const allTesters = [...TESTERS_LIST, ...customTesters];
        const selectedTesters = getSelectedTesters();

        container.innerHTML = allTesters.map(tester => {
            const isChecked = selectedTesters.includes(tester);
            const checkboxId = 'tester_' + tester.replace(/\s+/g, '_');
            return `
                <label style="display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: ${isChecked ? '#e3f2fd' : 'white'}; border: 1px solid ${isChecked ? '#2196F3' : '#ddd'}; border-radius: 20px; cursor: pointer; font-size: 14px;">
                    <input type="checkbox" id="${checkboxId}" value="${tester}" ${isChecked ? 'checked' : ''} onchange="onTesterCheckboxChange()" style="margin: 0;">
                    ${tester}
                </label>
            `;
        }).join('');
    }

    // ×§×‘×œ×ª ×¨×©×™××ª ×”×‘×•×—× ×™× ×”× ×‘×—×¨×™×
    function getSelectedTesters() {
        const mainTester = document.getElementById('planTester')?.value || '';
        const additional = document.getElementById('additionalTestersNames')?.value || '';

        let testers = [];
        if (mainTester) testers.push(mainTester);
        if (additional) {
            additional.split(',').forEach(t => {
                const name = t.trim();
                if (name && !testers.includes(name)) testers.push(name);
            });
        }
        return testers;
    }

    // ×›×©××©× ×™× checkbox ×©×œ ×‘×•×—×Ÿ
    function onTesterCheckboxChange() {
        const checkboxes = document.querySelectorAll('#testersCheckboxes input[type="checkbox"]:checked');
        const selectedTesters = Array.from(checkboxes).map(cb => cb.value);

        // ×”×¨××©×•×Ÿ ×”×•× ×”×‘×•×—×Ÿ ×”×¨××©×™
        const mainTester = selectedTesters[0] || '';
        const additionalTesters = selectedTesters.slice(1).join(', ');

        document.getElementById('planTester').value = mainTester;
        document.getElementById('additionalTestersNames').value = additionalTesters;

        // ×¢×“×›×Ÿ ××ª ×”×¡×’× ×•×Ÿ ×©×œ ×”-checkboxes
        renderTestersCheckboxes();

        // ×¢×“×›×Ÿ ××ª ×©××¨ ×”××¢×¨×›×ª
        onTesterNamesChanged();
    }

    // ×”×•×¡×¤×ª ×‘×•×—×Ÿ ××•×ª×× ××™×©×™×ª
    function addCustomTester() {
        const input = document.getElementById('customTesterInput');
        const name = input.value.trim();

        if (!name) {
            alert('× × ×œ×”×–×™×Ÿ ×©× ×‘×•×—×Ÿ');
            return;
        }

        // ×‘×“×•×§ ×× ×›×‘×¨ ×§×™×™×
        if (TESTERS_LIST.includes(name) || customTesters.includes(name)) {
            alert('×‘×•×—×Ÿ ×–×” ×›×‘×¨ ×§×™×™× ×‘×¨×©×™××”');
            input.value = '';
            return;
        }

        // ×”×•×¡×£ ×œ×¨×©×™××” ×”××•×ª×××ª ××™×©×™×ª
        customTesters.push(name);
        input.value = '';

        // ×¢×“×›×Ÿ ××ª ×”-checkboxes ×•×¡××Ÿ ××ª ×”×—×“×©
        renderTestersCheckboxes();

        // ×¡××Ÿ ××ª ×”×‘×•×—×Ÿ ×”×—×“×©
        const checkboxId = 'tester_' + name.replace(/\s+/g, '_');
        const checkbox = document.getElementById(checkboxId);
        if (checkbox) {
            checkbox.checked = true;
            onTesterCheckboxChange();
        }

        saveData();
    }

    // ××ª×—×•×œ ×©×“×” ×ª××¨×™×š ×¢× ×ª××¨×™×š ×”×™×•× - ×¨×§ ×× ××™×Ÿ ×ª××¨×™×š ×©××•×¨
    function initDateFieldIfEmpty() {
        const dateInput = document.getElementById('planDateInput');
        const planDate = document.getElementById('planDate');

        // ×× ×›×‘×¨ ×™×© ×ª××¨×™×š (××”× ×ª×•× ×™× ×”×©××•×¨×™×), ×œ× ×œ×©× ×•×ª
        if (planDate.value && planDate.value.trim() !== '') {
            return;
        }

        // ×”×’×“×¨ ×ª××¨×™×š ×”×™×•×
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${yyyy}-${mm}-${dd}`;

        // ×¢×“×›×Ÿ ××ª ×”×©×“×” ×”× ×¡×ª×¨ ×‘×¤×•×¨××˜ dd/mm/yy (×‘×œ×™ ×œ×©××•×¨ - ×›×™ ×–×” ××ª×—×•×œ)
        const yy = String(yyyy).slice(-2);
        planDate.value = `${dd}/${mm}/${yy}`;

        // ×¢×“×›×Ÿ ××ª ×”×™×•× ×‘×©×‘×•×¢
        updateDayOfWeek();
    }

    // ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ×”×ª××¨×™×š ×‘×¤×•×¨××˜ dd/mm/yy
    function updateDateDisplay() {
        const dateInput = document.getElementById('planDateInput');
        const planDate = document.getElementById('planDate');

        if (dateInput.value) {
            const parts = dateInput.value.split('-');
            const yy = parts[0].slice(-2);
            planDate.value = `${parts[2]}/${parts[1]}/${yy}`;
        } else {
            planDate.value = '';
        }

        // ×¢×“×›×Ÿ ××ª ×”×™×•× ×‘×©×‘×•×¢
        updateDayOfWeek();
        saveData();
    }

    // ×¢×“×›×•×Ÿ ×”×™×•× ×‘×©×‘×•×¢ ×œ×¤×™ ×”×ª××¨×™×š
    function updateDayOfWeek() {
        const dateInput = document.getElementById('planDateInput');
        const daySelect = document.getElementById('planDay');

        if (dateInput.value) {
            const date = new Date(dateInput.value);
            const dayOfWeek = date.getDay(); // 0=×¨××©×•×Ÿ, 1=×©× ×™, ...
            const hebrewDays = ['×', '×‘', '×’', '×“', '×”', '×•', '×©'];
            daySelect.value = hebrewDays[dayOfWeek];
        }
    }

    function initAreaSelect() {
        const sel = document.getElementById('planArea');
        sel.innerHTML = '<option value="">×‘×—×¨ ××–×•×¨...</option>';
        Object.keys(schoolMap).sort().forEach(area => {
            sel.innerHTML += `<option value="${area}">${area}</option>`;
        });
        sel.addEventListener('change', function() {
            updateSchoolSelect();
            saveData();
        });
    }

    function initSchoolSelect() {
        updateSchoolSelect();
    }

    function updateSchoolSelect() {
        const area = document.getElementById('planArea').value;
        const schools = schoolMap[area] || [];
        const examSchool = document.getElementById('examSchool');
        examSchool.innerHTML = '<option value="">×‘×—×¨ ×‘×™"×¡...</option>';
        schools.forEach(s => {
            examSchool.innerHTML += `<option value="${s}">${s}</option>`;
        });
    }

    // ××™×œ×•×™ ××•×˜×•××˜×™ ×©×œ ×¡×•×’ ×¨×›×‘ ×•××¡×¤×¨ ×¨×›×‘ ×œ×¤×™ ×‘×™"×¡ ××”×ª×›× ×•×Ÿ
    function onSchoolSelected() {
        const selectedSchool = document.getElementById('examSchool').value;
        const carSelect = document.getElementById('examCarSelect');
        const carManual = document.getElementById('examCarManual');
        const carHidden = document.getElementById('examCar');
        const vehicleTypeSelect = document.getElementById('examVehicleType');

        // × ×§×” ×¨×©×™××ª ×¨×›×‘×™×
        carSelect.innerHTML = '<option value="">-</option>';
        carManual.value = '';
        carHidden.value = '';

        if (!selectedSchool) return;

        // ×—×¤×© ××ª ×›×œ ×”×©×•×¨×•×ª ×©×œ ×‘×™"×¡ ×–×” ×‘×˜×‘×œ×ª ×”×ª×›× ×•×Ÿ
        const matchingRows = planRows.filter(row => row.school === selectedSchool);

        if (matchingRows.length === 0) return;

        // ×‘× ×” ×¨×©×™××ª ××¡×¤×¨×™ ×¨×›×‘ ×™×™×—×•×“×™×™×
        const uniqueCars = [...new Set(matchingRows.map(r => r.carNumber).filter(c => c))];
        uniqueCars.forEach(carNum => {
            carSelect.innerHTML += `<option value="${carNum}">${carNum}</option>`;
        });

        // ×× ×™×© ×¨×§ ××¡×¤×¨ ×¨×›×‘ ××—×“, ×‘×—×¨ ××•×ª×• ××•×˜×•××˜×™×ª
        if (uniqueCars.length === 1) {
            carSelect.value = uniqueCars[0];
            carHidden.value = uniqueCars[0];
        }

        // ×¢×“×›×Ÿ ×“×¨×’×” ×œ×¤×™ ×”×©×•×¨×” ×”×¨××©×•× ×” (××• ×”×™×—×™×“×”)
        if (matchingRows[0].type) {
            vehicleTypeSelect.value = matchingRows[0].type;
        }
    }

    // ×¢×“×›×•×Ÿ ×“×¨×’×” ×›×©×‘×•×—×¨×™× ××¡×¤×¨ ×¨×›×‘ ××”×¨×©×™××”
    function onCarNumberSelected() {
        const carSelect = document.getElementById('examCarSelect');
        const carManual = document.getElementById('examCarManual');
        const carHidden = document.getElementById('examCar');

        // ×¢×“×›×Ÿ ×¢×¨×š ××•×¡×ª×¨
        carHidden.value = carSelect.value;
        carManual.value = ''; // × ×§×” ×©×“×” ×™×“× ×™

        const selectedSchool = document.getElementById('examSchool').value;
        const selectedCar = carSelect.value;
        const vehicleTypeSelect = document.getElementById('examVehicleType');

        if (!selectedSchool || !selectedCar) return;

        // ××¦× ××ª ×”×©×•×¨×” ×”××ª××™××” ×‘×˜×‘×œ×ª ×”×ª×›× ×•×Ÿ
        const matchingRow = planRows.find(row => row.school === selectedSchool && row.carNumber === selectedCar);
        if (matchingRow && matchingRow.type) {
            vehicleTypeSelect.value = matchingRow.type;
        }
    }

    // ×¢×“×›×•×Ÿ ××¡×¤×¨ ×¨×›×‘ ×›×©××§×œ×™×“×™× ×™×“× ×™×ª
    function onCarManualInput() {
        const carSelect = document.getElementById('examCarSelect');
        const carManual = document.getElementById('examCarManual');
        const carHidden = document.getElementById('examCar');

        if (carManual.value) {
            carSelect.value = ''; // × ×§×” ×‘×—×™×¨×” ××¨×©×™××”
            carHidden.value = carManual.value;
        } else if (carSelect.value) {
            carHidden.value = carSelect.value;
        } else {
            carHidden.value = '';
        }
    }

    function loadSavedData() {
        const saved = localStorage.getItem('simple_mode_data');
        if (saved) {
            const data = JSON.parse(saved);

            // ×˜×¢×™× ×ª ×ª××¨×™×š
            if (data.planDate) {
                document.getElementById('planDate').value = data.planDate;
            }
            if (data.planDateInput) {
                document.getElementById('planDateInput').value = data.planDateInput;
            } else if (data.planDate) {
                // ×ª××™××•×ª ×œ××—×•×¨ - ×”××¨×” ×-dd/mm/yy ×œ-yyyy-mm-dd
                const parts = data.planDate.split('/');
                if (parts.length === 3) {
                    const yy = parts[2];
                    const yyyy = yy.length === 2 ? '20' + yy : yy;
                    document.getElementById('planDateInput').value = `${yyyy}-${parts[1]}-${parts[0]}`;
                }
            }

            document.getElementById('planDay').value = data.planDay || '×';
            document.getElementById('planArea').value = data.planArea || '';
            document.getElementById('planTester').value = data.planTester || '';
            document.getElementById('additionalTestersNames').value = data.additionalTestersNames || data.planAdditionalTesters || '';
            document.getElementById('planCount').value = data.planCount || 5;
            document.getElementById('areaCode').value = data.areaCode || '';
            examinees = data.examinees || [];
            planRows = data.planRows || [];
            testerRows = data.testerRows || [];

            // ×˜×¢×Ÿ ×‘×•×—× ×™× ××•×ª×××™× ××™×©×™×ª
            customTesters = data.customTesters || [];

            // ×˜×¢×Ÿ ××¦×‘ ×‘×•×—×Ÿ ××—×¨××™
            if (data.isMainTester) {
                document.getElementById('isMainTester').checked = true;
                document.getElementById('additionalTestersSection').style.display = 'block';
                document.getElementById('otherTestersSection').style.display = 'block';
            }

            // ×˜×¢×Ÿ ×¡×™×›×•××™ ×‘×•×—× ×™× × ×•×¡×¤×™× (×™×©×Ÿ - ×œ×ª××™××•×ª ×œ××—×•×¨)
            otherTestersSummaries = data.otherTestersSummaries || [];

            // ×˜×¢×Ÿ ×‘×•×—× ×™× ××™×•×‘××™× (×—×“×©)
            importedTesters = data.importedTesters || [];

            // ×˜×¢×Ÿ ×©×œ×‘ × ×•×›×—×™ ×•××™×§×•× × ×‘×—×Ÿ
            if (data.currentStep) {
                currentStep = data.currentStep;
            }
            if (data.currentExamineeIndex !== undefined) {
                currentExamineeIndex = data.currentExamineeIndex;
            }

            updateSchoolSelect();

            // ×¢×“×›×Ÿ checkboxes ×©×œ ×‘×•×—× ×™× ××—×¨×™ ×˜×¢×™× ×”
            renderTestersCheckboxes();
        }
        if (planRows.length === 0) {
            planRows = [{school: '', type: '', carNumber: '', countRequested: '', countApproved: '', time: '', notes: ''}];
        }
        if (testerRows.length === 0) {
            testerRows = [{name: '', urban: '', motorcycle: '', urbanManual: false}];
        }
        if (examinees.length === 0) {
            initExaminees();
        }
        // ×¢×“×›×Ÿ ×›××•×™×•×ª ×‘×˜×‘×œ×ª ×”×‘×•×—× ×™× ××—×¨×™ ×˜×¢×™× ×”
        setTimeout(updateTesterCountsFromExaminees, 300);

        // × ×•×•×˜ ×œ×©×œ×‘ ×”×©××•×¨
        setTimeout(() => {
            if (currentStep === 2) {
                goToExams();
            } else if (currentStep === 3) {
                goToSummary();
            }
        }, 100);
    }

    function saveData() {
        const data = {
            planDate: document.getElementById('planDate').value,
            planDateInput: document.getElementById('planDateInput').value,
            planDay: document.getElementById('planDay').value,
            planArea: document.getElementById('planArea').value,
            planTester: document.getElementById('planTester').value,
            additionalTestersNames: document.getElementById('additionalTestersNames').value,
            planCount: document.getElementById('planCount').value,
            areaCode: document.getElementById('areaCode').value,
            examinees: examinees,
            planRows: planRows,
            testerRows: testerRows,
            customTesters: customTesters,
            isMainTester: document.getElementById('isMainTester').checked,
            otherTestersSummaries: otherTestersSummaries,
            importedTesters: importedTesters,
            currentStep: currentStep,
            currentExamineeIndex: currentExamineeIndex
        };
        localStorage.setItem('simple_mode_data', JSON.stringify(data));
    }

    // ×”×¦×’/×”×¡×ª×¨ ×§×˜×¢ ×‘×•×—× ×™× × ×•×¡×¤×™×
    function toggleMainTesterSection() {
        const isMain = document.getElementById('isMainTester').checked;
        document.getElementById('additionalTestersSection').style.display = isMain ? 'block' : 'none';
        document.getElementById('otherTestersSection').style.display = isMain ? 'block' : 'none';
        saveData();
    }

    // ×§×‘×œ×ª ×¨×©×™××ª ×›×œ ×”×‘×•×—× ×™×
    function getAllTesters() {
        const mainTester = document.getElementById('planTester').value.trim();
        const additionalStr = document.getElementById('planAdditionalTesters').value.trim();

        let testers = [];
        if (mainTester) testers.push(mainTester);
        if (additionalStr) {
            const additional = additionalStr.split(',').map(t => t.trim()).filter(t => t);
            testers = testers.concat(additional);
        }
        return testers;
    }

    // ×”×•×¡×¤×ª ×˜×•×¤×¡ ×¡×™×›×•× ×‘×•×—×Ÿ × ×•×¡×£
    function addOtherTesterForm(testerData = null) {
        const container = document.getElementById('otherTestersForms');
        const index = container.children.length;

        const div = document.createElement('div');
        div.className = 'other-tester-form';
        div.style.cssText = 'background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ddd;';
        div.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <input type="text" placeholder="×©× ×”×‘×•×—×Ÿ" class="other-tester-name" value="${testerData?.name || ''}"
                    style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;"
                    onchange="saveOtherTestersSummaries()">
                <button onclick="this.parentElement.parentElement.remove(); saveOtherTestersSummaries();"
                    style="margin-right: 10px; background: #f44336; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer;">âœ•</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; text-align: center; font-size: 12px;">
                <div style="font-weight: bold; grid-column: span 4; background: #4CAF50; color: white; padding: 5px; border-radius: 5px;">×¢×‘×¨×•</div>
                <div>×§×“"×¦</div><div>×•××•×¦'×¨</div><div>×¦×‘×</div><div>×©×•× ×•×ª</div>
                <input type="number" min="0" value="${testerData?.passKadatz || 0}" class="pass-kadatz" onchange="saveOtherTestersSummaries()" style="width: 100%; padding: 5px; text-align: center;">
                <input type="number" min="0" value="${testerData?.passVoucher || 0}" class="pass-voucher" onchange="saveOtherTestersSummaries()" style="width: 100%; padding: 5px; text-align: center;">
                <input type="number" min="0" value="${testerData?.passArmy || 0}" class="pass-army" onchange="saveOtherTestersSummaries()" style="width: 100%; padding: 5px; text-align: center;">
                <input type="number" min="0" value="${testerData?.passOther || 0}" class="pass-other" onchange="saveOtherTestersSummaries()" style="width: 100%; padding: 5px; text-align: center;">
            </div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; text-align: center; font-size: 12px; margin-top: 10px;">
                <div style="font-weight: bold; grid-column: span 4; background: #f44336; color: white; padding: 5px; border-radius: 5px;">× ×›×©×œ×•</div>
                <div>×§×“"×¦</div><div>×•××•×¦'×¨</div><div>×¦×‘×</div><div>×©×•× ×•×ª</div>
                <input type="number" min="0" value="${testerData?.failKadatz || 0}" class="fail-kadatz" onchange="saveOtherTestersSummaries()" style="width: 100%; padding: 5px; text-align: center;">
                <input type="number" min="0" value="${testerData?.failVoucher || 0}" class="fail-voucher" onchange="saveOtherTestersSummaries()" style="width: 100%; padding: 5px; text-align: center;">
                <input type="number" min="0" value="${testerData?.failArmy || 0}" class="fail-army" onchange="saveOtherTestersSummaries()" style="width: 100%; padding: 5px; text-align: center;">
                <input type="number" min="0" value="${testerData?.failOther || 0}" class="fail-other" onchange="saveOtherTestersSummaries()" style="width: 100%; padding: 5px; text-align: center;">
            </div>
        `;
        container.appendChild(div);
    }

    // ×©××™×¨×ª ×¡×™×›×•××™ ×‘×•×—× ×™× × ×•×¡×¤×™×
    function saveOtherTestersSummaries() {
        const forms = document.querySelectorAll('.other-tester-form');
        otherTestersSummaries = [];
        forms.forEach(form => {
            otherTestersSummaries.push({
                name: form.querySelector('.other-tester-name').value,
                passKadatz: parseInt(form.querySelector('.pass-kadatz').value) || 0,
                passVoucher: parseInt(form.querySelector('.pass-voucher').value) || 0,
                passArmy: parseInt(form.querySelector('.pass-army').value) || 0,
                passOther: parseInt(form.querySelector('.pass-other').value) || 0,
                failKadatz: parseInt(form.querySelector('.fail-kadatz').value) || 0,
                failVoucher: parseInt(form.querySelector('.fail-voucher').value) || 0,
                failArmy: parseInt(form.querySelector('.fail-army').value) || 0,
                failOther: parseInt(form.querySelector('.fail-other').value) || 0
            });
        });
        saveData();
    }

    // ×—×™×©×•×‘ ×¡×™×›×•× ×œ×‘×•×—×Ÿ ×”× ×•×›×—×™ (××”× ×‘×—× ×™× ×©×œ×•)
    function getMyTesterSummary() {
        const myName = document.getElementById('planTester').value.trim();
        let summary = {
            name: myName,
            passKadatz: 0, passVoucher: 0, passArmy: 0, passOther: 0,
            failKadatz: 0, failVoucher: 0, failArmy: 0, failOther: 0
        };

        examinees.forEach(ex => {
            if (!ex.firstName && !ex.lastName) return;
            const pop = ex.population || 'other';
            const popKey = pop === 'kadatz' ? 'Kadatz' : pop === 'voucher' ? 'Voucher' : pop === 'army' ? 'Army' : 'Other';

            if (ex.result === 'pass') {
                summary['pass' + popKey]++;
            } else if (ex.result === 'fail') {
                summary['fail' + popKey]++;
            }
        });

        return summary;
    }

    // ×™×¦×™×¨×ª ×§×•×“ ××–×•×¨ ××•×˜×•××˜×™ - ×›×•×œ×œ ×›×œ × ×ª×•× ×™ ×”×ª×›× ×•×Ÿ
    function generateAreaCode() {
        const date = document.getElementById('planDate').value;
        const dateInput = document.getElementById('planDateInput').value;
        const day = document.getElementById('planDay').value;
        const area = document.getElementById('planArea').value;

        if (!date || !area) {
            alert('×™×© ×œ××œ× ×ª××¨×™×š ×•××–×•×¨ ×§×•×“×');
            return;
        }

        // ×‘× ×” ××•×‘×™×™×§×˜ ×¢× ×›×œ × ×ª×•× ×™ ×”×ª×›× ×•×Ÿ
        const planData = {
            v: 1,  // ×’×¨×¡×”
            date: date,
            dateInput: dateInput,
            day: day,
            area: area,
            planRows: planRows.filter(row => row.school || row.carNumber) // ×¨×§ ×©×•×¨×•×ª ×¢× × ×ª×•× ×™×
        };

        // ×§×™×“×•×“ ×œ-Base64
        const jsonStr = JSON.stringify(planData);
        const encoded = btoa(unescape(encodeURIComponent(jsonStr)));

        document.getElementById('areaCode').value = encoded;

        // ×”×¢×ª×§ ×œ×œ×•×—
        navigator.clipboard.writeText(encoded).then(() => {
            alert('âœ… ×”×§×•×“ × ×•×¦×¨ ×•×”×•×¢×ª×§!\n×©×œ×— ××•×ª×• ×‘×•×•××˜×¡××¤ ×œ×‘×•×—× ×™× ×”××—×¨×™×.');
        }).catch(() => {
            alert('âœ… ×”×§×•×“ × ×•×¦×¨!\n×”×¢×ª×§ ××•×ª×• ×•×©×œ×— ×‘×•×•××˜×¡××¤ ×œ×‘×•×—× ×™× ×”××—×¨×™×.');
        });

        saveData();
    }

    // ×˜×¢×™× ×ª ×§×•×“ ××–×•×¨ - ×œ×‘×•×—×Ÿ ×¨×’×™×œ
    function loadAreaCode() {
        const codeInput = document.getElementById('areaCode').value.trim();

        if (!codeInput) {
            alert('×™×© ×œ×”×“×‘×™×§ ×§×•×“ ××–×•×¨ ×§×•×“×');
            return;
        }

        try {
            // ×¤×¢× ×•×— Base64
            const jsonStr = decodeURIComponent(escape(atob(codeInput)));
            const data = JSON.parse(jsonStr);

            if (!data.v || !data.area) {
                throw new Error('×¤×•×¨××˜ ×œ× ×ª×§×™×Ÿ');
            }

            // ××œ× ××ª ×”×©×“×•×ª
            document.getElementById('planDate').value = data.date || '';
            document.getElementById('planDateInput').value = data.dateInput || '';
            document.getElementById('planDay').value = data.day || '×';
            document.getElementById('planArea').value = data.area || '';

            // ×¢×“×›×Ÿ ×¨×©×™××ª ×‘×ª×™ ×¡×¤×¨
            updateSchoolSelect();

            // ××œ× ×˜×‘×œ×ª ×ª×›× ×•×Ÿ
            if (data.planRows && data.planRows.length > 0) {
                planRows = data.planRows;
            }
            renderPlanTable();

            alert('âœ… ×”×§×•×“ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”!\n×”×ª×›× ×•×Ÿ ×”×ª××œ× ××•×˜×•××˜×™×ª.');
            saveData();

        } catch (e) {
            // ××•×œ×™ ×–×” ×§×•×“ ×™×©×Ÿ (×¤×•×¨××˜ DDMMYY-XX)
            if (/^\d{6}-[A-Z]{2}$/.test(codeInput)) {
                alert('×–×”×• ×§×•×“ ×‘×¤×•×¨××˜ ×™×©×Ÿ.\n×”×ª×›× ×•×Ÿ ×œ× ×™×ª××œ× ××•×˜×•××˜×™×ª.');
                return;
            }
            alert('âŒ ×§×•×“ ×œ× ×ª×§×™×Ÿ.\n×‘×“×•×§ ×©×”×¢×ª×§×ª ××ª ×›×œ ×”×§×•×“.');
        }
    }

    // ×™×™×¦×•× × ×ª×•× ×™× - ×œ×©×œ×™×—×” ×œ×‘×•×—×Ÿ ××—×¨××™ (×›×•×œ×œ ×¤×™×¨×•×˜ ×œ×¤×™ ×‘×™"×¡)
    function exportMyData() {
        const areaCode = document.getElementById('areaCode').value.trim();
        const testerName = document.getElementById('planTester').value.trim();

        if (!areaCode) {
            alert('×™×© ×œ×”×–×™×Ÿ ×§×•×“ ××–×•×¨ ××©×•×ª×£');
            return;
        }
        if (!testerName) {
            alert('×™×© ×œ×”×–×™×Ÿ ×©× ×‘×•×—×Ÿ');
            return;
        }

        // ×—×™×©×•×‘ ×¡×™×›×•× ×›×œ×œ×™
        const summary = getMyTesterSummary();
        const totalExams = summary.passKadatz + summary.passVoucher + summary.passArmy + summary.passOther +
                          summary.failKadatz + summary.failVoucher + summary.failArmy + summary.failOther;

        if (totalExams === 0) {
            alert('××™×Ÿ × ×‘×—× ×™× ×¢× ×ª×•×¦××•×ª ×œ×™×™×¦×•×');
            return;
        }

        // ×¤×™×¨×•×˜ ×œ×¤×™ ×‘×™"×¡
        const schoolDetails = {};
        examinees.forEach(ex => {
            if (ex.result) {
                const school = ex.school || '××—×¨';
                if (!schoolDetails[school]) {
                    schoolDetails[school] = {
                        pK: 0, pV: 0, pA: 0, pO: 0,
                        fK: 0, fV: 0, fA: 0, fO: 0
                    };
                }
                const pop = ex.population || 'other';
                const popKey = pop === 'kadatz' ? 'K' : pop === 'voucher' ? 'V' : pop === 'army' ? 'A' : 'O';
                if (ex.result === 'pass') {
                    schoolDetails[school]['p' + popKey]++;
                } else if (ex.result === 'fail') {
                    schoolDetails[school]['f' + popKey]++;
                }
            }
        });

        const exportData = {
            v: 3, // ×’×¨×¡×” ×—×“×©×” - ×¢× ×¤×™×¨×•×˜ ×‘×™"×¡
            code: areaCode,
            tester: testerName,
            summary: {
                pK: summary.passKadatz,
                pV: summary.passVoucher,
                pA: summary.passArmy,
                pO: summary.passOther,
                fK: summary.failKadatz,
                fV: summary.failVoucher,
                fA: summary.failArmy,
                fO: summary.failOther
            },
            schools: schoolDetails
        };

        // ×§×™×“×•×“ ×œ-Base64 ××§×•×¦×¨
        const jsonStr = JSON.stringify(exportData);
        const encoded = btoa(unescape(encodeURIComponent(jsonStr)));

        // ×”×¢×ª×§ ×œ×œ×•×—
        navigator.clipboard.writeText(encoded).then(() => {
            const status = document.getElementById('exportStatus');
            status.style.display = 'block';
            const totalPass = summary.passKadatz + summary.passVoucher + summary.passArmy + summary.passOther;
            const totalFail = summary.failKadatz + summary.failVoucher + summary.failArmy + summary.failOther;
            status.innerHTML = `<div style="background: #4CAF50; color: white; padding: 10px; border-radius: 5px;">
                âœ… ×”×•×¢×ª×§! ×©×œ×— ×‘×•×•××˜×¡××¤ ×œ×‘×•×—×Ÿ ×”××—×¨××™<br>
                <small>(×¡×”"×›: ${totalExams} ××‘×—× ×™× - ${totalPass} ×¢×‘×¨×•, ${totalFail} × ×›×©×œ×•)</small>
            </div>`;
        }).catch(() => {
            // ×× ×œ× ×¢×•×‘×“, ×”×¦×’ ×‘×ª×™×‘×ª ×˜×§×¡×˜
            prompt('×”×¢×ª×§ ××ª ×”×˜×§×¡×˜ ×”×–×” ×•×©×œ×— ×œ×‘×•×—×Ÿ ×”××—×¨××™:', encoded);
        });
    }

    // ×™×™×‘×•× × ×ª×•× ×™× - ×œ×‘×•×—×Ÿ ××—×¨××™ (×¡×™×›×•× ×‘×œ×‘×“)
    function importTesterData() {
        const text = document.getElementById('importDataText').value.trim();
        const myAreaCode = document.getElementById('areaCode').value.trim();
        const status = document.getElementById('importStatus');

        if (!text) {
            status.innerHTML = '<span style="color: red;">×™×© ×œ×”×“×‘×™×§ × ×ª×•× ×™×</span>';
            return;
        }

        try {
            // ×¤×¢× ×•×— Base64
            const jsonStr = decodeURIComponent(escape(atob(text)));
            const data = JSON.parse(jsonStr);

            // ×‘×“×™×§×ª ×§×•×“ ××–×•×¨
            if (myAreaCode && data.code !== myAreaCode) {
                if (!confirm(`×§×•×“ ×”××–×•×¨ ×œ× ×ª×•××!\n×©×œ×š: ${myAreaCode}\n×”×ª×§×‘×œ: ${data.code}\n\n×œ×™×™×‘× ×‘×›×œ ×–××ª?`)) {
                    return;
                }
            }

            // ×‘×“×•×§ ×× ×”×‘×•×—×Ÿ ×›×‘×¨ ×™×•×‘×
            const existingIdx = importedTesters.findIndex(t => t.tester === data.tester);
            if (existingIdx >= 0) {
                if (!confirm(`× ×ª×•× ×™× ×"${data.tester}" ×›×‘×¨ ×§×™×™××™×. ×œ×”×—×œ×™×£?`)) {
                    return;
                }
                importedTesters.splice(existingIdx, 1);
            }

            // ×ª××™×›×” ×‘×’×¨×¡××•×ª ×©×•× ×•×ª
            let summary;
            let schools = null;

            if (data.v === 3 && data.summary) {
                // ×’×¨×¡×” 3 - ×¢× ×¤×™×¨×•×˜ ×‘×™"×¡
                summary = {
                    passKadatz: data.summary.pK || 0,
                    passVoucher: data.summary.pV || 0,
                    passArmy: data.summary.pA || 0,
                    passOther: data.summary.pO || 0,
                    failKadatz: data.summary.fK || 0,
                    failVoucher: data.summary.fV || 0,
                    failArmy: data.summary.fA || 0,
                    failOther: data.summary.fO || 0
                };
                // ×”××¨ ×¤×™×¨×•×˜ ×‘×™"×¡ ×œ×¤×•×¨××˜ ××œ×
                if (data.schools) {
                    schools = {};
                    for (const school in data.schools) {
                        const s = data.schools[school];
                        schools[school] = {
                            passKadatz: s.pK || 0,
                            passVoucher: s.pV || 0,
                            passArmy: s.pA || 0,
                            passOther: s.pO || 0,
                            failKadatz: s.fK || 0,
                            failVoucher: s.fV || 0,
                            failArmy: s.fA || 0,
                            failOther: s.fO || 0
                        };
                    }
                }
            } else if (data.v === 2 && data.summary) {
                // ×’×¨×¡×” 2 - ×¡×™×›×•× ×‘×œ×‘×“
                summary = {
                    passKadatz: data.summary.pK || 0,
                    passVoucher: data.summary.pV || 0,
                    passArmy: data.summary.pA || 0,
                    passOther: data.summary.pO || 0,
                    failKadatz: data.summary.fK || 0,
                    failVoucher: data.summary.fV || 0,
                    failArmy: data.summary.fA || 0,
                    failOther: data.summary.fO || 0
                };
            } else if (data.examinees) {
                // ×’×¨×¡×” ×™×©× ×” - ×—×©×‘ ×¡×™×›×•× ××”× ×‘×—× ×™×
                summary = {
                    passKadatz: 0, passVoucher: 0, passArmy: 0, passOther: 0,
                    failKadatz: 0, failVoucher: 0, failArmy: 0, failOther: 0
                };
                data.examinees.forEach(ex => {
                    const pop = ex.pop || 'other';
                    const popKey = pop === 'kadatz' ? 'Kadatz' : pop === 'voucher' ? 'Voucher' : pop === 'army' ? 'Army' : 'Other';
                    if (ex.res === 'pass') {
                        summary['pass' + popKey]++;
                    } else if (ex.res === 'fail') {
                        summary['fail' + popKey]++;
                    }
                });
            } else {
                throw new Error('×¤×•×¨××˜ ×œ× ××•×›×¨');
            }

            // ×”×•×¡×£ ×œ×¨×©×™××ª ×”×‘×•×—× ×™× ×”××™×•×‘××™× (×¢× ×¡×™×›×•× ×•×¤×™×¨×•×˜ ×‘×™"×¡ ×× ×§×™×™×)
            importedTesters.push({
                tester: data.tester,
                summary: summary,
                schools: schools
            });

            // × ×§×” ×©×“×” ×”×§×œ×˜
            document.getElementById('importDataText').value = '';

            // ×¢×“×›×Ÿ ×ª×¦×•×’×”
            renderImportedTesters();
            saveData();

            const totalPass = summary.passKadatz + summary.passVoucher + summary.passArmy + summary.passOther;
            const totalFail = summary.failKadatz + summary.failVoucher + summary.failArmy + summary.failOther;
            const total = totalPass + totalFail;
            status.innerHTML = `<span style="color: green;">âœ… ×™×•×‘× ×¡×™×›×•× ×"${data.tester}" (${total} ××‘×—× ×™×: ${totalPass} ×¢×‘×¨×•, ${totalFail} × ×›×©×œ×•)</span>`;

        } catch (e) {
            status.innerHTML = '<span style="color: red;">âŒ ×©×’×™××” ×‘×§×¨×™××ª ×”× ×ª×•× ×™× - ×•×“× ×©×”×¢×ª×§×ª × ×›×•×Ÿ</span>';
            console.error(e);
        }
    }

    // ×”×¦×’×ª ×¨×©×™××ª ×‘×•×—× ×™× ×©×™×•×‘××•
    function renderImportedTesters() {
        const container = document.getElementById('importedTestersList');
        if (importedTesters.length === 0) {
            container.innerHTML = '';
            return;
        }

        let html = '<h4 style="margin: 10px 0 5px 0; color: #2e7d32;">×‘×•×—× ×™× ×©×™×•×‘××•:</h4>';
        importedTesters.forEach((t, idx) => {
            let passCount, failCount, total;
            if (t.summary) {
                // ×’×¨×¡×” ×—×“×©×” - ×¡×™×›×•×
                passCount = t.summary.passKadatz + t.summary.passVoucher + t.summary.passArmy + t.summary.passOther;
                failCount = t.summary.failKadatz + t.summary.failVoucher + t.summary.failArmy + t.summary.failOther;
                total = passCount + failCount;
            } else if (t.examinees) {
                // ×ª××™××•×ª ×œ××—×•×¨ - ×¨×©×™××ª × ×‘×—× ×™×
                passCount = t.examinees.filter(e => e.result === 'pass').length;
                failCount = t.examinees.filter(e => e.result === 'fail').length;
                total = t.examinees.length;
            }
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px; border-radius: 5px; margin-bottom: 5px;">
                    <div>
                        <strong>${t.tester}</strong>
                        <span style="color: #666; font-size: 12px;">(${total} ××‘×—× ×™×: ${passCount} âœ“ / ${failCount} âœ—)</span>
                    </div>
                    <button onclick="removeImportedTester(${idx})" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">×”×¡×¨</button>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // ×”×¡×¨×ª ×‘×•×—×Ÿ ××™×•×‘×
    function removeImportedTester(idx) {
        importedTesters.splice(idx, 1);
        renderImportedTesters();
        saveData();
    }

    // ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×‘×•×—× ×™× ×‘-select ×©×œ ×”× ×‘×—×Ÿ
    function updateTesterSelect() {
        const testers = getAllTesters();
        const examTester = document.getElementById('examTester');
        const currentValue = examTester.value;

        examTester.innerHTML = '<option value="">×‘×—×¨ ×‘×•×—×Ÿ...</option>';
        testers.forEach(t => {
            examTester.innerHTML += `<option value="${t}">${t}</option>`;
        });

        // ×©×—×–×¨ ×¢×¨×š ×§×•×“× ×× ×§×™×™×
        if (currentValue && testers.includes(currentValue)) {
            examTester.value = currentValue;
        } else if (testers.length === 1) {
            // ×× ×™×© ×¨×§ ×‘×•×—×Ÿ ××—×“, ×‘×—×¨ ××•×ª×• ××•×˜×•××˜×™×ª
            examTester.value = testers[0];
        }
    }

    function initExaminees() {
        const count = parseInt(document.getElementById('planCount').value) || 5;
        examinees = [];
        for (let i = 0; i < count; i++) {
            examinees.push({
                firstName: '',
                lastName: '',
                id: '',
                school: '',
                car: '',
                vehicleType: 'B',
                population: '', // kadatz, voucher, army, other
                examNumber: '', // ××¡×¤×¨ ××‘×—×Ÿ 1-10
                tester: '', // ×©× ×”×‘×•×—×Ÿ ×©×‘×—×Ÿ ××ª ×”× ×‘×—×Ÿ
                result: null, // null, 'pass', 'fail'
                failureData: null // {marks: {}, notes: '', signature: ''}
            });
        }
    }

    // ============ PLANNING TABLE ============
    function renderPlanTable() {
        const tbody = document.getElementById('planTableBody');
        tbody.innerHTML = '';
        const area = document.getElementById('planArea').value;
        const schools = schoolMap[area] || [];
        let schoolOptions = '<option value="">×‘×—×¨...</option>';
        schools.forEach(s => schoolOptions += `<option value="${s}">${s}</option>`);

        planRows.forEach((row, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><select onchange="updatePlanRow(${idx}, 'school', this.value)">${schoolOptions}</select></td>
                <td>
                    <select onchange="updatePlanRow(${idx}, 'type', this.value)">
                        <option value="">-</option>
                        <option value="B">B</option>
                        <option value="C1">C1</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="A">A</option>
                        <option value="A1">A1</option>
                        <option value="A2">A2</option>
                        <option value="1">1</option>
                        <option value="E">E</option>
                    </select>
                </td>
                <td><input type="text" value="${row.carNumber || ''}" onchange="updatePlanRow(${idx}, 'carNumber', this.value)" placeholder="××¡' ×¨×›×‘" style="width: 80px;"></td>
                <td><input type="number" min="1" max="20" value="${row.countRequested || ''}" onchange="updatePlanRow(${idx}, 'countRequested', this.value)" style="width: 45px;"></td>
                <td><input type="number" min="1" max="20" value="${row.countApproved || ''}" onchange="updatePlanRow(${idx}, 'countApproved', this.value)" style="width: 45px;"></td>
                <td><input type="number" min="1" max="20" value="${row.countActual || ''}" onchange="updatePlanRow(${idx}, 'countActual', this.value)" style="width: 45px;"></td>
                <td><input type="time" value="${row.time || ''}" onchange="updatePlanRow(${idx}, 'time', this.value)"></td>
                <td><input type="text" value="${row.notes || ''}" onchange="updatePlanRow(${idx}, 'notes', this.value)" placeholder="×”×¢×¨×•×ª" style="width: 80px;"></td>
            `;
            // Set saved values
            const selects = tr.querySelectorAll('select');
            if (row.school) selects[0].value = row.school;
            if (row.type) selects[1].value = row.type;
            tbody.appendChild(tr);
        });
    }

    function updatePlanRow(idx, field, value) {
        planRows[idx][field] = value;
        saveData();
    }

    function addPlanRow() {
        planRows.push({school: '', type: '', carNumber: '', countRequested: '', countApproved: '', countActual: '', time: '', notes: ''});
        renderPlanTable();
        saveData();
    }

    function removePlanRow() {
        if (planRows.length > 1) {
            planRows.pop();
            renderPlanTable();
            saveData();
        }
    }

    // ============ TESTERS TABLE ============
    function renderTestersTable() {
        const tbody = document.getElementById('testersTableBody');
        if (!tbody) return;
        tbody.innerHTML = '';

        // ×‘× ×” ×¨×©×™××ª ×‘×•×—× ×™× ××”×©×“×•×ª
        const testerOptions = getTesterOptions();

        testerRows.forEach((row, idx) => {
            const tr = document.createElement('tr');

            // ×‘× ×” dropdown ×œ×‘×•×—× ×™×
            let selectHtml = `<select onchange="updateTesterRow(${idx}, 'name', this.value)" style="width: 100%; padding: 5px;">`;
            selectHtml += `<option value="">×‘×—×¨ ×‘×•×—×Ÿ...</option>`;
            testerOptions.forEach(name => {
                const selected = row.name === name ? 'selected' : '';
                selectHtml += `<option value="${name}" ${selected}>${name}</option>`;
            });
            selectHtml += `</select>`;

            // ×× ×œ× ×™×“× ×™, ×—×©×‘ ××•×˜×•××˜×™×ª
            let urbanValue = row.urban || '';
            const urbanStyle = row.urbanManual ? 'background: #fff3e0;' : '';
            const urbanTitle = row.urbanManual ? 'title="×¢×•×“×›×Ÿ ×™×“× ×™×ª - ×œ×—×¥ ×¤×¢××™×™× ×œ××™×¤×•×¡"' : 'title="××—×•×©×‘ ××•×˜×•××˜×™×ª ××”× ×‘×—× ×™×"';

            tr.innerHTML = `
                <td>${selectHtml}</td>
                <td><input type="number" min="0" max="10" value="${urbanValue}" onchange="updateTesterRow(${idx}, 'urban', this.value)" ondblclick="resetUrbanToAuto(${idx})" ${urbanTitle} style="width: 50px; ${urbanStyle}"></td>
                <td><input type="number" min="0" max="10" value="${row.motorcycle || ''}" onchange="updateTesterRow(${idx}, 'motorcycle', this.value)" style="width: 50px;"></td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ××—×–×™×¨ ×¨×©×™××ª ×‘×•×—× ×™× ××”×©×“×•×ª ×©× ×”×‘×•×—×Ÿ ×•×‘×•×—× ×™× × ×•×¡×¤×™×
    function getTesterOptions() {
        const testers = [];

        // ×”×‘×•×—×Ÿ ×”×¨××©×™
        const mainTester = document.getElementById('planTester')?.value?.trim();
        if(mainTester) testers.push(mainTester);

        // ×‘×•×—× ×™× × ×•×¡×¤×™×
        const additionalTesters = document.getElementById('additionalTestersNames')?.value;
        if(additionalTesters) {
            additionalTesters.split(',').forEach(t => {
                const name = t.trim();
                if(name && !testers.includes(name)) testers.push(name);
            });
        }

        return testers;
    }

    // ×›×©××©× ×™× ××ª ×©××•×ª ×”×‘×•×—× ×™× - ×¢×“×›×Ÿ ××ª ×”×˜×‘×œ×” ×•××ª ×¤×¨×˜×™ ×”×‘×•×—×Ÿ
    function onTesterNamesChanged() {
        renderTestersTable();
        saveData();

        // ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×‘×•×—×Ÿ ××—×¨××™ - ×©×™××•×© ×‘-innerHTML ×¢× br ×œ×ª××™×›×” ×‘×˜××‘×œ×˜
        const mainTester = document.getElementById('planTester').value.trim();
        const testerDetailsEl = document.getElementById('reportTesterDetails');
        if (testerDetailsEl && mainTester) {
            testerDetailsEl.innerHTML = getTesterDetails(mainTester);
        } else if (testerDetailsEl) {
            testerDetailsEl.innerHTML = '';
        }
    }

    function updateTesterRow(idx, field, value) {
        // ×× ×–×” ×¢×“×›×•×Ÿ ×™×“× ×™ ×©×œ ×¢×™×¨×•× ×™, ×¡××Ÿ ×›×™×“× ×™
        if(field === 'urban') {
            testerRows[idx].urbanManual = true;
        }
        testerRows[idx][field] = value;
        saveData();
    }

    function addTesterRow() {
        testerRows.push({name: '', urban: '', motorcycle: '', urbanManual: false});
        renderTestersTable();
        saveData();
    }

    function removeTesterRow() {
        if (testerRows.length > 1) {
            testerRows.pop();
            renderTestersTable();
            saveData();
        }
    }

    // ×—×™×©×•×‘ ×›××•×™×•×ª × ×‘×—× ×™× ×œ×›×œ ×‘×•×—×Ÿ ×•×¢×“×›×•×Ÿ ×˜×‘×œ×ª ×”×‘×•×—× ×™×
    function updateTesterCountsFromExaminees() {
        // ×¡×¤×•×¨ × ×‘×—× ×™× ×œ×›×œ ×‘×•×—×Ÿ ××¨×©×™××ª ×”× ×‘×—× ×™×
        const testerCounts = {};
        examinees.forEach(ex => {
            if(ex.tester && (ex.firstName || ex.lastName || ex.id)) {
                // ×¡×•×¤×¨ ×¨×§ × ×‘×—× ×™× ×¢× ×œ×¤×—×•×ª ×©×“×” ××—×“ ××œ×
                testerCounts[ex.tester] = (testerCounts[ex.tester] || 0) + 1;
            }
        });

        // ×¢×“×›×Ÿ ××ª ×¢××•×“×ª "×¢×™×¨×•× ×™" ×‘×˜×‘×œ×ª ×”×‘×•×—× ×™×
        let changed = false;
        testerRows.forEach((row, idx) => {
            if(row.name && !row.urbanManual) {
                const count = testerCounts[row.name] || 0;
                if(row.urban != count) {
                    row.urban = count > 0 ? count : '';
                    changed = true;
                }
            }
        });

        if(changed) {
            renderTestersTable();
            saveData();
        }
    }

    // ××™×¤×•×¡ ×¢××•×“×ª ×¢×™×¨×•× ×™ ×œ×—×™×©×•×‘ ××•×˜×•××˜×™
    function resetUrbanToAuto(idx) {
        testerRows[idx].urbanManual = false;
        testerRows[idx].urban = '';
        updateTesterCountsFromExaminees();
    }

    // ============ FAILURE FORM ============
    function buildFailureCategories() {
        const container = document.getElementById('failureCategories');
        container.innerHTML = '';

        Object.keys(categoryGroups).forEach(groupName => {
            const category = document.createElement('div');
            category.className = 'failure-category';

            const header = document.createElement('div');
            header.className = 'category-header';
            header.innerHTML = `<span>${groupName}</span><span>â–¼</span>`;
            header.onclick = function() {
                const content = this.nextElementSibling;
                content.classList.toggle('open');
                this.querySelector('span:last-child').textContent = content.classList.contains('open') ? 'â–²' : 'â–¼';
            };

            const content = document.createElement('div');
            content.className = 'category-content';

            categoryGroups[groupName].forEach(itemName => {
                const item = document.createElement('div');
                item.className = 'failure-item';
                item.dataset.item = itemName;

                const cleanName = itemName.replace(/^\d+\.\s*/, '');

                item.innerHTML = `
                    <span class="failure-item-text">${cleanName}</span>
                    <div class="failure-item-buttons">
                        <button class="btn-mark" onclick="markItem(this, 'v')">âœ“</button>
                        <button class="btn-mark" onclick="markItem(this, 'x')">âœ—</button>
                        <button class="btn-mark" onclick="markItem(this, 'ox')">âŠ—</button>
                    </div>
                `;

                // Add reasons dropdown
                if (reasonsDB[itemName]) {
                    const reasonsDiv = document.createElement('div');
                    reasonsDiv.className = 'reasons-dropdown';
                    reasonsDiv.dataset.item = itemName;
                    reasonsDB[itemName].forEach(reason => {
                        const chip = document.createElement('span');
                        chip.className = 'reason-chip';
                        chip.textContent = reason;
                        chip.onclick = function() {
                            this.classList.toggle('selected');
                            updateNotes();
                        };
                        reasonsDiv.appendChild(chip);
                    });
                    item.appendChild(reasonsDiv);
                }

                content.appendChild(item);
            });

            category.appendChild(header);
            category.appendChild(content);
            container.appendChild(category);
        });
    }

    function markItem(btn, mark) {
        const buttons = btn.parentElement.querySelectorAll('.btn-mark');
        const wasSelected = btn.classList.contains('selected-' + mark);

        // Clear all marks
        buttons.forEach(b => {
            b.classList.remove('selected-v', 'selected-x', 'selected-ox');
        });

        // Find reasons dropdown
        const item = btn.closest('.failure-item');
        const reasonsDiv = item.querySelector('.reasons-dropdown');

        if (wasSelected) {
            // Unselect
            if (reasonsDiv) reasonsDiv.classList.remove('open');
        } else {
            // Select
            btn.classList.add('selected-' + mark);
            if ((mark === 'x' || mark === 'ox') && reasonsDiv) {
                reasonsDiv.classList.add('open');
            } else if (reasonsDiv) {
                reasonsDiv.classList.remove('open');
            }
        }
        updateNotes();
    }

    function updateNotes() {
        let notes = '';
        document.querySelectorAll('.failure-item').forEach(item => {
            const xBtn = item.querySelector('.btn-mark.selected-x, .btn-mark.selected-ox');
            if (xBtn) {
                const itemText = item.querySelector('.failure-item-text').textContent;
                const reasonsDiv = item.querySelector('.reasons-dropdown');
                let selectedReasons = [];
                if (reasonsDiv) {
                    reasonsDiv.querySelectorAll('.reason-chip.selected').forEach(chip => {
                        selectedReasons.push(chip.textContent);
                    });
                }
                if (selectedReasons.length > 0) {
                    notes += `â€¢ ${itemText}: ${selectedReasons.join(', ')}\n`;
                } else {
                    notes += `â€¢ ${itemText}\n`;
                }
            }
        });
        document.getElementById('failureNotes').value = notes;
    }

    // ============ SIGNATURE ============
    let sigCanvas, sigCtx, sigDrawing = false;

    function initSignature() {
        sigCanvas = document.getElementById('sigCanvas');
        sigCtx = sigCanvas.getContext('2d');

        function getPos(e) {
            const rect = sigCanvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            return {x, y};
        }

        sigCanvas.addEventListener('mousedown', (e) => {
            sigDrawing = true;
            sigCtx.beginPath();
            sigCtx.moveTo(getPos(e).x, getPos(e).y);
        });
        sigCanvas.addEventListener('mousemove', (e) => {
            if (!sigDrawing) return;
            sigCtx.lineTo(getPos(e).x, getPos(e).y);
            sigCtx.stroke();
        });
        sigCanvas.addEventListener('mouseleave', () => sigDrawing = false);

        sigCanvas.addEventListener('touchstart', (e) => {
            sigDrawing = true;
            sigCtx.beginPath();
            sigCtx.moveTo(getPos(e).x, getPos(e).y);
            e.preventDefault();
        });
        sigCanvas.addEventListener('touchmove', (e) => {
            if (!sigDrawing) return;
            sigCtx.lineTo(getPos(e).x, getPos(e).y);
            sigCtx.stroke();
            e.preventDefault();
        });
        sigCanvas.addEventListener('touchend', () => {
            sigDrawing = false;
            // ×©××•×¨ ×—×ª×™××”
            localStorage.setItem('simple_mode_signature', sigCanvas.toDataURL());
        });
        sigCanvas.addEventListener('mouseup', () => {
            sigDrawing = false;
            // ×©××•×¨ ×—×ª×™××”
            localStorage.setItem('simple_mode_signature', sigCanvas.toDataURL());
        });

        // ×˜×¢×Ÿ ×—×ª×™××” ×©××•×¨×”
        const savedSig = localStorage.getItem('simple_mode_signature');
        if (savedSig) {
            const img = new Image();
            img.onload = () => sigCtx.drawImage(img, 0, 0);
            img.src = savedSig;
        }
    }

    function clearSignature() {
        sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
        localStorage.removeItem('simple_mode_signature');
    }

    // ============ NAVIGATION ============
    function goToPlanning() {
        currentStep = 1;
        showSection('planning');
        updateStepIndicators(1);
        saveData();
    }

    function goToExams() {
        currentStep = 2;
        // Update examinee count if changed
        const newCount = parseInt(document.getElementById('planCount').value) || 5;
        if (newCount !== examinees.length) {
            // Preserve existing data
            const oldData = [...examinees];
            examinees = [];
            for (let i = 0; i < newCount; i++) {
                if (oldData[i]) {
                    examinees.push(oldData[i]);
                } else {
                    examinees.push({
                        firstName: '',
                        lastName: '',
                        id: '',
                        school: '',
                        car: '',
                        vehicleType: 'B',
                        population: '',
                        examNumber: '',
                        tester: '',
                        result: null,
                        failureData: null
                    });
                }
            }
        }
        saveData();
        showSection('exams');
        updateStepIndicators(2);
        updateTesterSelect(); // ×¢×“×›×Ÿ ×¨×©×™××ª ×‘×•×—× ×™×
        renderProgressDots();
        loadExaminee(currentExamineeIndex);
    }

    function goToSummary() {
        currentStep = 3;
        showSection('summary');
        updateStepIndicators(3);
        renderSummary();
        generateWhatsAppButtons();
        saveData();

        // ×”×¦×’ ×§×˜×¢ ×‘×•×—× ×™× × ×•×¡×¤×™× ×¨×§ ×× ××¡×•××Ÿ ×›×‘×•×—×Ÿ ××—×¨××™
        const isMainTester = document.getElementById('isMainTester').checked;
        document.getElementById('otherTestersSection').style.display = isMainTester ? 'block' : 'none';

        // ×”×¦×’ ×¨×©×™××ª ×‘×•×—× ×™× ××™×•×‘××™×
        renderImportedTesters();
    }

    function showSection(name) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('section-' + name).classList.add('active');
    }

    function updateStepIndicators(step) {
        document.querySelectorAll('.step-indicator').forEach((ind, i) => {
            ind.classList.remove('active', 'completed');
            if (i + 1 < step) ind.classList.add('completed');
            if (i + 1 === step) ind.classList.add('active');
        });
    }

    // ============ EXAMINEE HANDLING ============
    function renderProgressDots() {
        const container = document.getElementById('progressDots');
        container.innerHTML = '';
        examinees.forEach((ex, i) => {
            const dot = document.createElement('div');
            dot.className = 'dot';
            if (i === currentExamineeIndex) dot.classList.add('current');
            if (ex.result === 'pass') dot.classList.add('passed');
            if (ex.result === 'fail') {
                if (ex.failureData) {
                    dot.classList.add('failed');
                } else {
                    dot.classList.add('failed-no-form');
                }
            }
            dot.onclick = () => {
                saveCurrentExaminee();
                currentExamineeIndex = i;
                loadExaminee(i);
                renderProgressDots();
            };
            container.appendChild(dot);
        });
    }

    function loadExaminee(index) {
        const ex = examinees[index];
        document.getElementById('examineeNumber').textContent = `× ×‘×—×Ÿ ${index + 1} ××ª×•×š ${examinees.length}`;
        document.getElementById('examFirstName').value = ex.firstName;
        document.getElementById('examLastName').value = ex.lastName;
        document.getElementById('examID').value = ex.id;
        document.getElementById('examSchool').value = ex.school;

        // ×¢×“×›×Ÿ ×¨×©×™××ª ××¡×¤×¨×™ ×¨×›×‘ ×œ×¤×™ ×‘×™×ª ×”×¡×¤×¨ ×”× ×‘×—×¨
        const carSelect = document.getElementById('examCarSelect');
        const carManual = document.getElementById('examCarManual');
        const carHidden = document.getElementById('examCar');
        carSelect.innerHTML = '<option value="">-</option>';
        carManual.value = '';

        if (ex.school) {
            const matchingRows = planRows.filter(row => row.school === ex.school);
            const uniqueCars = [...new Set(matchingRows.map(r => r.carNumber).filter(c => c))];
            uniqueCars.forEach(carNum => {
                carSelect.innerHTML += `<option value="${carNum}">${carNum}</option>`;
            });
        }

        // ×‘×“×•×§ ×× ×”×¢×¨×š ×”×©××•×¨ ×§×™×™× ×‘×¨×©×™××”
        if (ex.car) {
            const optionExists = carSelect.querySelector(`option[value="${ex.car}"]`);
            if (optionExists) {
                carSelect.value = ex.car;
                carManual.value = '';
            } else {
                // ×× ×œ× ×‘×¨×©×™××”, ×©×™× ×‘×©×“×” ×”×™×“× ×™
                carSelect.value = '';
                carManual.value = ex.car;
            }
            carHidden.value = ex.car;
        } else {
            carHidden.value = '';
        }

        document.getElementById('examVehicleType').value = ex.vehicleType;
        document.getElementById('examPopulation').value = ex.population || '';
        document.getElementById('examNumber').value = ex.examNumber || '';

        // ×¢×“×›×Ÿ ×‘×•×—×Ÿ - ×§×•×“× ×¢×“×›×Ÿ ××ª ×”×¨×©×™××” ×•××– ×‘×—×¨
        updateTesterSelect();
        const examTester = document.getElementById('examTester');
        if (ex.tester) {
            examTester.value = ex.tester;
        } else {
            // ×× ××™×Ÿ ×‘×•×—×Ÿ, ×‘×—×¨ ××ª ×”×¨××©×•×Ÿ ×‘×¨×©×™××” (×× ×™×© ×¨×§ ××—×“)
            const testers = getAllTesters();
            if (testers.length === 1) {
                examTester.value = testers[0];
            }
        }

        // Update navigation buttons
        document.getElementById('btnPrev').disabled = index === 0;
        document.getElementById('btnNext').disabled = index === examinees.length - 1;

        // Hide failure form
        document.getElementById('failureForm').classList.remove('active');

        // If already failed and has form, load it
        if (ex.result === 'fail' && ex.failureData) {
            loadFailureForm(ex.failureData);
            document.getElementById('failureForm').classList.add('active');
        } else {
            resetFailureForm();
        }
    }

    function saveCurrentExaminee() {
        const ex = examinees[currentExamineeIndex];
        ex.firstName = document.getElementById('examFirstName').value;
        ex.lastName = document.getElementById('examLastName').value;
        ex.id = document.getElementById('examID').value;
        ex.school = document.getElementById('examSchool').value;
        ex.car = document.getElementById('examCar').value;
        ex.vehicleType = document.getElementById('examVehicleType').value;
        ex.population = document.getElementById('examPopulation').value;
        ex.examNumber = document.getElementById('examNumber').value;
        ex.tester = document.getElementById('examTester').value;
        saveData();
        // ×¢×“×›×Ÿ ×›××•×™×•×ª ×‘×˜×‘×œ×ª ×”×‘×•×—× ×™×
        updateTesterCountsFromExaminees();
    }

    function prevExaminee() {
        if (currentExamineeIndex > 0) {
            saveCurrentExaminee();
            currentExamineeIndex--;
            loadExaminee(currentExamineeIndex);
            renderProgressDots();
        }
    }

    function nextExaminee() {
        if (currentExamineeIndex < examinees.length - 1) {
            saveCurrentExaminee();
            currentExamineeIndex++;
            loadExaminee(currentExamineeIndex);
            renderProgressDots();
        }
    }

    function markResult(result) {
        saveCurrentExaminee();
        const ex = examinees[currentExamineeIndex];
        ex.result = result;

        if (result === 'fail') {
            // Show failure form
            document.getElementById('failureForm').classList.add('active');
            document.getElementById('failureForm').scrollIntoView({behavior: 'smooth'});
        } else {
            // Hide failure form, clear failure data
            document.getElementById('failureForm').classList.remove('active');
            ex.failureData = null;
            resetFailureForm();
            saveData();
            renderProgressDots();

            // Auto advance to next
            if (currentExamineeIndex < examinees.length - 1) {
                setTimeout(() => {
                    currentExamineeIndex++;
                    loadExaminee(currentExamineeIndex);
                    renderProgressDots();
                }, 500);
            }
        }
    }

    function saveFailureForm() {
        const ex = examinees[currentExamineeIndex];

        // Collect marks
        const marks = {};
        document.querySelectorAll('.failure-item').forEach(item => {
            const itemName = item.dataset.item;
            const vBtn = item.querySelector('.btn-mark.selected-v');
            const xBtn = item.querySelector('.btn-mark.selected-x');
            const oxBtn = item.querySelector('.btn-mark.selected-ox');

            if (vBtn) marks[itemName] = {mark: 'v', reasons: []};
            else if (xBtn || oxBtn) {
                const mark = xBtn ? 'x' : 'ox';
                const reasons = [];
                const reasonsDiv = item.querySelector('.reasons-dropdown');
                if (reasonsDiv) {
                    reasonsDiv.querySelectorAll('.reason-chip.selected').forEach(chip => {
                        reasons.push(chip.textContent);
                    });
                }
                marks[itemName] = {mark, reasons};
            }
        });

        ex.failureData = {
            marks: marks,
            notes: document.getElementById('failureNotes').value,
            signature: sigCanvas.toDataURL()
        };

        saveData();
        renderProgressDots();

        // Collapse and show success
        document.getElementById('failureForm').classList.remove('active');
        alert('×˜×•×¤×¡ ×”×›×™×©×œ×•×Ÿ × ×©××¨ ×‘×”×¦×œ×—×”!');

        // Auto advance
        if (currentExamineeIndex < examinees.length - 1) {
            setTimeout(() => {
                currentExamineeIndex++;
                loadExaminee(currentExamineeIndex);
                renderProgressDots();
            }, 300);
        }
    }

    function loadFailureForm(data) {
        resetFailureForm();

        // Load marks
        Object.keys(data.marks).forEach(itemName => {
            const item = document.querySelector(`.failure-item[data-item="${itemName}"]`);
            if (!item) return;

            const markData = data.marks[itemName];
            const btnSelector = `.btn-mark:nth-child(${markData.mark === 'v' ? 1 : markData.mark === 'x' ? 2 : 3})`;
            const btn = item.querySelector(btnSelector);
            if (btn) {
                btn.classList.add('selected-' + markData.mark);
            }

            // Load reasons
            if (markData.reasons && markData.reasons.length > 0) {
                const reasonsDiv = item.querySelector('.reasons-dropdown');
                if (reasonsDiv) {
                    reasonsDiv.classList.add('open');
                    reasonsDiv.querySelectorAll('.reason-chip').forEach(chip => {
                        if (markData.reasons.includes(chip.textContent)) {
                            chip.classList.add('selected');
                        }
                    });
                }
            }
        });

        document.getElementById('failureNotes').value = data.notes || '';

        // Load signature
        if (data.signature) {
            const img = new Image();
            img.onload = () => sigCtx.drawImage(img, 0, 0);
            img.src = data.signature;
        }
    }

    function resetFailureForm() {
        // Clear all marks
        document.querySelectorAll('.btn-mark').forEach(btn => {
            btn.classList.remove('selected-v', 'selected-x', 'selected-ox');
        });
        document.querySelectorAll('.reasons-dropdown').forEach(div => {
            div.classList.remove('open');
            div.querySelectorAll('.reason-chip').forEach(chip => chip.classList.remove('selected'));
        });
        document.querySelectorAll('.category-content').forEach(c => c.classList.remove('open'));
        document.getElementById('failureNotes').value = '';
        clearSignature();
    }

    // ============ SUMMARY ============
    function renderSummary() {
        const list = document.getElementById('summaryList');
        list.innerHTML = '';

        let passCount = 0, failCount = 0, totalWithResult = 0;

        examinees.forEach((ex, i) => {
            if (!ex.firstName && !ex.lastName) return; // Skip empty

            totalWithResult++;
            if (ex.result === 'pass') passCount++;
            if (ex.result === 'fail') failCount++;

            const li = document.createElement('li');
            li.className = 'summary-item';

            if (ex.result === 'pass') {
                li.classList.add('passed');
            } else if (ex.result === 'fail') {
                if (ex.failureData) {
                    li.classList.add('failed');
                } else {
                    li.classList.add('failed-no-form');
                }
            }

            let statusIcon = 'â³';
            if (ex.result === 'pass') statusIcon = 'âœ“';
            if (ex.result === 'fail') statusIcon = 'âœ—';

            let warningHtml = '';
            if (ex.result === 'fail' && !ex.failureData) {
                warningHtml = '<div class="summary-warning">âš ï¸ ×—×¡×¨ ×˜×•×¤×¡ ×›×™×©×œ×•×Ÿ!</div>';
            }

            let editBtn = '';
            if (ex.result === 'fail') {
                editBtn = `<button class="btn-edit-failure" onclick="editFailure(${i})">ğŸ“ ${ex.failureData ? '×¢×¨×•×š' : '××œ×'} ×˜×•×¤×¡</button>`;
            }

            li.innerHTML = `
                <div class="summary-status">${statusIcon}</div>
                <div class="summary-details">
                    <div class="summary-name">${ex.firstName} ${ex.lastName}</div>
                    <div class="summary-info">×ª.×–: ${ex.id} | ×‘×™"×¡: ${ex.school}</div>
                    ${warningHtml}
                </div>
                ${editBtn}
            `;

            list.appendChild(li);
        });

        document.getElementById('statTotal').textContent = totalWithResult;
        document.getElementById('statPassed').textContent = passCount;
        document.getElementById('statFailed').textContent = failCount;
    }

    function editFailure(index) {
        currentExamineeIndex = index;
        goToExams();
        loadExaminee(index);
        document.getElementById('failureForm').classList.add('active');
        if (examinees[index].failureData) {
            loadFailureForm(examinees[index].failureData);
        }
    }

    // ============ WHATSAPP ============
    function generateWhatsAppButtons() {
        const container = document.getElementById('whatsappButtonsContainer');
        container.innerHTML = '';

        const date = document.getElementById('planDate').value || '×”×™×•×';
        const area = document.getElementById('planArea').value || '';
        const tester = document.getElementById('planTester').value || '';

        // ×§×‘×¥ ×¢×•×‘×¨×™× ×œ×¤×™ ×‘×™"×¡ ×•×“×¨×’×”
        const passedBySchoolAndGrade = {};
        examinees.forEach(ex => {
            if (ex.result === 'pass' && ex.firstName) {
                const school = ex.school || '×œ×œ× ×‘×™"×¡';
                const grade = ex.vehicleType || '×œ×œ× ×“×¨×’×”';
                const key = `${school}|||${grade}`;
                if (!passedBySchoolAndGrade[key]) {
                    passedBySchoolAndGrade[key] = { school, grade, students: [] };
                }
                passedBySchoolAndGrade[key].students.push(`${ex.firstName} ${ex.lastName}`);
            }
        });

        // ×§×‘×¥ × ×›×©×œ×™×
        const failedExaminees = examinees.filter(ex => ex.result === 'fail' && ex.firstName);

        // ×™×¦×™×¨×ª ×›×•×ª×¨×ª ×œ×¢×•×‘×¨×™×
        if (Object.keys(passedBySchoolAndGrade).length > 0) {
            const passedTitle = document.createElement('h3');
            passedTitle.style.cssText = 'margin: 20px 0 10px 0; color: #4CAF50; border-bottom: 2px solid #4CAF50; padding-bottom: 5px;';
            passedTitle.textContent = 'âœ… ×©×œ×™×—×ª ×¨×©×™××•×ª ×¢×•×‘×¨×™×';
            container.appendChild(passedTitle);

            // ×›×¤×ª×•×¨ ×œ×›×œ ×‘×™"×¡ + ×“×¨×’×”
            Object.values(passedBySchoolAndGrade).forEach(data => {
                const { school, grade, students } = data;
                let msg = `*×¨×©×™××ª ×¢×•×‘×¨×™× - ${date}*\n`;
                if (area) msg += `ğŸ“ ××–×•×¨: ${area}\n`;
                if (tester) msg += `ğŸ‘®â€â™‚ï¸ ×‘×•×—×Ÿ: ${tester}\n`;
                msg += `\nğŸš— *${school}*\n`;
                msg += `ğŸ“‹ *×“×¨×’×”: ${grade}*\n\n`;
                students.forEach(name => {
                    msg += `âœ… ${name}\n`;
                });

                const btn = document.createElement('button');
                btn.className = 'btn-action btn-whatsapp';
                btn.style.marginBottom = '8px';
                btn.innerHTML = `ğŸ“± ${school} - ${grade} (${students.length} ×¢×•×‘×¨×™×)`;
                btn.onclick = () => window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
                container.appendChild(btn);
            });
        }

        // ×™×¦×™×¨×ª ×›×•×ª×¨×ª ×œ× ×›×©×œ×™×
        if (failedExaminees.length > 0) {
            const failedTitle = document.createElement('h3');
            failedTitle.style.cssText = 'margin: 25px 0 10px 0; color: #f44336; border-bottom: 2px solid #f44336; padding-bottom: 5px;';
            failedTitle.textContent = 'âŒ ×©×œ×™×—×ª ×˜×¤×¡×™ ×›×™×©×œ×•×Ÿ';
            container.appendChild(failedTitle);

            // ×›×¤×ª×•×¨ ×œ×›×œ × ×›×©×œ
            failedExaminees.forEach((ex, idx) => {
                const btn = document.createElement('button');
                btn.className = 'btn-action';
                btn.style.cssText = 'background: #f44336; color: white; margin-bottom: 8px;';

                const hasForm = ex.failureData ? 'ğŸ“' : 'âš ï¸';
                btn.innerHTML = `${hasForm} ${ex.firstName} ${ex.lastName} - ${ex.school || '×œ×œ× ×‘×™"×¡'}`;

                btn.onclick = () => sendFailedWhatsApp(ex);
                container.appendChild(btn);
            });
        }

        if (Object.keys(passedBySchool).length === 0 && failedExaminees.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999;">××™×Ÿ ×ª×•×¦××•×ª ×œ×©×œ×™×—×”</p>';
        }
    }

    function sendFailedWhatsApp(ex) {
        const date = document.getElementById('planDate').value || '×”×™×•×';
        const area = document.getElementById('planArea').value || '';
        const tester = document.getElementById('planTester').value || '';

        let msg = `*×”×•×“×¢×ª ×›×™×©×œ×•×Ÿ ×‘××‘×—×Ÿ × ×”×™×’×”*\n`;
        msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        msg += `ğŸ“… ×ª××¨×™×š: ${date}\n`;
        if (area) msg += `ğŸ“ ××–×•×¨: ${area}\n`;
        if (tester) msg += `ğŸ‘®â€â™‚ï¸ ×‘×•×—×Ÿ: ${tester}\n`;
        msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;

        msg += `ğŸ‘¤ *×¤×¨×˜×™ ×”× ×‘×—×Ÿ:*\n`;
        msg += `×©×: ${ex.firstName} ${ex.lastName}\n`;
        msg += `×‘×™"×¡: ${ex.school || '-'}\n`;
        msg += `×¨×›×‘: ${ex.car || '-'}\n`;
        msg += `×“×¨×’×”: ${ex.vehicleType || '-'}\n\n`;

        if (ex.failureData && ex.failureData.notes) {
            msg += `ğŸ“‹ *×¡×™×‘×•×ª ×”×›×™×©×œ×•×Ÿ:*\n`;
            msg += ex.failureData.notes;
            msg += `\n`;
        } else {
            msg += `âš ï¸ *×˜×•×¤×¡ ×›×™×©×œ×•×Ÿ ×œ× ××•×œ×*\n\n`;
        }

        msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        msg += `×‘×”×¦×œ×—×” ×‘×¤×¢× ×”×‘××”! ğŸš—`;

        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
    }

    // ×©×œ×™×—×ª ×“×•"×— ×œ×¨×‘ ×‘×•×—×Ÿ - ×”×•×“×¢×ª ×•×•××˜×¡××¤
    function sendReportToSupervisor() {
        const date = document.getElementById('planDate').value || '';
        const day = document.getElementById('planDay').value || '';
        const area = document.getElementById('planArea').value || '';
        const tester = document.getElementById('planTester').value || '';
        const areaCode = document.getElementById('areaCode').value || '';

        // ×—×©×‘ ×¡×™×›×•××™×
        let passKadatz = 0, passVoucher = 0, passArmy = 0, passOther = 0;
        let failKadatz = 0, failVoucher = 0, failArmy = 0, failOther = 0;

        examinees.forEach(ex => {
            if (!ex.result) return;
            const pop = ex.population || 'other';
            if (ex.result === 'pass') {
                if (pop === 'kadatz') passKadatz++;
                else if (pop === 'voucher') passVoucher++;
                else if (pop === 'army') passArmy++;
                else passOther++;
            } else if (ex.result === 'fail') {
                if (pop === 'kadatz') failKadatz++;
                else if (pop === 'voucher') failVoucher++;
                else if (pop === 'army') failArmy++;
                else failOther++;
            }
        });

        const totalPass = passKadatz + passVoucher + passArmy + passOther;
        const totalFail = failKadatz + failVoucher + failArmy + failOther;
        const totalExams = totalPass + totalFail;

        // ×‘× ×” ×”×•×“×¢×”
        let msg = `*ğŸ“‹ ×“×•"×— ×‘×•×—×Ÿ - ×¡×™×•× ×™×•×*\n`;
        msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        msg += `ğŸ“… ${date} ${day ? '(' + day + ')' : ''}\n`;
        msg += `ğŸ“ ${area}\n`;
        msg += `ğŸ‘¤ ${tester}\n`;
        if (areaCode) msg += `ğŸ”¢ ×§×•×“: ${areaCode}\n`;
        msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;

        msg += `*×¡×”"×›: ${totalExams} ××‘×—× ×™×*\n`;
        msg += `âœ… ×¢×‘×¨×•: ${totalPass}\n`;
        msg += `âŒ × ×›×©×œ×•: ${totalFail}\n\n`;

        if (totalPass > 0) {
            msg += `*×¢×‘×¨×•:* `;
            let passParts = [];
            if (passKadatz > 0) passParts.push(`×§×“"×¦ ${passKadatz}`);
            if (passVoucher > 0) passParts.push(`×•××•×¦'×¨ ${passVoucher}`);
            if (passArmy > 0) passParts.push(`×¦×‘× ${passArmy}`);
            if (passOther > 0) passParts.push(`××—×¨ ${passOther}`);
            msg += passParts.join(', ') + `\n`;
        }

        if (totalFail > 0) {
            msg += `*× ×›×©×œ×•:* `;
            let failParts = [];
            if (failKadatz > 0) failParts.push(`×§×“"×¦ ${failKadatz}`);
            if (failVoucher > 0) failParts.push(`×•××•×¦'×¨ ${failVoucher}`);
            if (failArmy > 0) failParts.push(`×¦×‘× ${failArmy}`);
            if (failOther > 0) failParts.push(`××—×¨ ${failOther}`);
            msg += failParts.join(', ') + `\n`;
        }

        // ×”×¢×¨×•×ª ××”×“×•"×—
        const reportNotes = document.getElementById('reportNotesInput')?.value;
        if (reportNotes && reportNotes.trim()) {
            msg += `\n*×”×¢×¨×•×ª:* ${reportNotes.trim()}\n`;
        }

        msg += `\nğŸ• ${new Date().toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'})}`;

        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
    }

    // ×©×œ×™×—×ª × ×ª×•× ×™× ×œ×’×™×œ×™×•×Ÿ Google Sheets ×”××¨×›×–×™
    const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwknJlrq0N4Q9Pk5WorBK3yGQo15Fqax0jSaAzSaAHicaZRZbPZEJ4KUbGaf9mxAOAUOQ/exec';

    function exportToExcel() {
        const date = document.getElementById('planDate').value || '';
        const area = document.getElementById('planArea').value || '';
        const tester = document.getElementById('planTester').value || '';

        // ×”××¨×ª ×¡×•×’ ××•×›×œ×•×¡×™×™×” ×œ×˜×§×¡×˜
        const populationText = {
            'kadatz': '×§×“"×¦',
            'voucher': '×•××•×¦\'×¨',
            'army': '×¦×‘×',
            'other': '×¤×¨×˜×™/××—×¨'
        };

        // ×”××¨×ª ×ª×•×¦××” ×œ×˜×§×¡×˜
        const resultText = {
            'pass': '×¢×‘×¨',
            'fail': '× ×›×©×œ'
        };

        // ×‘× ×” ×©×•×¨×•×ª × ×ª×•× ×™× ×›××¢×¨×›×™×
        let rows = [];
        examinees.forEach(ex => {
            if ((ex.firstName || ex.lastName) && ex.result) {
                const row = [
                    tester,                                    // ×©× ×‘×•×—×Ÿ
                    date,                                      // ×ª××¨×™×š ×”××‘×—×Ÿ
                    area,                                      // ××–×•×¨ ×‘×—×™× ×”
                    ex.school || '',                           // ×©× ×‘×™×ª ×”×¡×¤×¨
                    ex.id || '',                               // ×ª.×–.
                    (ex.firstName || '') + ' ' + (ex.lastName || ''),  // ×©× ××œ×
                    populationText[ex.population] || ex.population || '',  // ×¡×•×’ ××•×›×œ×•×¡×™×”
                    ex.examNumber || '',                       // ××¡' ××‘×—×Ÿ
                    ex.vehicleType || '',                      // ×“×¨×’×ª ×¨×™×©×™×•×Ÿ
                    resultText[ex.result] || ex.result || ''   // ×ª×•×¦××”
                ];
                rows.push(row);
            }
        });

        if (rows.length === 0) {
            alert('××™×Ÿ × ×ª×•× ×™× ×œ×©×œ×™×—×”');
            return;
        }

        // ×©× ×” ×˜×§×¡×˜ ×›×¤×ª×•×¨ ×œ××¦×‘ ×˜×¢×™× ×”
        const btn = document.querySelector('.report-excel-btn');
        const originalText = btn ? btn.textContent : '';
        if (btn) btn.textContent = 'â³ ×©×•×œ×—...';

        // ×©×œ×— ×œ×’×™×œ×™×•×Ÿ Google Sheets
        fetch(GOOGLE_SHEETS_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rows: rows })
        })
        .then(() => {
            alert(`âœ… × ×©×œ×—×• ${rows.length} ×©×•×¨×•×ª ×œ×’×™×œ×™×•×Ÿ ×”××¨×›×–×™!`);
            if (btn) btn.textContent = originalText;
        })
        .catch(error => {
            alert('âŒ ×©×’×™××” ×‘×©×œ×™×—×”: ' + error.message);
            if (btn) btn.textContent = originalText;
        });
    }

    // ============ PRINTABLE REPORT ============
    function openPrintableReport() {
        const report = document.getElementById('printableReport');
        const outerReport = document.getElementById('printableReportOuter');

        // ×”×•×¡×£ ×›×¤×ª×•×¨×™ ×¡×’×™×¨×” ×•×”×“×¤×¡×”
        let closeBtn = document.querySelector('.report-close-btn');
        let printBtn = document.querySelector('.report-print-btn');
        if (!closeBtn) {
            closeBtn = document.createElement('button');
            closeBtn.className = 'report-close-btn';
            closeBtn.textContent = 'âœ• ×¡×’×•×¨';
            closeBtn.onclick = closeReport;
            document.body.appendChild(closeBtn);
        }
        if (!printBtn) {
            printBtn = document.createElement('button');
            printBtn.className = 'report-print-btn';
            printBtn.textContent = 'ğŸ’¾ ×©××•×¨ PDF';
            printBtn.onclick = () => {
                // ×”×›×Ÿ ××ª ×”-outer report ×œ×¤× ×™ ×”×“×¤×¡×” (×›×•×œ×œ ×”×¢×ª×§×ª ×—×ª×™××”)
                prepareForPrint();
                updateOuterReportBeforePrint();
                const area = document.getElementById('planArea').value || '×“×•×—';
                const date = document.getElementById('planDate').value || '';
                const tester = document.getElementById('planTester').value || '';
                const fileName = (area + ' - ' + tester + ' - ' + date).replace(/\//g, '.').trim() || '×“×•×— ×‘×•×—×Ÿ';

                // ×©× ×” ××ª ×›×•×ª×¨×ª ×”×“×£ ×•×”××¡××š ×œ×©× ×”×§×•×‘×¥ ×”×¨×¦×•×™
                const originalTitle = document.title;
                document.title = fileName;

                // ×©× ×” ×’× ××ª ×ª×’ ×”-title
                const titleTag = document.querySelector('title');
                const originalTitleTag = titleTag ? titleTag.textContent : '';
                if (titleTag) titleTag.textContent = fileName;

                // ×©× ×” ××ª ×”-URL (×‘×œ×™ ×œ×˜×¢×•×Ÿ ××—×“×©) - ×–×” ×¢×•×–×¨ ×‘-Android
                const originalUrl = window.location.href;
                try {
                    window.history.replaceState({}, fileName, fileName.replace(/\s/g, '_') + '.html');
                } catch(e) {}

                // ×¤×•× ×§×¦×™×” ×œ× ×™×§×•×™ ××—×¨×™ ×”×“×¤×¡×”
                const cleanupAfterPrint = () => {
                    document.title = originalTitle;
                    if (titleTag) titleTag.textContent = originalTitleTag;
                    try {
                        window.history.replaceState({}, originalTitleTag, originalUrl);
                    } catch(e) {}
                    // ×œ× ×× ×§×™× ××ª ×”-outer report ×›×“×™ ×©×™×™×©××¨ ×œ×”×“×¤×¡×”
                };

                // ×”×©×ª××© ×‘-afterprint event ×× × ×ª××š
                if ('onafterprint' in window) {
                    window.onafterprint = () => {
                        cleanupAfterPrint();
                        window.onafterprint = null;
                    };
                } else {
                    // fallback ×œ×“×¤×“×¤× ×™× ×™×©× ×™×
                    setTimeout(cleanupAfterPrint, 2000);
                }

                // ×”×“×¤×¡
                window.print();
            };
            document.body.appendChild(printBtn);
        }

        // ×›×¤×ª×•×¨ ×©×œ×™×—×” ×œ×¨×‘ ×‘×•×—×Ÿ
        let whatsappBtn = document.querySelector('.report-whatsapp-btn');
        if (!whatsappBtn) {
            whatsappBtn = document.createElement('button');
            whatsappBtn.className = 'report-whatsapp-btn';
            whatsappBtn.textContent = 'ğŸ“¤ ×©×œ×— ×œ×¨×‘ ×‘×•×—×Ÿ';
            whatsappBtn.onclick = sendReportToSupervisor;
            document.body.appendChild(whatsappBtn);
        }

        // ×›×¤×ª×•×¨ ×©×œ×™×—×” ×œ×’×™×œ×™×•×Ÿ
        let excelBtn = document.querySelector('.report-excel-btn');
        if (!excelBtn) {
            excelBtn = document.createElement('button');
            excelBtn.className = 'report-excel-btn';
            excelBtn.textContent = 'ğŸ“Š ×©×œ×— ×œ×’×™×œ×™×•×Ÿ';
            excelBtn.onclick = exportToExcel;
            document.body.appendChild(excelBtn);
        }

        // ××œ× ××ª ×”×“×•"×— ×‘× ×ª×•× ×™×
        fillReportData();

        // ×”×¦×’ ××ª ×”×“×•"×— ×”×¤× ×™××™ (×œ×¦×¤×™×™×” ×•×—×ª×™××”)
        report.classList.add('preview');
        closeBtn.style.display = 'block';
        printBtn.style.display = 'block';
        whatsappBtn.style.display = 'block';
        excelBtn.style.display = 'block';

        // ××ª×—×œ ×—×ª×™××” ×¢×œ ×”×“×•"×— (××—×¨×™ ×©×”×•× ××•×¦×’)
        setTimeout(() => {
            initReportSignature();
            // ×˜×¢×Ÿ ×—×ª×™××” ×©××•×¨×” ×× ×™×©
            const savedReportSig = localStorage.getItem('report_signature');
            if (savedReportSig && reportSigCanvas) {
                const img = new Image();
                img.onload = () => reportSigCtx.drawImage(img, 0, 0);
                img.src = savedReportSig;
            }
        }, 200);
    }

    // ×”×¢×ª×§×ª ×”×“×•"×— ×œ-outer ×œ×¤× ×™ ×”×“×¤×¡×”
    function prepareForPrint() {
        const report = document.getElementById('printableReport');
        const outerReport = document.getElementById('printableReportOuter');

        // ×”×¢×ª×§ ××ª ×ª×•×›×Ÿ ×”×“×•"×— ×œ-container ×”×—×™×¦×•× ×™ ×œ×”×“×¤×¡×”
        outerReport.innerHTML = report.innerHTML;
        outerReport.classList.add('active');

        // ×”×¡×ª×¨ ××ª ×©×“×” ×”×§×œ×˜ ×•×”×¦×’ ××ª ×”×ª×¦×•×’×” ×‘-outer report
        const outerTextarea = outerReport.querySelector('.report-notes-textarea');
        const outerDisplay = outerReport.querySelector('.report-notes-display');
        if (outerTextarea) outerTextarea.style.display = 'none';
        if (outerDisplay) outerDisplay.style.display = 'block';

        // ×”×¡×ª×¨ ×›×¤×ª×•×¨ × ×§×” ×—×ª×™××”
        const clearBtn = outerReport.querySelector('.btn-clear-report-sig');
        if (clearBtn) clearBtn.style.display = 'none';

        // ×”×¢×ª×§ ××ª ×”×—×ª×™××” ×œ-canvas ×”×—×™×¦×•× ×™
        const outerCanvas = outerReport.querySelector('canvas');
        if (outerCanvas && reportSigCanvas) {
            const outerCtx = outerCanvas.getContext('2d');
            outerCtx.drawImage(reportSigCanvas, 0, 0);
        }
    }

    function closeReport() {
        const report = document.getElementById('printableReport');
        const outerReport = document.getElementById('printableReportOuter');
        report.classList.remove('preview');
        outerReport.classList.remove('active');
        outerReport.innerHTML = '';
        const closeBtn = document.querySelector('.report-close-btn');
        const printBtn = document.querySelector('.report-print-btn');
        const whatsappBtn = document.querySelector('.report-whatsapp-btn');
        const excelBtn = document.querySelector('.report-excel-btn');
        if (closeBtn) closeBtn.style.display = 'none';
        if (printBtn) printBtn.style.display = 'none';
        if (whatsappBtn) whatsappBtn.style.display = 'none';
        if (excelBtn) excelBtn.style.display = 'none';
    }

    // ×—×™×©×•×‘ ××—×“×© ×©×œ ×¡×™×›×•××™ ×”×“×•×— ×›×©×¢×•×¨×›×™× ×ª××™×
    function recalculateReportTotals() {
        const tbody = document.getElementById('reportPlanExecuteBody');
        const tfoot = document.getElementById('reportPlanExecuteFoot');
        if (!tbody || !tfoot) return;

        let totalActual = 0;
        let totalPassKadatz = 0, totalPassVoucher = 0, totalPassArmy = 0, totalPassOther = 0;
        let totalFailKadatz = 0, totalFailVoucher = 0, totalFailArmy = 0, totalFailOther = 0;
        let totalRequested = 0, totalApproved = 0;

        // ×¢×‘×•×¨ ×¢×œ ×›×œ ×”×©×•×¨×•×ª ×•×—×©×‘ ×¡×™×›×•××™×
        tbody.querySelectorAll('tr').forEach(tr => {
            const cells = tr.querySelectorAll('td');
            if (cells.length >= 14) {
                // ×§×— ××ª ×”×¢×¨×›×™× ××”×ª××™× ×”× ×™×ª× ×™× ×œ×¢×¨×™×›×”
                const passKadatz = parseInt(cells[6].textContent) || 0;
                const passVoucher = parseInt(cells[7].textContent) || 0;
                const passArmy = parseInt(cells[8].textContent) || 0;
                const passOther = parseInt(cells[9].textContent) || 0;
                const failKadatz = parseInt(cells[10].textContent) || 0;
                const failVoucher = parseInt(cells[11].textContent) || 0;
                const failArmy = parseInt(cells[12].textContent) || 0;
                const failOther = parseInt(cells[13].textContent) || 0;

                // ×—×©×‘ ×¡×”"×› ×œ×©×•×¨×”
                const rowTotal = passKadatz + passVoucher + passArmy + passOther +
                                failKadatz + failVoucher + failArmy + failOther;
                cells[5].textContent = rowTotal || '';

                // ×¦×‘×•×¨ ×œ×¡×™×›×•× ×›×œ×œ×™
                totalPassKadatz += passKadatz;
                totalPassVoucher += passVoucher;
                totalPassArmy += passArmy;
                totalPassOther += passOther;
                totalFailKadatz += failKadatz;
                totalFailVoucher += failVoucher;
                totalFailArmy += failArmy;
                totalFailOther += failOther;
                totalActual += rowTotal;

                // ××‘×•×§×© ×•×××•×©×¨
                totalRequested += parseInt(cells[3].textContent) || 0;
                totalApproved += parseInt(cells[4].textContent) || 0;
            }
        });

        // ×¢×“×›×Ÿ ××ª ×©×•×¨×ª ×”×¡×™×›×•×
        const totalPass = totalPassKadatz + totalPassVoucher + totalPassArmy + totalPassOther;
        const totalFail = totalFailKadatz + totalFailVoucher + totalFailArmy + totalFailOther;

        const footRows = tfoot.querySelectorAll('tr');
        if (footRows.length >= 2) {
            // ×©×•×¨×” ×¨××©×•× ×” - ×¡×™×›×•××™×
            const footCells = footRows[0].querySelectorAll('td');
            if (footCells.length >= 12) {
                footCells[1].textContent = totalRequested || '';
                footCells[2].textContent = totalApproved || '';
                footCells[3].textContent = totalActual || '';
                footCells[4].textContent = totalPassKadatz || '';
                footCells[5].textContent = totalPassVoucher || '';
                footCells[6].textContent = totalPassArmy || '';
                footCells[7].textContent = totalPassOther || '';
                footCells[8].textContent = totalFailKadatz || '';
                footCells[9].textContent = totalFailVoucher || '';
                footCells[10].textContent = totalFailArmy || '';
                footCells[11].textContent = totalFailOther || '';
            }

            // ×©×•×¨×” ×©× ×™×™×” - ×¡×™×›×•× ×¢×‘×¨/× ×›×©×œ
            const summaryRow = footRows[1];
            const summaryCells = summaryRow.querySelectorAll('td');
            if (summaryCells.length >= 3) {
                summaryCells[0].innerHTML = `×¡×”"×›: ×¢×‘×¨×• <span style="color: green;">${totalPass}</span> | × ×›×©×œ×• <span style="color: red;">${totalFail}</span> | ×¡×”"×› <span style="color: blue;">${totalActual}</span>`;
                summaryCells[1].textContent = totalPass;
                summaryCells[2].textContent = totalFail;
            }
        }
    }

    function fillReportData() {
        const date = document.getElementById('planDate').value || '';
        const day = document.getElementById('planDay').value || '';
        const area = document.getElementById('planArea').value || '';
        const tester = document.getElementById('planTester').value || '';
        const areaCode = document.getElementById('areaCode').value || '';
        const isMainTester = document.getElementById('isMainTester').checked;

        // ×›×•×ª×¨×ª ××©× ×”
        let allTesterNames = [tester];
        importedTesters.forEach(t => allTesterNames.push(t.tester));
        const testersText = isMainTester && importedTesters.length > 0
            ? `${tester} (××—×¨××™), ${importedTesters.map(t => t.tester).join(', ')}`
            : tester;

        // ×©×™××•×© ×‘-innerHTML ×¢× non-breaking space ×›×“×™ ×œ×©××•×¨ ×¨×•×•×—×™× ×‘-PDF
        const nbspReplace = (str) => str.replace(/ /g, '\u00A0');
        const subtitle = `×™×•× ${nbspReplace(day)} | ×ª××¨×™×š ${nbspReplace(date)} | ××–×•×¨ ${nbspReplace(area)} | ×‘×•×—× ×™× ${nbspReplace(testersText)}`;
        document.getElementById('reportSubtitle').innerHTML = subtitle;

        // ×˜×‘×œ×ª ×ª×›× ×•×Ÿ ×•×‘×™×¦×•×¢ ××©×•×œ×‘×ª
        const planExecuteTbody = document.getElementById('reportPlanExecuteBody');
        const planExecuteTfoot = document.getElementById('reportPlanExecuteFoot');
        planExecuteTbody.innerHTML = '';
        planExecuteTfoot.innerHTML = '';

        // ×¡×™×›×•× ×›×•×œ×œ
        let totalRequested = 0, totalApproved = 0, totalActual = 0;
        let totalPassKadatz = 0, totalPassVoucher = 0, totalPassArmy = 0, totalPassOther = 0;
        let totalFailKadatz = 0, totalFailVoucher = 0, totalFailArmy = 0, totalFailOther = 0;

        planRows.forEach(row => {
            if (row.school || row.carNumber) {
                // ×—×©×‘ ×‘×™×¦×•×¢ ×¢×‘×•×¨ ×©×•×¨×” ×–×•
                const school = row.school || '';
                const car = row.carNumber || '';

                // ××¦× ××ª ×›×œ ×”× ×‘×—× ×™× ×œ×©×•×¨×” ×–×• (×”×ª×××” ×œ×¤×™ ×‘×™"×¡ ×‘×œ×‘×“ ×× ××™×Ÿ ×¨×›×‘, ××• ×œ×¤×™ ×©× ×™×”×)
                let passKadatz = 0, passVoucher = 0, passArmy = 0, passOther = 0;
                let failKadatz = 0, failVoucher = 0, failArmy = 0, failOther = 0;

                examinees.forEach(ex => {
                    // ×”×ª×××”: ×× ×™×© ×¨×›×‘ ×‘×ª×›× ×•×Ÿ - ×¦×¨×™×š ×”×ª×××” ×œ×‘×™"×¡ ×•×¨×›×‘, ××—×¨×ª ×¨×§ ×œ×‘×™"×¡
                    const schoolMatch = ex.school === school;
                    const carMatch = !car || ex.car === car;
                    if (schoolMatch && carMatch && ex.result) {
                        const pop = ex.population || 'other';
                        if (ex.result === 'pass') {
                            if (pop === 'kadatz') passKadatz++;
                            else if (pop === 'voucher') passVoucher++;
                            else if (pop === 'army') passArmy++;
                            else passOther++;
                        } else if (ex.result === 'fail') {
                            if (pop === 'kadatz') failKadatz++;
                            else if (pop === 'voucher') failVoucher++;
                            else if (pop === 'army') failArmy++;
                            else failOther++;
                        }
                    }
                });

                // ×”×•×¡×£ × ×ª×•× ×™× ××‘×•×—× ×™× ××™×•×‘××™× ×œ×¤×™ ×‘×™"×¡
                importedTesters.forEach(imported => {
                    if (imported.schools && imported.schools[school]) {
                        const s = imported.schools[school];
                        passKadatz += s.passKadatz || 0;
                        passVoucher += s.passVoucher || 0;
                        passArmy += s.passArmy || 0;
                        passOther += s.passOther || 0;
                        failKadatz += s.failKadatz || 0;
                        failVoucher += s.failVoucher || 0;
                        failArmy += s.failArmy || 0;
                        failOther += s.failOther || 0;
                    }
                });

                // ×—×™×©×•×‘ ×›××•×ª ×‘×¤×•×¢×œ
                const countActual = passKadatz + passVoucher + passArmy + passOther +
                                   failKadatz + failVoucher + failArmy + failOther;

                const tr = document.createElement('tr');
                tr.dataset.rowIndex = planRows.indexOf(row);
                tr.innerHTML = `
                    <td style="text-align: right;">${row.school || '-'}</td>
                    <td>${row.type || '-'}</td>
                    <td>${row.carNumber || '-'}</td>
                    <td>${row.countRequested || ''}</td>
                    <td>${row.countApproved || ''}</td>
                    <td class="actual-total" style="font-weight: bold;">${countActual || ''}</td>
                    <td class="editable-cell pass-cell" data-field="passKadatz" contenteditable="true">${passKadatz || ''}</td>
                    <td class="editable-cell pass-cell" data-field="passVoucher" contenteditable="true">${passVoucher || ''}</td>
                    <td class="editable-cell pass-cell" data-field="passArmy" contenteditable="true">${passArmy || ''}</td>
                    <td class="editable-cell pass-cell" data-field="passOther" contenteditable="true">${passOther || ''}</td>
                    <td class="editable-cell fail-cell" data-field="failKadatz" contenteditable="true">${failKadatz || ''}</td>
                    <td class="editable-cell fail-cell" data-field="failVoucher" contenteditable="true">${failVoucher || ''}</td>
                    <td class="editable-cell fail-cell" data-field="failArmy" contenteditable="true">${failArmy || ''}</td>
                    <td class="editable-cell fail-cell" data-field="failOther" contenteditable="true">${failOther || ''}</td>
                `;
                planExecuteTbody.appendChild(tr);

                // ×”×•×¡×£ event listeners ×œ×¢×¨×™×›×”
                tr.querySelectorAll('.editable-cell').forEach(cell => {
                    cell.addEventListener('input', recalculateReportTotals);
                    cell.addEventListener('blur', recalculateReportTotals);
                });

                // ×¦×‘×•×¨ ×¡×™×›×•××™×
                totalRequested += parseInt(row.countRequested) || 0;
                totalApproved += parseInt(row.countApproved) || 0;
                totalActual += countActual;
                totalPassKadatz += passKadatz;
                totalPassVoucher += passVoucher;
                totalPassArmy += passArmy;
                totalPassOther += passOther;
                totalFailKadatz += failKadatz;
                totalFailVoucher += failVoucher;
                totalFailArmy += failArmy;
                totalFailOther += failOther;
            }
        });

        // ×”×•×¡×£ × ×ª×•× ×™× ××‘×•×—× ×™× ××™×•×‘××™× ×œ×¡×™×›×•× ×”×›×•×œ×œ
        // ×¨×§ ×× ××™×Ÿ ×¤×™×¨×•×˜ ×œ×¤×™ ×‘×™"×¡ (×’×¨×¡×” ×™×©× ×”) - ×›×™ ×× ×™×© ×¤×™×¨×•×˜ ×”× ×›×‘×¨ × ×¡×¤×¨×• ×œ××¢×œ×”
        importedTesters.forEach(imported => {
            if (imported.summary && !imported.schools) {
                // ×‘×•×—×Ÿ ×¢× ×’×¨×¡×” ×™×©× ×” - ××™×Ÿ ×¤×™×¨×•×˜ ×‘×™"×¡, ××•×¡×™×¤×™× ×œ×¡×™×›×•×
                totalPassKadatz += imported.summary.passKadatz || 0;
                totalPassVoucher += imported.summary.passVoucher || 0;
                totalPassArmy += imported.summary.passArmy || 0;
                totalPassOther += imported.summary.passOther || 0;
                totalFailKadatz += imported.summary.failKadatz || 0;
                totalFailVoucher += imported.summary.failVoucher || 0;
                totalFailArmy += imported.summary.failArmy || 0;
                totalFailOther += imported.summary.failOther || 0;

                // ×¢×“×›×Ÿ ×’× ××ª ×›××•×ª ×‘×¤×•×¢×œ
                const importedTotal = (imported.summary.passKadatz || 0) + (imported.summary.passVoucher || 0) +
                                     (imported.summary.passArmy || 0) + (imported.summary.passOther || 0) +
                                     (imported.summary.failKadatz || 0) + (imported.summary.failVoucher || 0) +
                                     (imported.summary.failArmy || 0) + (imported.summary.failOther || 0);
                totalActual += importedTotal;
            }
        });

        // ×©×•×¨×ª ×¡×™×›×•×
        const totalPass = totalPassKadatz + totalPassVoucher + totalPassArmy + totalPassOther;
        const totalFail = totalFailKadatz + totalFailVoucher + totalFailArmy + totalFailOther;

        const footTr = document.createElement('tr');
        footTr.innerHTML = `
            <td colspan="3" style="text-align: center; font-weight: bold;">×¡×”"×›</td>
            <td>${totalRequested || ''}</td>
            <td>${totalApproved || ''}</td>
            <td style="font-weight: bold;">${totalActual || ''}</td>
            <td>${totalPassKadatz || ''}</td>
            <td>${totalPassVoucher || ''}</td>
            <td>${totalPassArmy || ''}</td>
            <td>${totalPassOther || ''}</td>
            <td>${totalFailKadatz || ''}</td>
            <td>${totalFailVoucher || ''}</td>
            <td>${totalFailArmy || ''}</td>
            <td>${totalFailOther || ''}</td>
        `;
        planExecuteTfoot.appendChild(footTr);

        // ×©×•×¨×ª ×¡×™×›×•× ×¢×‘×¨/× ×›×©×œ
        const summaryTr = document.createElement('tr');
        summaryTr.innerHTML = `
            <td colspan="6" style="text-align: left; font-weight: bold; background: #f5f5f5;">
                ×¡×”"×›: ×¢×‘×¨×• <span style="color: green;">${totalPass}</span> | × ×›×©×œ×• <span style="color: red;">${totalFail}</span> | ×¡×”"×› <span style="color: blue;">${totalActual}</span>
            </td>
            <td colspan="4" style="background: #c8e6c9; font-weight: bold; text-align: center;">${totalPass}</td>
            <td colspan="4" style="background: #ffcdd2; font-weight: bold; text-align: center;">${totalFail}</td>
        `;
        planExecuteTfoot.appendChild(summaryTr);

        // ×—×™×©×•×‘ ×›××•×ª ×¢×™×¨×•× ×™ ×œ×›×œ ×‘×•×—×Ÿ (××”× ×‘×—× ×™× ×©×œ×™)
        const testerUrbanCounts = {};
        examinees.forEach(ex => {
            if (ex.result) {
                const t = ex.tester || tester;
                if (!testerUrbanCounts[t]) testerUrbanCounts[t] = 0;
                testerUrbanCounts[t]++;
            }
        });

        // ×”×•×¡×£ ×›××•×™×•×ª ××‘×•×—× ×™× ××™×•×‘××™×
        importedTesters.forEach(imported => {
            if (imported.summary) {
                const total = imported.summary.passKadatz + imported.summary.passVoucher + imported.summary.passArmy + imported.summary.passOther +
                             imported.summary.failKadatz + imported.summary.failVoucher + imported.summary.failArmy + imported.summary.failOther;
                testerUrbanCounts[imported.tester] = total;
            }
        });

        // ×˜×‘×œ×ª ×‘×•×—× ×™× - ×¢× ×›××•×ª ×¢×™×¨×•× ×™ ××¢×•×“×›× ×ª
        const testersTbody = document.querySelector('#reportTestersTable tbody');
        if (testersTbody) {
            testersTbody.innerHTML = '';
            const addedTesters = new Set(); // ×œ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª

            // ×¤×•× ×§×¦×™×™×ª × ×•×¨××œ×™×–×¦×™×” ×œ×©××•×ª - ×œ×”×¡×¨×ª ×¨×•×•×—×™× ××™×•×ª×¨×™×
            const normalizeName = (name) => name ? name.trim().replace(/\s+/g, ' ') : '';

            // ×”×‘×•×—×Ÿ ×”×¨××©×™
            const testerNormalized = normalizeName(tester);
            if (testerNormalized) {
                const mainTesterRow = testerRows.find(r => normalizeName(r.name) === testerNormalized) || {};
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${tester}</td>
                    <td>${testerUrbanCounts[tester] || mainTesterRow.urban || '-'}</td>
                    <td>${mainTesterRow.motorcycle || '-'}</td>
                `;
                testersTbody.appendChild(tr);
                addedTesters.add(testerNormalized);
            }
            // ×‘×•×—× ×™× × ×•×¡×¤×™× ××˜×‘×œ×ª ×”×‘×•×—× ×™×
            testerRows.forEach(row => {
                const rowNameNormalized = normalizeName(row.name);
                if (rowNameNormalized && !addedTesters.has(rowNameNormalized)) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.name || '-'}</td>
                        <td>${testerUrbanCounts[row.name] || row.urban || '-'}</td>
                        <td>${row.motorcycle || '-'}</td>
                    `;
                    testersTbody.appendChild(tr);
                    addedTesters.add(rowNameNormalized);
                }
            });
            // ×‘×•×—× ×™× ××™×•×‘××™×
            importedTesters.forEach(imported => {
                const importedNameNormalized = normalizeName(imported.tester);
                // ×¨×§ ×× ×œ× ×›×‘×¨ × ×•×¡×£
                if (importedNameNormalized && !addedTesters.has(importedNameNormalized)) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${imported.tester}</td>
                        <td>${testerUrbanCounts[imported.tester] || '-'}</td>
                        <td>-</td>
                    `;
                    testersTbody.appendChild(tr);
                    addedTesters.add(importedNameNormalized);
                }
            });
        }

        // ×¨×©×™××ª × ×‘×—× ×™× - ×¨×§ ×©×œ×™ (×œ× ××™×•×‘××™×)
        let allExaminees = [];
        examinees.forEach(ex => {
            if (ex.firstName || ex.lastName) {
                allExaminees.push({
                    ...ex,
                    tester: ex.tester || tester
                });
            }
        });

        // ×˜×‘×œ×ª × ×‘×—× ×™×
        const examTbody = document.querySelector('#reportExamineesTable tbody');
        examTbody.innerHTML = '';

        // ××™×•×Ÿ ×œ×¤×™ ×‘×•×—×Ÿ
        allExaminees.sort((a, b) => (a.tester || '').localeCompare(b.tester || ''));

        allExaminees.forEach((ex, idx) => {
            const tr = document.createElement('tr');
            const resultClass = ex.result === 'pass' ? 'result-pass' : (ex.result === 'fail' ? 'result-fail' : '');
            const resultText = ex.result === 'pass' ? '×¢×‘×¨' : (ex.result === 'fail' ? '× ×›×©×œ' : '-');

            // ×”××¨×ª ×§×•×“ ××•×›×œ×•×¡×™×” ×œ×˜×§×¡×˜
            const populationText = {
                'kadatz': '×§×“"×¦',
                'voucher': '×•××•×¦\'×¨',
                'army': '×¦×‘×',
                'other': '×¤×¨×˜×™/××—×¨'
            }[ex.population] || '-';

            tr.innerHTML = `
                <td>${idx + 1}</td>
                <td style="text-align: right;">${ex.firstName} ${ex.lastName}</td>
                <td>${ex.id || '-'}</td>
                <td>${ex.school || '-'}</td>
                <td>${ex.car || '-'}</td>
                <td>${ex.vehicleType || '-'}</td>
                <td>${ex.examNumber || '-'}</td>
                <td>${populationText}</td>
                <td>${ex.tester || '-'}</td>
                <td class="${resultClass}">${resultText}</td>
            `;
            examTbody.appendChild(tr);
        });

        // ×‘× ×™×™×ª ×¡×™×›×•× ×œ×¤×™ ×‘×•×—×Ÿ - ××”× ×‘×—× ×™× ×©×œ×™ + ×¡×™×›×•××™× ××™×•×‘××™×
        const testerSummaries = {};

        // ×¡×¤×•×¨ ×œ×¤×™ ×‘×•×—×Ÿ ×•××•×›×œ×•×¡×™×” - ×‘×•× ×” ××ª ×”×¡×™×›×•× ×× ×‘×—× ×™× ×©×œ×™
        allExaminees.forEach(ex => {
            // ×¨×§ × ×‘×—× ×™× ×¢× ×ª×•×¦××”
            if (!ex.result) return;

            const testerName = (ex.tester || tester || '').trim();
            if (!testerName) return;

            if (!testerSummaries[testerName]) {
                testerSummaries[testerName] = {
                    name: testerName,
                    passKadatz: 0, passVoucher: 0, passArmy: 0, passOther: 0,
                    failKadatz: 0, failVoucher: 0, failArmy: 0, failOther: 0
                };
            }
            const sum = testerSummaries[testerName];
            const pop = ex.population || 'other';
            const popKey = pop === 'kadatz' ? 'Kadatz' : pop === 'voucher' ? 'Voucher' : pop === 'army' ? 'Army' : 'Other';

            if (ex.result === 'pass') {
                sum['pass' + popKey]++;
            } else if (ex.result === 'fail') {
                sum['fail' + popKey]++;
            }
        });

        // ×”×•×¡×£ ×¡×™×›×•××™× ××‘×•×—× ×™× ××™×•×‘××™×
        importedTesters.forEach(imported => {
            if (imported.summary) {
                testerSummaries[imported.tester] = {
                    name: imported.tester,
                    passKadatz: imported.summary.passKadatz || 0,
                    passVoucher: imported.summary.passVoucher || 0,
                    passArmy: imported.summary.passArmy || 0,
                    passOther: imported.summary.passOther || 0,
                    failKadatz: imported.summary.failKadatz || 0,
                    failVoucher: imported.summary.failVoucher || 0,
                    failArmy: imported.summary.failArmy || 0,
                    failOther: imported.summary.failOther || 0
                };
            }
        });

        // ×‘× ×™×™×ª ×˜×‘×œ×ª ×¡×™×›×•× - ×©×•×¨×” ×œ×›×œ ×‘×•×—×Ÿ
        const summaryTbody = document.getElementById('reportSummaryBody');
        const summaryTfoot = document.getElementById('reportSummaryFoot');
        summaryTbody.innerHTML = '';
        summaryTfoot.innerHTML = '';

        // ×›×œ ×”×¡×™×›×•××™×
        const allSummaries = Object.values(testerSummaries);

        // ×¡×™×›×•××™× ×›×•×œ×œ×™× ×œ×˜×‘×œ×ª ×‘×•×—× ×™×
        let testerTotalPassKadatz = 0, testerTotalPassVoucher = 0, testerTotalPassArmy = 0, testerTotalPassOther = 0;
        let testerTotalFailKadatz = 0, testerTotalFailVoucher = 0, testerTotalFailArmy = 0, testerTotalFailOther = 0;

        // ×”×•×¡×£ ×©×•×¨×” ×œ×›×œ ×‘×•×—×Ÿ ×©×™×© ×œ×• ××‘×—× ×™×
        allSummaries.forEach(sum => {
            const rowTotal = sum.passKadatz + sum.passVoucher + sum.passArmy + sum.passOther +
                sum.failKadatz + sum.failVoucher + sum.failArmy + sum.failOther;
            // ×“×œ×’ ×¢×œ ×‘×•×—× ×™× ×œ×œ× ××‘×—× ×™×
            if (!sum.name || rowTotal === 0) return;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight: bold;">${sum.name || '-'}</td>
                <td>${sum.passKadatz || 0}</td>
                <td>${sum.passVoucher || 0}</td>
                <td>${sum.passArmy || 0}</td>
                <td>${sum.passOther || 0}</td>
                <td>${sum.failKadatz || 0}</td>
                <td>${sum.failVoucher || 0}</td>
                <td>${sum.failArmy || 0}</td>
                <td>${sum.failOther || 0}</td>
                <td style="font-weight: bold;">${rowTotal}</td>
            `;
            summaryTbody.appendChild(tr);

            // ×¦×‘×•×¨ ×œ×¡×™×›×•× ×›×•×œ×œ
            testerTotalPassKadatz += sum.passKadatz || 0;
            testerTotalPassVoucher += sum.passVoucher || 0;
            testerTotalPassArmy += sum.passArmy || 0;
            testerTotalPassOther += sum.passOther || 0;
            testerTotalFailKadatz += sum.failKadatz || 0;
            testerTotalFailVoucher += sum.failVoucher || 0;
            testerTotalFailArmy += sum.failArmy || 0;
            testerTotalFailOther += sum.failOther || 0;
        });

        // ×©×•×¨×ª ×¡×™×›×•× ×›×•×œ×œ (×¨×§ ×× ×™×© ×™×•×ª×¨ ××‘×•×—×Ÿ ××—×“)
        if (allSummaries.length > 1) {
            const testerGrandTotal = testerTotalPassKadatz + testerTotalPassVoucher + testerTotalPassArmy + testerTotalPassOther +
                testerTotalFailKadatz + testerTotalFailVoucher + testerTotalFailArmy + testerTotalFailOther;

            const testerFootTr = document.createElement('tr');
            testerFootTr.innerHTML = `
                <td style="font-weight: bold;">×¡×”"×› ×›×•×œ×œ</td>
                <td>${testerTotalPassKadatz}</td>
                <td>${testerTotalPassVoucher}</td>
                <td>${testerTotalPassArmy}</td>
                <td>${testerTotalPassOther}</td>
                <td>${testerTotalFailKadatz}</td>
                <td>${testerTotalFailVoucher}</td>
                <td>${testerTotalFailArmy}</td>
                <td>${testerTotalFailOther}</td>
                <td style="font-weight: bold; font-size: 16px;">${testerGrandTotal}</td>
            `;
            summaryTfoot.appendChild(testerFootTr);
        }

        // ×¤×¨×˜×™ ×‘×•×—×Ÿ - ×©×™××•×© ×‘×¤×•× ×§×¦×™×” ×”××©×•×ª×¤×ª
        document.getElementById('reportTesterDetails').innerHTML = getTesterDetails(tester);

        // ××ª×—×œ ×—×ª×™××” ×¢×œ ×”×“×•"×—
        initReportSignature();

        // × ×¡×” ×œ×˜×¢×•×Ÿ ×—×ª×™××ª ×“×•"×— ×©××•×¨×”
        const savedReportSig = localStorage.getItem('report_signature');
        if (savedReportSig) {
            const reportSigCanvas = document.getElementById('reportSigCanvas');
            const reportSigCtx = reportSigCanvas.getContext('2d');
            const img = new Image();
            img.onload = () => reportSigCtx.drawImage(img, 0, 0);
            img.src = savedReportSig;
        }
    }

    // ×—×ª×™××” ×“×™×’×™×˜×œ×™×ª ×¢×œ ×”×“×•"×—
    let reportSigCanvas, reportSigCtx, reportSigDrawing = false;

    function initReportSignature() {
        reportSigCanvas = document.getElementById('reportSigCanvas');
        if (!reportSigCanvas) return;
        reportSigCtx = reportSigCanvas.getContext('2d');

        function getPos(e) {
            const rect = reportSigCanvas.getBoundingClientRect();
            const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
            const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
            return {x, y};
        }

        reportSigCanvas.addEventListener('mousedown', (e) => {
            reportSigDrawing = true;
            reportSigCtx.beginPath();
            reportSigCtx.moveTo(getPos(e).x, getPos(e).y);
        });
        reportSigCanvas.addEventListener('mousemove', (e) => {
            if (!reportSigDrawing) return;
            reportSigCtx.lineTo(getPos(e).x, getPos(e).y);
            reportSigCtx.stroke();
        });
        reportSigCanvas.addEventListener('mouseup', () => {
            reportSigDrawing = false;
            saveReportSignature();
        });
        reportSigCanvas.addEventListener('mouseleave', () => reportSigDrawing = false);

        reportSigCanvas.addEventListener('touchstart', (e) => {
            reportSigDrawing = true;
            reportSigCtx.beginPath();
            reportSigCtx.moveTo(getPos(e).x, getPos(e).y);
            e.preventDefault();
        });
        reportSigCanvas.addEventListener('touchmove', (e) => {
            if (!reportSigDrawing) return;
            reportSigCtx.lineTo(getPos(e).x, getPos(e).y);
            reportSigCtx.stroke();
            e.preventDefault();
        });
        reportSigCanvas.addEventListener('touchend', () => {
            reportSigDrawing = false;
            saveReportSignature();
        });
    }

    function saveReportSignature() {
        if (reportSigCanvas) {
            localStorage.setItem('report_signature', reportSigCanvas.toDataURL());
            // ×¢×“×›×Ÿ ×’× ××ª ×”-outer report
            updateOuterReportSignature();
        }
    }

    function updateOuterReportSignature() {
        const outerCanvas = document.querySelector('#printableReportOuter canvas');
        if (outerCanvas && reportSigCanvas) {
            const outerCtx = outerCanvas.getContext('2d');
            outerCtx.clearRect(0, 0, outerCanvas.width, outerCanvas.height);
            outerCtx.drawImage(reportSigCanvas, 0, 0);
        }
    }

    // ×¢×“×›×•×Ÿ outer report ×œ×¤× ×™ ×”×“×¤×¡×” (×”×¢×¨×•×ª ×•×—×ª×™××”)
    function updateOuterReportBeforePrint() {
        const outerReport = document.getElementById('printableReportOuter');
        const notesInput = document.getElementById('reportNotesInput');

        // ×¢×“×›×Ÿ ×”×¢×¨×•×ª
        if (outerReport && notesInput) {
            const outerNotesDisplay = outerReport.querySelector('#reportNotes');
            if (outerNotesDisplay) {
                outerNotesDisplay.textContent = notesInput.value;
            }
        }

        // ×¢×“×›×Ÿ ×—×ª×™××”
        updateOuterReportSignature();
    }

    function clearReportSignature() {
        if (reportSigCanvas && reportSigCtx) {
            reportSigCtx.clearRect(0, 0, reportSigCanvas.width, reportSigCanvas.height);
            localStorage.removeItem('report_signature');
            updateOuterReportSignature();
        }
    }

    // ×¢×“×›×•×Ÿ ×”×¢×¨×•×ª ×‘×“×•×—
    function updateReportNotes() {
        const notesInput = document.getElementById('reportNotesInput');
        const notesDisplay = document.getElementById('reportNotes');
        const outerReport = document.getElementById('printableReportOuter');

        if (notesInput && notesDisplay) {
            notesDisplay.textContent = notesInput.value;
        }

        // ×¢×“×›×Ÿ ×’× ×‘-outer report ×œ×”×“×¤×¡×”
        if (outerReport) {
            const outerNotesDisplay = outerReport.querySelector('#reportNotes');
            if (outerNotesDisplay) {
                outerNotesDisplay.textContent = notesInput.value;
            }
        }
    }

    // ============ RESET ============
    function resetAll() {
        if (confirm('×”×× ××ª×” ×‘×˜×•×—? ×›×œ ×”× ×ª×•× ×™× ×™×™××—×§×•!')) {
            localStorage.removeItem('simple_mode_data');
            localStorage.removeItem('simple_mode_signature');
            location.reload();
        }
    }

    // ============ AUTO-SAVE on input ============
    document.addEventListener('input', (e) => {
        if (e.target.closest('#section-planning')) {
            saveData();
        }
    });

    // ============ ×—×œ×•×§×ª ×¢×‘×•×“×” ============
    const MAX_PER_TESTER = 10; // ××§×¡×™××•× 10 × ×‘×—× ×™× ×œ×‘×•×—×Ÿ
    let currentAssignments = []; // ×œ×©××™×¨×ª ×”×—×œ×•×§×” ×”× ×•×›×—×™×ª ×œ×¢×¨×™×›×” ×™×“× ×™×ª

    function openDistributeModal() {
        // ×˜×¢×Ÿ ×‘×•×—× ×™× - ×”×‘×•×—×Ÿ ×”×¨××©×™ + ×‘×•×—× ×™× × ×•×¡×¤×™×
        const mainTester = document.getElementById('planTester').value.trim();
        const additionalTesters = document.getElementById('additionalTestersNames').value;

        let testers = [];
        if(mainTester) testers.push(mainTester);
        if(additionalTesters) {
            additionalTesters.split(',').forEach(t => {
                const name = t.trim();
                if(name && !testers.includes(name)) testers.push(name);
            });
        }

        if(testers.length < 2) {
            alert('×™×© ×œ×”×–×™×Ÿ ×œ×¤×—×•×ª 2 ×‘×•×—× ×™× (×©× ×”×‘×•×—×Ÿ + ×‘×•×—× ×™× × ×•×¡×¤×™×)');
            return;
        }

        // ×”×¦×’ ×¨×©×™××ª ×‘×•×—× ×™× ×¢× checkboxes
        const testersList = document.getElementById('testersList');
        testersList.innerHTML = testers.map((t, i) => `
            <div class="distribute-checkbox">
                <input type="checkbox" id="tester_${i}" value="${t}" checked>
                <label for="tester_${i}">${t} ${i === 0 ? '(××—×¨××™)' : ''}</label>
            </div>
        `).join('');

        // ×˜×¢×Ÿ ×‘×ª×™ ×¡×¤×¨ ×•×›××•×™×•×ª ××˜×‘×œ×ª ×”×ª×›× ×•×Ÿ
        loadSchoolsFromPlanSimple();

        document.getElementById('distributeModal').classList.add('active');
    }

    function closeDistributeModal() {
        document.getElementById('distributeModal').classList.remove('active');
    }

    // ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ××©×§×œ ××‘×—×Ÿ ×œ×¤×™ ×“×¨×’×”
    function getTestWeight(vehicleType) {
        if(vehicleType === 'D') return 2; // D × ×—×©×‘ ×›-2 ××‘×—× ×™×
        if(['A', 'A1', 'A2'].includes(vehicleType)) return 1/3; // ××•×¤× ×•×¢ × ×—×©×‘ ×›-1/3 ××‘×—×Ÿ
        return 1; // ×¨×’×™×œ
    }

    function loadSchoolsFromPlanSimple() {
        const schoolsList = document.getElementById('schoolsList');
        const rows = document.querySelectorAll('#planTableBody tr');
        let schools = [];
        let total = 0;
        let weightedTotal = 0;

        rows.forEach((row, idx) => {
            const cells = row.querySelectorAll('td');
            if(cells.length >= 7) {
                const schoolSelect = cells[0].querySelector('select');
                const vehicleSelect = cells[1].querySelector('select');
                const actualInput = cells[5].querySelector('input'); // ×›××•×ª ×‘×¤×•×¢×œ
                const timeInput = cells[6].querySelector('input'); // ×©×¢×”

                const schoolName = schoolSelect?.value || '';
                const vehicleType = vehicleSelect?.value || '';
                const actual = parseInt(actualInput?.value) || 0;
                const time = timeInput?.value || '99:99';

                if(schoolName && actual > 0) {
                    const weight = getTestWeight(vehicleType);
                    const weightedCount = actual * weight;
                    schools.push({
                        name: schoolName,
                        count: actual,
                        type: vehicleType,
                        idx: idx,
                        time: time,
                        weight: weight,
                        weightedCount: weightedCount
                    });
                    total += actual;
                    weightedTotal += weightedCount;
                }
            }
        });

        if(schools.length === 0) {
            schoolsList.innerHTML = '<p style="color:#d32f2f;">××™×Ÿ ×‘×ª×™ ×¡×¤×¨ ×¢× ×›××•×™×•×ª ×‘×˜×‘×œ×ª ×”×ª×›× ×•×Ÿ</p>';
            document.getElementById('totalExaminees').textContent = '0';
            return;
        }

        schoolsList.innerHTML = schools.map((s, i) => {
            let weightInfo = '';
            if(s.type === 'D') weightInfo = ' (Ã—2)';
            else if(['A', 'A1', 'A2'].includes(s.type)) weightInfo = ' (Ã—â…“)';

            return `<div style="display:flex; justify-content:space-between; padding:5px; background:white; margin:3px 0; border-radius:3px; ${s.count > MAX_PER_TESTER ? 'border: 2px solid orange;' : ''}">
                <span>${s.name} ${s.type ? `(${s.type})` : ''}${weightInfo} ${s.time !== '99:99' ? `â°${s.time}` : ''} ${s.count > MAX_PER_TESTER ? 'âš ï¸' : ''}</span>
                <span style="font-weight:bold;">${s.count} × ×‘×—× ×™×</span>
            </div>`;
        }).join('');

        if(schools.some(s => s.count > MAX_PER_TESTER)) {
            schoolsList.innerHTML += `<p style="color:orange; font-size:12px; margin-top:5px;">âš ï¸ ×™×© ×‘×ª×™ ×¡×¤×¨ ×¢× ×™×•×ª×¨ ×-10 × ×‘×—× ×™× - ×™×¤×•×¦×œ×• ×‘×™×Ÿ ×‘×•×—× ×™×</p>`;
        }

        document.getElementById('totalExaminees').textContent = total + ` (××©×•×§×œ×œ: ${weightedTotal.toFixed(1)})`;

        // ×©××•×¨ ××ª ×”× ×ª×•× ×™× ×œ×©×™××•×© ×‘×—×™×©×•×‘
        window.schoolsData = schools;
    }

    function calculateDistribution() {
        // ×§×‘×œ ×‘×•×—× ×™× ×©× ×‘×—×¨×•
        const selectedTesters = [];
        document.querySelectorAll('#testersList input[type="checkbox"]:checked').forEach(cb => {
            selectedTesters.push(cb.value);
        });

        if(selectedTesters.length < 2) {
            alert('×™×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª 2 ×‘×•×—× ×™×');
            return;
        }

        const schools = window.schoolsData || [];
        if(schools.length === 0) {
            alert('××™×Ÿ ×‘×ª×™ ×¡×¤×¨ ×œ×—×œ×•×§×”');
            return;
        }

        const leadTesterLess = document.getElementById('leadTesterLess').checked;

        // ×—×™×©×•×‘ ×¡×”"×› × ×‘×—× ×™× ×•××©×§×œ ××©×•×§×œ×œ
        const totalExaminees = schools.reduce((sum, s) => sum + s.count, 0);
        const totalWeighted = schools.reduce((sum, s) => sum + (s.weightedCount || s.count), 0);
        const numTesters = selectedTesters.length;
        const maxCapacity = numTesters * MAX_PER_TESTER;

        // ×‘×“×™×§×” ×× ×™×© ××¡×¤×™×§ ×‘×•×—× ×™×
        if(totalExaminees > maxCapacity) {
            alert(`âš ï¸ ×™×© ${totalExaminees} × ×‘×—× ×™× ××‘×œ ${numTesters} ×‘×•×—× ×™× ×™×›×•×œ×™× ×œ×‘×—×•×Ÿ ××§×¡×™××•× ${maxCapacity} (10 ×œ×›×œ ×‘×•×—×Ÿ).\n×™×© ×œ×”×•×¡×™×£ ×¢×•×“ ×‘×•×—× ×™× ××• ×œ×”×¤×—×™×ª × ×‘×—× ×™×.`);
            return;
        }

        // ×—×™×©×•×‘ ×™×¢×“ ××©×•×§×œ×œ ×œ×›×œ ×‘×•×—×Ÿ
        const numRegularTesters = numTesters - 1;
        const baseWeightedPerTester = totalWeighted / numTesters;

        let leadWeightedTarget;
        if(leadTesterLess && numTesters > 1) {
            leadWeightedTarget = Math.max(0, baseWeightedPerTester - 1);
        } else {
            leadWeightedTarget = baseWeightedPerTester;
        }

        // ×™×¦×™×¨×ª ××‘× ×” ×”×§×¦××”
        const assignments = selectedTesters.map((name, idx) => {
            return {
                name: name,
                isLead: idx === 0,
                items: [],
                total: 0,
                weightedTotal: 0,
                targetWeighted: idx === 0 ? leadWeightedTarget : (totalWeighted - leadWeightedTarget) / numRegularTesters
            };
        });

        // ××™×™×Ÿ ×‘×ª×™ ×¡×¤×¨ ×œ×¤×™ ×©×¢×” (××•×§×“× ×§×•×“×) ×•××– ×œ×¤×™ ××©×§×œ (×’×“×•×œ ×§×•×“×)
        let workItems = [...schools].sort((a, b) => {
            if(a.time !== b.time) return (a.time || '99:99').localeCompare(b.time || '99:99');
            return (b.weightedCount || b.count) - (a.weightedCount || a.count);
        });

        // ××œ×’×•×¨×™×ª× ×—×œ×•×§×” ××©×•×¤×¨ ×¢× ××©×§×œ×™× ×•×©×¢×•×ª
        workItems.forEach(item => {
            let remaining = item.count;
            const weight = item.weight || 1;

            while(remaining > 0) {
                let bestIdx = -1;
                let bestScore = -Infinity;

                assignments.forEach((a, idx) => {
                    const room = MAX_PER_TESTER - a.total;
                    if(room <= 0) return;

                    const remainingToTarget = a.targetWeighted - a.weightedTotal;
                    if(remainingToTarget > bestScore) {
                        bestScore = remainingToTarget;
                        bestIdx = idx;
                    }
                });

                if(bestIdx === -1) {
                    let minTotal = Infinity;
                    assignments.forEach((a, idx) => {
                        if(a.total < minTotal) {
                            minTotal = a.total;
                            bestIdx = idx;
                        }
                    });
                }

                if(bestIdx === -1) {
                    console.error(`××™×Ÿ ××§×•× ×œ×©××¨ ×”× ×‘×—× ×™× ×-${item.name}`);
                    break;
                }

                const room = MAX_PER_TESTER - assignments[bestIdx].total;
                const toAssign = Math.min(remaining, Math.max(1, room));

                const existingItem = assignments[bestIdx].items.find(i =>
                    i.name === item.name && i.type === item.type
                );

                if(existingItem) {
                    existingItem.count += toAssign;
                    existingItem.weightedCount = (existingItem.weightedCount || 0) + toAssign * weight;
                } else {
                    assignments[bestIdx].items.push({
                        name: item.name,
                        count: toAssign,
                        type: item.type,
                        time: item.time,
                        weight: weight,
                        weightedCount: toAssign * weight,
                        original: item.original || item.name
                    });
                }

                assignments[bestIdx].total += toAssign;
                assignments[bestIdx].weightedTotal += toAssign * weight;
                remaining -= toAssign;
            }
        });

        // ××™×™×Ÿ ×¤×¨×™×˜×™× ×‘×›×œ ×‘×•×—×Ÿ ×œ×¤×™ ×©×¢×”
        assignments.forEach(a => {
            a.items.sort((x, y) => (x.time || '99:99').localeCompare(y.time || '99:99'));
        });

        // ×‘×“×™×§×ª ×©×œ××•×ª
        const totalAssigned = assignments.reduce((sum, a) => sum + a.total, 0);
        if(totalAssigned !== totalExaminees) {
            console.error(`×©×’×™××”: ×”×•×§×¦×• ${totalAssigned} ××ª×•×š ${totalExaminees} × ×‘×—× ×™×!`);
        }

        currentAssignments = assignments;
        displayDistribution(assignments);
    }

    // ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ××©×š ××‘×—×Ÿ ×‘×“×§×•×ª ×œ×¤×™ ×¡×•×’ ×¨×›×‘
    function getTestDuration(vehicleType) {
        if(vehicleType === 'D') return 40; // D = 2 ××‘×—× ×™× ×¨×’×™×œ×™× = 40 ×“×§×•×ª
        if(['A', 'A1', 'A2'].includes(vehicleType)) return 7; // A = â…“ ××‘×—×Ÿ = ~7 ×“×§×•×ª
        return 20; // ××‘×—×Ÿ ×¨×’×™×œ = 20 ×“×§×•×ª
    }

    // ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×“×§×•×ª ×œ×©×¢×” (×¤×•×¨××˜ HH:MM)
    function addMinutesToTime(timeStr, minutes) {
        if(!timeStr || timeStr === '99:99') return null;
        const [hours, mins] = timeStr.split(':').map(Number);
        const totalMins = hours * 60 + mins + minutes;
        const newHours = Math.floor(totalMins / 60) % 24;
        const newMins = totalMins % 60;
        return `${String(newHours).padStart(2, '0')}:${String(newMins).padStart(2, '0')}`;
    }

    // ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ×œ×•×— ×–×× ×™× ×œ×‘×•×—×Ÿ
    function calculateTesterSchedule(items) {
        const schedule = [];
        let currentTime = null;

        // ××™×™×Ÿ ×œ×¤×™ ×©×¢×”
        const sortedItems = [...items].sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));

        sortedItems.forEach(item => {
            const startTime = item.time && item.time !== '99:99' ? item.time : currentTime;
            const duration = getTestDuration(item.type) * item.count;
            const endTime = startTime ? addMinutesToTime(startTime, duration) : null;

            schedule.push({
                ...item,
                startTime: startTime,
                endTime: endTime,
                duration: duration
            });

            // ×¢×“×›×Ÿ ×–××Ÿ × ×•×›×—×™ ×œ×¡×™×•× ×‘×™×ª ×”×¡×¤×¨ ×”×–×”
            if(endTime) {
                currentTime = endTime;
            }
        });

        return schedule;
    }

    function displayDistribution(assignments) {
        const output = document.getElementById('distributionOutput');
        const date = document.getElementById('planDate').value || '';
        const areaSelect = document.getElementById('planArea');
        const area = areaSelect.options[areaSelect.selectedIndex]?.text || '';

        let html = '';

        const hasOverflow = assignments.some(a => a.total > MAX_PER_TESTER);
        if(hasOverflow) {
            html += `<div style="background:#ffebee; border:2px solid #f44336; padding:10px; border-radius:5px; margin-bottom:15px;">
                <strong style="color:#c62828;">âš ï¸ ×©×’×™××”: ×™×© ×‘×•×—× ×™× ×¢× ×™×•×ª×¨ ×-10 × ×‘×—× ×™×!</strong>
            </div>`;
        }

        assignments.forEach((a, testerIdx) => {
            const isOverLimit = a.total > MAX_PER_TESTER;
            const weightedTotal = a.weightedTotal?.toFixed(1) || a.total;

            // ×—×©×‘ ×œ×•×— ×–×× ×™× ×œ×‘×•×—×Ÿ
            const schedule = calculateTesterSchedule(a.items);

            // ×—×©×‘ ×–××Ÿ ×¡×™×•× ×›×•×œ×œ
            const lastItem = schedule[schedule.length - 1];
            const totalEndTime = lastItem?.endTime || '';
            const firstStartTime = schedule[0]?.startTime || '';

            const itemsList = schedule.map((item, itemIdx) => {
                const partInfo = item.part ? ` (×—×œ×§ ${item.part}/${item.totalParts})` : '';
                let weightInfo = '';
                if(item.type === 'D') weightInfo = '<span style="color:#d32f2f;font-size:10px;">(Ã—2)</span>';
                else if(['A', 'A1', 'A2'].includes(item.type)) weightInfo = '<span style="color:#4caf50;font-size:10px;">(Ã—â…“)</span>';

                // ×”×¦×’ ×˜×•×•×— ×–×× ×™×
                let timeDisplay = '';
                if(item.startTime && item.endTime) {
                    timeDisplay = `<span style="color:#1565c0; font-weight:bold;">â°${item.startTime}-${item.endTime}</span>`;
                } else if(item.startTime) {
                    timeDisplay = `<span style="color:#1565c0;">â°${item.startTime}</span>`;
                }

                return `<li style="display:flex; justify-content:space-between; align-items:center; padding:5px 0; border-bottom:1px solid #eee;">
                    <span>${timeDisplay} ${item.name}${partInfo}: <strong>${item.count}</strong> ${item.type ? `(${item.type})` : ''} ${weightInfo} <span style="color:#888;font-size:10px;">[${item.duration} ×“×§']</span></span>
                    <div style="display:flex; gap:3px; align-items:center;">
                        <select onchange="movePartial(${testerIdx}, ${itemIdx}, this.value, 1)" style="padding:2px; font-size:11px;">
                            <option value="">+1â†’</option>
                            ${assignments.map((other, otherIdx) =>
                                otherIdx !== testerIdx ? `<option value="${otherIdx}">${other.name}</option>` : ''
                            ).join('')}
                        </select>
                        <select onchange="moveItem(${testerIdx}, ${itemIdx}, this.value)" style="padding:2px; font-size:11px;">
                            <option value="">×”×›×œâ†’</option>
                            ${assignments.map((other, otherIdx) =>
                                otherIdx !== testerIdx ? `<option value="${otherIdx}">${other.name}</option>` : ''
                            ).join('')}
                        </select>
                    </div>
                </li>`;
            }).join('');

            // ×—×©×‘ ×¡×”"×› ×–××Ÿ ×¢×‘×•×“×”
            const totalDuration = schedule.reduce((sum, item) => sum + item.duration, 0);
            const totalHours = Math.floor(totalDuration / 60);
            const totalMins = totalDuration % 60;
            const durationStr = totalHours > 0 ? `${totalHours} ×©×¢×•×ª ×•-${totalMins} ×“×§×•×ª` : `${totalMins} ×“×§×•×ª`;

            // ×”×›×Ÿ ×”×•×“×¢×ª ×•×•××˜×¡××¤ ×¢× ×œ×•×— ×–×× ×™×
            let whatsappMsg = `*×—×œ×•×§×ª ×¢×‘×•×“×” - ${date} - ${area}*\n\n`;
            whatsappMsg += `ğŸ‘¤ *${a.name}${a.isLead ? ' (××—×¨××™)' : ''}*\n`;
            whatsappMsg += `×¡×”"×›: ${a.total} × ×‘×—× ×™× (~${durationStr})\n`;
            if(firstStartTime && totalEndTime) {
                whatsappMsg += `ğŸ• ${firstStartTime} - ${totalEndTime}\n`;
            }
            whatsappMsg += `\n×‘×ª×™ ×¡×¤×¨:\n`;
            schedule.forEach(item => {
                const partInfo = item.part ? ` (×—×œ×§ ${item.part}/${item.totalParts})` : '';
                const timeRange = item.startTime && item.endTime ? `${item.startTime}-${item.endTime}` : (item.startTime || '');
                whatsappMsg += `â€¢ ${timeRange ? `â°${timeRange} ` : ''}${item.name}${partInfo}: ${item.count} ${item.type ? `(${item.type})` : ''}\n`;
            });

            html += `
                <div class="tester-assignment" style="${isOverLimit ? 'border: 2px solid #f44336; background: #ffebee;' : ''}">
                    <h4>
                        ${a.name} ${a.isLead ? 'ğŸ‘‘' : ''}
                        <span class="total" style="${isOverLimit ? 'background:#f44336;' : ''}">${a.total} × ×‘×—× ×™× (××©×•×§×œ×œ: ${weightedTotal}) ${isOverLimit ? 'âš ï¸' : ''}</span>
                    </h4>
                    <div style="background:#e3f2fd; padding:5px 10px; border-radius:3px; margin-bottom:8px; font-size:12px;">
                        ğŸ• ×¡×”"×› ×–××Ÿ ×¢×‘×•×“×”: <strong>${durationStr}</strong>
                        ${firstStartTime && totalEndTime ? ` | ${firstStartTime} ×¢×“ ${totalEndTime}` : ''}
                    </div>
                    <ul style="list-style:none; padding:0; margin:0;">${itemsList}</ul>
                    <button class="btn-send-assignment" onclick="sendAssignment('${encodeURIComponent(whatsappMsg)}')" ${isOverLimit ? 'disabled style="opacity:0.5;"' : ''}>
                        ğŸ“± ×©×œ×— ×‘×•×•××˜×¡××¤
                    </button>
                </div>
            `;
        });

        // ×”×•×¡×£ ×¡×™×›×•×
        const totals = assignments.map(a => a.total);
        const min = Math.min(...totals);
        const max = Math.max(...totals);
        const diff = max - min;

        // ×—×™×©×•×‘ ××©×•×§×œ×œ
        const weightedTotals = assignments.map(a => a.weightedTotal || a.total);
        const weightedMin = Math.min(...weightedTotals);
        const weightedMax = Math.max(...weightedTotals);
        const weightedDiff = (weightedMax - weightedMin).toFixed(1);

        let statusMsg, statusColor;
        if(hasOverflow) {
            statusMsg = 'âŒ ×™×© ×‘×•×—× ×™× ×¢× ×™×•×ª×¨ ×-10 - ×™×© ×œ×ª×§×Ÿ!';
            statusColor = '#ffebee';
        } else if(parseFloat(weightedDiff) <= 1) {
            statusMsg = 'âœ… ×—×œ×•×§×” ×©×•×•×”!';
            statusColor = '#e8f5e9';
        } else if(parseFloat(weightedDiff) <= 2) {
            statusMsg = 'ğŸ‘ ×—×œ×•×§×” ×¡×‘×™×¨×”';
            statusColor = '#fff3e0';
        } else {
            statusMsg = 'âš ï¸ ×™×© ×”×¤×¨×© - ×©×§×•×œ ×”×ª×××” ×™×“× ×™×ª';
            statusColor = '#fff3e0';
        }

        html += `
            <div style="margin-top:15px; padding:10px; background:${statusColor}; border-radius:5px;">
                <strong>ğŸ“Š ×¡×™×›×•×:</strong><br>
                ×”×¤×¨×© ××§×¡×™××œ×™ ×‘×™×Ÿ ×‘×•×—× ×™×: ${diff} × ×‘×—× ×™× (××©×•×§×œ×œ: ${weightedDiff})<br>
                ${statusMsg}
            </div>
        `;

        output.innerHTML = html;
        document.getElementById('distributeResult').style.display = 'block';
    }

    function sendAssignment(encodedMsg) {
        const msg = decodeURIComponent(encodedMsg);
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
    }

    // ×”×¢×‘×¨×ª ×¤×¨×™×˜ ××‘×•×—×Ÿ ×œ×‘×•×—×Ÿ ××—×¨
    // ×”×¢×‘×¨×ª ×¤×¨×™×˜ ×©×œ× ××‘×•×—×Ÿ ×œ×‘×•×—×Ÿ ××—×¨
    function moveItem(fromTesterIdx, itemIdx, toTesterIdx) {
        if(toTesterIdx === '' || toTesterIdx === null) return;

        toTesterIdx = parseInt(toTesterIdx);
        const item = currentAssignments[fromTesterIdx].items[itemIdx];
        const count = item.count;

        // ×”×¡×¨ ××”××§×•×¨
        currentAssignments[fromTesterIdx].items.splice(itemIdx, 1);
        currentAssignments[fromTesterIdx].total -= count;

        // ×‘×“×•×§ ×× ×›×‘×¨ ×™×© ×¤×¨×™×˜ ×“×•××” ××¦×œ ×”×™×¢×“
        const existingItem = currentAssignments[toTesterIdx].items.find(i =>
            i.name === item.name && i.type === item.type
        );

        if(existingItem) {
            existingItem.count += count;
        } else {
            currentAssignments[toTesterIdx].items.push(item);
        }
        currentAssignments[toTesterIdx].total += count;

        // ×¨×¢× ×Ÿ ×ª×¦×•×’×”
        displayDistribution(currentAssignments);
    }

    // ×”×¢×‘×¨×ª ×›××•×ª ×—×œ×§×™×ª ××¤×¨×™×˜
    function movePartial(fromTesterIdx, itemIdx, toTesterIdx, amount) {
        if(toTesterIdx === '' || toTesterIdx === null) return;

        toTesterIdx = parseInt(toTesterIdx);
        amount = parseInt(amount);
        const item = currentAssignments[fromTesterIdx].items[itemIdx];

        if(amount >= item.count) {
            // ×× ××¢×‘×™×¨×™× ××ª ×”×›×œ, ×¤×©×•×˜ ×”×©×ª××© ×‘-moveItem
            moveItem(fromTesterIdx, itemIdx, toTesterIdx);
            return;
        }

        // ×”×¤×—×ª ××”××§×•×¨
        item.count -= amount;
        currentAssignments[fromTesterIdx].total -= amount;

        // ×”×•×¡×£ ×œ×™×¢×“ - ×‘×“×•×§ ×× ×›×‘×¨ ×™×© ×¤×¨×™×˜ ×“×•××”
        const existingItem = currentAssignments[toTesterIdx].items.find(i =>
            i.name === item.name && i.type === item.type
        );

        if(existingItem) {
            existingItem.count += amount;
        } else {
            currentAssignments[toTesterIdx].items.push({
                name: item.name,
                count: amount,
                type: item.type,
                original: item.original || item.name
            });
        }
        currentAssignments[toTesterIdx].total += amount;

        // ×¨×¢× ×Ÿ ×ª×¦×•×’×”
        displayDistribution(currentAssignments);
    }

    // ×¡×’×•×¨ modal ×‘×œ×—×™×¦×” ××—×•×¥
    document.getElementById('distributeModal')?.addEventListener('click', function(e) {
        if(e.target === this) closeDistributeModal();
    });
</script>

</body>
</html>
